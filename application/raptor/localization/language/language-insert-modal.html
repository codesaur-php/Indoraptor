<!-- Requesting Overlay - сервер рүү хүсэлт илгээх үед гарч ирнэ -->
<style>
    .requesting {
        z-index: 2000;
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        cursor: wait;
    }
    .requesting-bg {
        width: 100%;
        height: 100%;
        background-color: rgb(0, 0, 0);
        opacity: 0.6;
    }
    .requesting-content {
        position: absolute;
        padding: .7rem .5rem .2rem .5rem;
        top: 40%;
        left: 35%;
        width: 30%;
        text-align: center;
        color: #0d6efd;
        border-radius: 7px;
        border: 2px solid #0d6efd;
        background-color: white;
    }
    .requesting-content img {
        height: 42px;
        margin-bottom: .3rem;
    }
</style>

<div class="requesting">
    <div class="requesting-bg"></div>
    <div class="requesting-content">
        <span class="spinner-border" role="status"></span>
        <h6>Processing request ...</h6>
    </div>
</div>

<!-- Modal - Language Insert Wizard (3 step) -->
<div class="modal-lg modal-dialog">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title fs-6 text-uppercase text-success">
                <i class="bi bi-plus-circle"></i> {{ 'add-record'|text }}
            </h3>
            <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="{{ 'close'|text|e }}"></button>
        </div>

        <div class="modal-body">
            <!-- Wizard Progress Bar -->
            <div class="progress mb-2">
                <div class="progress-bar progress-bar-striped progress-bar-animated"
                     id="collectProgress" role="progressbar"
                     style="width:33%" aria-valuenow="33"></div>
            </div>

            <!-- Wizard Tabs -->
            <ul class="nav nav-tabs" id="langInsertTab">
                <li class="nav-item">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#generalPanel" type="button">
                        {{ 'general-info'|text }}
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#settingsPanel" type="button">
                        {{ 'text-settings'|text }}
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#confirmPanel" type="button">
                        {{ 'confirm'|text }}
                    </button>
                </li>
            </ul>
                    
            <div class="tab-content mt-2">
                <!-- 1-р TAB - General Panel -->
                <div class="tab-pane fade show active" id="generalPanel">
                    <h5>{{ 'enter-language-details'|text }}</h5>

                    <div class="mt-2">
                        <label>{{ 'code'|text }}</label>
                        <input class="form-control lang_code" maxlength="2" autocomplete="off">
                    </div>

                    <div class="mt-2">
                        <label>Locale</label>
                        <input class="form-control lang_locale" maxlength="11" autocomplete="off">
                    </div>

                    <div class="mt-4">
                        <label>{{ 'flag'|text }}</label>
                        <p class="lang_flag"></p>
                    </div>

                    <div class="mt-2">
                        <label>{{ 'name'|text }}</label>
                        <input class="form-control lang_title" maxlength="128" autocomplete="off">
                    </div>

                    <div class="mt-2">
                        <label>{{ 'description'|text }}</label>
                        <input class="form-control lang_description" maxlength="255" autocomplete="off">
                    </div>
                </div>

                <!-- 2-р TAB - Settings Panel -->
                <div class="tab-pane fade" id="settingsPanel">
                    <h5>{{ 'select-text-settings'|text }}</h5>

                    <div class="mt-2">
                        <label>{{ 'copy-text-from'|text }}</label>
                        <select class="form-control available_languages">
                            <option value=""></option>
                            {% for code,language in localization.language %}
                                <option value="{{ code }}">{{ language['title'] }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mt-2">
                        <label>{{ 'code'|text }}</label>
                        <input class="form-control copy_code" readonly maxlength="2">
                    </div>

                    <div class="mt-2">
                        <label>{{ 'flag'|text }}</label>
                        <p class="copy_flag"></p>
                    </div>
                </div>

                <!-- 3-р TAB - Confirm Panel -->
                <div class="tab-pane fade" id="confirmPanel">
                    <h5>{{ 'please-confirm-info'|text }}</h5>

                    <div class="mt-2">
                        <label>{{ 'code'|text }}</label>
                        <input name="code" class="form-control lang_code" readonly maxlength="2">
                    </div>

                    <div class="mt-2">
                        <label>Locale</label>
                        <input name="locale" class="form-control lang_locale" readonly maxlength="11">
                    </div>

                    <div class="mt-2">
                        <label>{{ 'flag'|text }}</label>
                        <p class="lang_flag"></p>
                    </div>

                    <div class="mt-2">
                        <label>{{ 'name'|text }}</label>
                        <input name="title" class="form-control" readonly maxlength="128">
                    </div>

                    <div class="mt-2">
                        <label>{{ 'description'|text }}</label>
                        <input name="description" class="form-control" readonly maxlength="255">
                    </div>

                    <div class="mt-2">
                        <label>{{ 'copy-text-from'|text }}</label>
                        <input name="copy" class="form-control" readonly maxlength="2">
                    </div>
                </div>

            </div>
        </div>

        <!-- Modal Footer -->
        <div class="modal-footer">
            <button class="btn btn-info" id="back" type="button">
                <i class="bi bi-arrow-left"></i> {{ 'back'|text }}
            </button>

            <button class="btn btn-primary" id="continue" type="button">
                {{ 'continue'|text }} <i class="bi bi-arrow-right"></i>
            </button>

            <button class="btn btn-success" id="confirm">
                <i class="bi bi-check"></i> {{ 'confirm'|text }}
            </button>

            <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">
                {{ 'close'|text }}
            </button>
        </div>
    </div>
</div>

<script type="text/javascript">
const progressBar = document.querySelector('#collectProgress');
const headGeneral = document.querySelector('#langInsertTab button[data-bs-target="#generalPanel"]');
const headSettings = document.querySelector('#langInsertTab button[data-bs-target="#settingsPanel"]');
const headConfirm = document.querySelector('#langInsertTab button[data-bs-target="#confirmPanel"]');

const codeInput = document.querySelector('#generalPanel input.lang_code');
const localeInput = document.querySelector('#generalPanel input.lang_locale');
const flagInput = document.querySelector('#generalPanel p.lang_flag');
const nameInput = document.querySelector('#generalPanel input.lang_title');
const descriprionInput = document.querySelector('#generalPanel input.lang_description');

const copySelect = document.querySelector('#settingsPanel select.available_languages');

const btnBack = document.querySelector('.modal-footer #back');
const btnContinue = document.querySelector('.modal-footer #continue');
const btnConfirm = document.querySelector('.modal-footer #confirm');

/* Live update for CODE → FLAG */
codeInput.addEventListener('input', function () {
    const confirmFlag = document.querySelector('#confirmPanel p.lang_flag');
    const confirmCode = document.querySelector('#confirmPanel input[name="code"]');
    if (this.value.length === 2) {
        // en тохиолдолд дэлгэц дээр us flag харуулна
        const flagstr = this.value === 'en' ? 'us' : this.value;
        const img = `<img src="https://flagcdn.com/40x30/${flagstr}.png" 
                          srcset="https://flagcdn.com/80x60/${flagstr}.png 2x"
                          width="40" height="30">`;
        flagInput.innerHTML = img;
        confirmFlag.innerHTML = img;
        confirmCode.value = this.value;
    } else {
        flagInput.innerHTML = '';
        confirmFlag.innerHTML = '';
        confirmCode.value = '';
    }
});

/* Mirror locale → confirm panel */
localeInput.addEventListener('input', function () {
    document.querySelector('#confirmPanel input[name="locale"]').value = this.value;
});

/* Mirror name → confirm panel */
nameInput.addEventListener('input', function () {
    document.querySelector('#confirmPanel input[name="title"]').value = this.value;
});

/* Mirror description → confirm panel */
descriprionInput.addEventListener('input', function () {
    document.querySelector('#confirmPanel input[name="description"]').value = this.value;
});

/* Select mother language → update flag + code */
copySelect.onchange = function () {
    const copyFlag = document.querySelector('#settingsPanel p.copy_flag');
    const copyCode = document.querySelector('#settingsPanel input.copy_code');
    const confirmCopyCode = document.querySelector('#confirmPanel input[name="copy"]');
    if (this.value) {
        const flagstr = this.value === 'en' ? 'us' : this.value;
        copyFlag.innerHTML =
            `<img src="https://flagcdn.com/40x30/${flagstr}.png" 
                  srcset="https://flagcdn.com/80x60/${flagstr}.png 2x"
                  width="40" height="30">`;
        copyCode.value = this.value;
        confirmCopyCode.value = this.value;
    } else {
        copyFlag.innerHTML = '';
        copyCode.value = '';
        confirmCopyCode.value = '';
    }
};

/* Tab navigation */
btnBack.addEventListener('click', function (e) {
    e.preventDefault();

    const id = document.querySelector('.modal-body .tab-content .active').id;

    if (id === 'settingsPanel') headGeneral.click();
    else if (id === 'confirmPanel') headSettings.click();
});

btnContinue.addEventListener('click', function (e) {
    e.preventDefault();

    const id = document.querySelector('.modal-body .tab-content .active').id;

    if (id === 'generalPanel') headSettings.click();
    else if (id === 'settingsPanel') headConfirm.click();
});

/* Tab header button behavior */
headGeneral.addEventListener('click', function () {
    btnBack.style.display = 'none';
    btnContinue.style.display = 'block';
    btnConfirm.style.display = 'none';
    progressBar.style.width = '33%';
});

headSettings.addEventListener('click', function () {
    btnBack.style.display = 'block';
    btnContinue.style.display = 'block';
    btnConfirm.style.display = 'none';
    progressBar.style.width = '66%';
});

headConfirm.addEventListener('click', function () {
    btnBack.style.display = 'block';
    btnContinue.style.display = 'none';
    btnConfirm.style.display = 'block';
    progressBar.style.width = '99%';
});

headGeneral.click(); /* Initialize first tab */

/* CONFIRM → AJAX POST */
btnConfirm.addEventListener('click', function (e) {
    e.preventDefault();

    btnConfirm.growNstop();

    /* Show blocking overlay */
    const requesting = document.querySelector('div.requesting');
    if (requesting) requesting.style.display = 'block';

    /* Collect data */
    const formData = new FormData();
    const inputs = document.querySelectorAll('#confirmPanel input');
    inputs.forEach(input => formData.append(input.name, input.value));
    
    fetch(`{{ 'language-insert'|link }}`, {
        method: 'POST',
        body: formData
    })
    .then(res => {
        const contentType = res.headers.get('content-type') || '';
        if (contentType.includes('application/json')) return res.json();

        throw new Error(`HTTP [${res.status}]: ${res.statusText}`);
    })
    .then(response => {
        if (response.status !== 'success') {
            throw new Error(response.message ?? 'Invalid response!');
        }

        /* Success → reload localization page */
        window.location.reload();

        NotifyTop(
            response.type ?? 'success',
            response.title ?? `{{ 'success'|text|e }}`,
            response.message ?? 'Language inserted'
        );
    })
    .catch(error => {
        NotifyTop('danger', `{{ 'error'|text|e }}`, error.message);

        if (requesting) requesting.style.display = 'none';

        btnConfirm.growNstop();
    });
});
</script>

{% set user_can = user.can('system_content_settings') %}

<!-- SETTINGS ХУУДАСНЫ ЕРӨНХИЙ ТОЛГОЙ БҮТЭЦ -->
<div class="d-flex flex-wrap justify-content-between align-items-center text-uppercase rounded p-1 mb-2 shadow">    
    <!-- Хуудасны гарчиг (Settings) -->
    <h3 class="px-2 my-auto fs-6 text-primary">
        <i class="bi bi-gear-fill"></i> {{ 'settings'|text }}
    </h3>

    <!-- Home page руу буцах товч -->
    <div class="ms-auto">
        <a class="btn btn-sm btn-secondary shadow-sm" href="{{ 'home'|link }}">
            <i class="bi bi-house-door-fill"></i> {{ 'home'|text }}
        </a>
    </div>
</div>

<!-- 
    ТАБ МЕНЮ  
    ----------------------------------------------------
    Settings нь 3 үндсэн бүлэгтэй:
        1) Meta  → гарчиг, тайлбар, хаяг, холбоо барих
        2) Logo  → сайтын logo, favicon, apple-touch-icon
        3) Config → JSON тохиргоо
-->
<ul class="nav nav-tabs mt-1" role="tablist">    
    <!-- Meta таб - анхдагч идэвхтэй -->
    <li class="nav-item">
        <a class="nav-link active show" data-bs-toggle="tab" href="#tab-meta">
            {{ 'meta'|text }} <i class="bi bi-card-text"></i>
        </a>
    </li>

    <!-- Logo таб -->
    <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#tab-logo">
            {{ 'logo'|text }} <i class="bi bi-images"></i>
        </a>
    </li>

    <!-- Config таб -->
    <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#tab-config">
            {{ 'config'|text }} <i class="bi bi-gear"></i>
        </a>
    </li>
</ul>

<!-- 
    ТАБ КОНТЕНТ
    ----------------------------------------------------
    Доорх div нь tab-pane-үүдийг агуулсан үндсэн контейнер.
-->
<div class="settings-tabs tab-content mt-2">
    <!-- 
        META TAB
        ----------------------------------------------------
        - Олон хэл дээр title
        - Олон хэл дээр description
        - Олон хэл дээр urgent (яаралтай мэдэгдэл)
        - email, phone
        - contact / address (мөн олон хэл дээр)
        - Copyright
    -->
    <div class="tab-pane active show" id="tab-meta" role="tabpanel">
        <!-- 
            МЭТА МЭДЭЭЛЭЛ ОРУУЛАХ ФОРМ
            ----------------------------------------------------
            - POST request → settings route
            - multipart/form-data → file upload хэрэгтэй байж магадгүй
            - validation → Bootstrap-ийн needs-validation
        -->
        <form class="needs-validation pt-1" novalidate action="{{ 'settings'|link }}" method="POST" enctype="multipart/form-data">
            <!-- 
                TITLE (олон хэл дээр)
                ----------------------------------------------------
                - localization.language = { "mn": {...}, "en": {...}, ... }
                - Тухайн хэл бүрийн title утгыг тусдаа form-control-оор авна.
                - Label дээр тухайн хэлний төрийн далбаа харагдана.
            -->
            {% for code,language in localization.language %}
                <div class="form-floating mt-2">
                    <!-- Нэрийн утга -->
                    <input class="form-control"
                           name="title[{{ code }}]"
                           value="{{ record['localized']['title'][code]|e }}"
                           maxlength="70"
                           id="title_{{ code }}"
                           autocomplete="off">
                    <!-- Хэл тус бүрийн title label + flag -->
                    <label for="title_{{ code }}">
                        {{ 'title'|text }}
                        {% set flag = code == 'en' ? 'us' : code %}
                        <img src="https://flagcdn.com/20x15/{{ flag }}.png"
                             srcset="https://flagcdn.com/40x30/{{ flag }}.png 2x"
                             width="16" height="12"
                             alt="{{ language['title']|e }}">
                    </label>
                </div>
            {% endfor %}
            <hr>

            <!-- 
                DESCRIPTION (олон хэл дээр)
                ----------------------------------------------------
                - Товч тайлбар, SEO description хэл тус бүрээр
            -->
            {% for code,language in localization.language %}
                <div class="form-floating mt-2">
                    <input class="form-control"
                           name="description[{{ code }}]"
                           value="{{ record['localized']['description'][code]|e }}"
                           maxlength="255"
                           id="description_{{ code }}"
                           autocomplete="off">
                    <label for="description_{{ code }}">
                        {{ 'description'|text }}
                        {% set flag = code == 'en' ? 'us' : code %}
                        <img src="https://flagcdn.com/20x15/{{ flag }}.png"
                             srcset="https://flagcdn.com/40x30/{{ flag }}.png 2x"
                             width="16" height="12"
                             alt="{{ language['title']|e }}">
                    </label>
                </div>
            {% endfor %}
            <hr>

            <!-- 
                URGENT (олон хэл дээр)
                ----------------------------------------------------
                - Хуудасны дээд хэсэгт харагддаг анхааруулга / мэдэгдэл
                - Үүнд HTML бичих боломжтой
            -->
            {% for code,language in localization.language %}
                <div class="form-floating mt-2">                    
                    <textarea class="form-control"
                              name="urgent[{{ code }}]"
                              id="urgent_{{ code }}"
                              style="height:200px">{{ record['localized']['urgent'][code]|e }}</textarea>
                    <label for="urgent_{{ code }}">
                        {{ 'urgent'|text }}
                        {% set flag = code == 'en' ? 'us' : code %}
                        <img src="https://flagcdn.com/20x15/{{ flag }}.png"
                             srcset="https://flagcdn.com/40x30/{{ flag }}.png 2x"
                             width="16" height="12"
                             alt="{{ language['title']|e }}">
                    </label>
                </div>
            {% endfor %}
            <hr>

            <!-- 
                EMAIL & PHONE
                ----------------------------------------------------
                - Ерөнхий холбоо барих мэдээлэл
                - Олон хэлнээс хамаарахгүй глобал утга
            -->

            <!-- EMAIL -->
            <div class="form-floating mt-2">
                <input class="form-control"
                       name="email"
                       type="email"
                       value="{{ record['email']|e }}"
                       maxlength="70"
                       id="email"
                       autocomplete="off">
                <label for="email">{{ 'email'|text }}</label>
            </div>

            <!-- PHONE -->
            <div class="form-floating mt-2">
                <input class="form-control"
                       name="phone"
                       value="{{ record['phone']|e }}"
                       maxlength="70"
                       id="phone"
                       autocomplete="off">
                <label for="phone">{{ 'phone'|text }}</label>
            </div>
            <hr>
            
            <!-- 
                CONTACT (олон хэл дээр)
                ----------------------------------------------------
                - Вебсайтын "Холбоо барих" хэсэгт ашиглагдах контент.
                - Хэл тус бүрээр тусдаа хадгалагдана.
                - Үүнд HTML бичих боломжтой (жишээ: <b>Company</b><br>Phone: ... )
            -->
            {% for code,language in localization.language %}
                <div class="form-floating mt-2">

                    <textarea class="form-control"
                              name="contact[{{ code }}]"
                              id="contact_{{ code }}"
                              style="height:200px">{{ record['localized']['contact'][code]|e }}</textarea>

                    <!-- Хэл тус бүрийн гарчиг + далбаа -->
                    <label for="contact_{{ code }}">
                        {{ 'contact'|text }}
                        {% set flag = code == 'en' ? 'us' : code %}
                        <img src="https://flagcdn.com/20x15/{{ flag }}.png"
                             srcset="https://flagcdn.com/40x30/{{ flag }}.png 2x"
                             width="16" height="12"
                             alt="{{ language['title']|e }}">
                    </label>
                </div>
            {% endfor %}            
            <hr>

            <!-- 
                ADDRESS (олон хэл дээр)
                ----------------------------------------------------
                - Байршлын хаяг, шуудангийн хаяг зэрэг дэлгэрэнгүй мэдээлэл.
                - Хэл тус бүрээр localization-д хадгалагдана.
                - Үүнд HTML бичих боломжтой
            -->
            {% for code,language in localization.language %}
                <div class="form-floating mt-2">

                    <textarea class="form-control"
                              name="address[{{ code }}]"
                              id="address_{{ code }}"
                              style="height:120px">{{ record['localized']['address'][code]|e }}</textarea>

                    <!-- Хаягийн label + хэлний далбаа -->
                    <label for="address_{{ code }}">
                        {{ 'address'|text }}
                        {% set flag = code == 'en' ? 'us' : code %}
                        <img src="https://flagcdn.com/20x15/{{ flag }}.png"
                             srcset="https://flagcdn.com/40x30/{{ flag }}.png 2x"
                             width="16" height="12"
                             alt="{{ language['title']|e }}">
                    </label>
                </div>
            {% endfor %}
            <hr>

            <!-- 
                COPYRIGHT (олон хэл дээр)
                ----------------------------------------------------
                - Footer хэсэгт харагдах зохиогчийн эрхийн текст.
                - Жишээ: "© 2025 Company Name. All rights reserved."
                - Вэбсайтын олон хэлт орчинд тохируулах боломжтой.
                - Үүнд HTML бичих боломжтой
            -->
            {% for code,language in localization.language %}
                <div class="form-floating mt-2">

                    <input class="form-control"
                           name="copyright[{{ code }}]"
                           value="{{ record['localized']['copyright'][code]|e }}"
                           maxlength="255"
                           id="copyright_{{ code }}"
                           autocomplete="off">

                    <!-- Label + Хэлний далбаа -->
                    <label for="copyright_{{ code }}">
                        Copyright
                        {% set flag = code == 'en' ? 'us' : code %}
                        <img src="https://flagcdn.com/20x15/{{ flag }}.png"
                             srcset="https://flagcdn.com/40x30/{{ flag }}.png 2x"
                             width="16" height="12"
                             alt="{{ language['title']|e }}">
                    </label>

                </div>
            {% endfor %}

            <!-- 
                SETTINGS ХАДГАЛАХ ТОВЧ
                ----------------------------------------------------
                - Зөвхөн тухайн хэрэглэгч system_content_settings эрхтэй бол харагдана.
                - form.requestSubmit() - JS дотор submit хийх механизмыг ашиглана.
            -->
            {% if user_can %}
                <button class="submit-settings btn btn-primary text-uppercase mt-3 shadow-sm">
                    <i class="bi bi-save pe-1"></i> {{ 'save'|text }}
                </button>
            {% endif %}
        </form>
    </div> <!-- END OF META TAB -->
    
    <!-- 
        LOGO TAB
        ----------------------------------------------------
        Энэ хэсэгт:
            - Олон хэл дээр сайтын LOGO зураг байрлуулах
            - Favico (.ico)
            - Apple Touch Icon (iOS home screen icon)
        бүгдийг upload хийх боломжтой.
    -->
    <div class="tab-pane" id="tab-logo" role="tabpanel">
        <!-- 
            FILE UPLOAD FORM 
            ----------------------------------------------------
            Файлууд upload хийх тул:
            - method="POST"
            - enctype="multipart/form-data" заавал байх ёстой
        -->
        <form class="needs-validation"
              novalidate
              action="{{ 'settings-files'|link }}"
              method="POST"
              enctype="multipart/form-data">
            <div class="row mb-3 mt-2">
                <!-- 
                    ЗҮҮН ТАЛЫН БАГАНА - LOGO (олон хэлээр)
                    ----------------------------------------------------
                    localization.language дээр iterate хийж
                    хэл тус бүрийн logo-г upload хийх боломжтой.
                -->
                <div class="col">
                    {% for code,language in localization.language %}
                        {% if not loop.first %}<hr>{% endif %}
                        
                        <!-- LOGO-н гарчиг + тухайн хэлний төрийн далбаа -->
                        <label class="form-label">
                            {{ 'logo'|text }}
                            {% set flag = code == 'en' ? 'us' : code %}
                            <img src="https://flagcdn.com/20x15/{{ flag }}.png"
                                srcset="https://flagcdn.com/40x30/{{ flag }}.png 2x"
                                width="20" height="15"
                                alt="{{ language['title']|e }}">
                        </label>

                        <!-- 
                            LOGO FILE INPUT ГРУПП
                            ----------------------------------------------------
                            - Зураг сонгоход file input нууцлагдсан
                            - Текст input → зөвхөн файл нэрийг харуулах зориулалттай
                            - Choose → browse file
                            - Remove → upload-ыг цэвэрлэх
                            - Preview → сонгосон зураг харагдах
                        -->
                        <div class="input-group">
                            <!-- Зураг нэрийг харуулах текст input -->
                            <input class="form-control"
                                   type="text"
                                   id="logo_{{ code }}_name"
                                   disabled
                                   value="{{ record['localized']['logo'][code]|e }}"
                                   placeholder="{{ 'select-an-image'|text|e }}">
                            <div class="input-group-append">
                                <div class="btn-group">
                                    <!-- ЖИНХЭНЭ FILE INPUT (нуусан) -->
                                    <input type="file"
                                           name="logo[{{ code }}]"
                                           id="logo_{{ code }}"
                                           accept="image/*"
                                           maxlength="256"
                                           style="display:none;"
                                           onchange="onFileInput(this);">
                                    
                                    <!-- ФАЙЛ СОНГОХ ТОВЧ -->
                                    <button class="btn btn-info" type="button"
                                            onclick="this.previousElementSibling.click();">
                                        {{ 'choose'|text }}
                                    </button>

                                    <!-- ФАЙЛЫГ УСТГАХ / ЦЭВЭРЛЭХ ТОВЧ -->
                                    <button class="btn btn-danger" type="button"
                                            onclick="onFileClear(this);"
                                            style="{% if record['localized']['logo'][code] is empty %}display:none;{% endif %}">
                                        {{ 'remove'|text }}
                                    </button>

                                    <!-- Remove болсон эсэхийг backend-д мэдээлэх -->
                                    <input type="hidden"
                                           name="logo_{{ code }}_removed"
                                           value="0"
                                           type="number">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Logo file size харуулах талбар -->
                        <input class="form-control-plaintext small text-muted mt-1"
                               id="logo_{{ code }}_size"
                               value="{{ record['localized']['logo_size'][code] ?? '' }}"
                               disabled>
                        <!-- 
                            LOGO PREVIEW ЗУРАГ
                            ----------------------------------------------------
                            - Хэрвээ record дээр зураг байгаа бол харагдана
                            - Хоосон бол display:none
                        -->
                        <img class="img-thumbnail img-fluid"
                             id="logo_{{ code }}_preview"
                             src="{{ record['localized']['logo'][code]|e }}"
                             style="max-height:480px;{% if record['localized']['logo'][code] is empty %}display:none;{% endif %}">
                    {% endfor %}
                </div> <!-- end col-left -->

                

                <!-- 
                    БАРУУН ТАЛЫН БАГАНА
                    ----------------------------------------------------
                    • Favico upload
                    • Apple Touch Icon upload
                -->
                <div class="col">
                    <!-- FAVICO -->
                    <label class="form-label">Favico</label>

                    <div class="input-group">
                        <!-- Файлын нэр үзүүлэх input -->
                        <input class="form-control"
                               type="text"
                               id="favico_name"
                               disabled
                               value="{{ record['favico']|e }}"
                               placeholder="Select icon file">
                        
                        <div class="input-group-append">
                            <div class="btn-group">
                                <!-- ЖИНХЭНЭ FILE INPUT -->
                                <input type="file"
                                       name="favico"
                                       id="favico"
                                       accept=".ico"
                                       maxlength="256"
                                       style="display:none;"
                                       onchange="onFileInput(this);">

                                <!-- Choose -->
                                <button class="btn btn-info" type="button"
                                        onclick="this.previousElementSibling.click();">
                                    {{ 'choose'|text }}
                                </button>

                                <!-- Remove -->
                                <button class="btn btn-danger" type="button"
                                        onclick="onFileClear(this);"
                                        style="{% if record['favico'] is empty %}display:none;{% endif %}">
                                    {{ 'remove'|text }}
                                </button>

                                <!-- Remove flag -->
                                <input type="hidden"
                                       name="favico_removed"
                                       value="0"
                                       type="number">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Favico icon файлын хэмжээ -->
                    <input class="form-control-plaintext small text-muted mt-1"
                           id="favico_size"
                           value="{{ record['favico_size'] ?? '' }}"
                           disabled>
                    <!-- Preview of FAVICO -->
                    <img class="img-thumbnail img-fluid"
                         id="favico_preview"
                         src="{{ record['favico']|e }}"
                         style="max-height:256px;{% if record['favico'] is empty %}display:none;{% endif %}">
                    <hr>

                    <!-- APPLE TOUCH ICON -->
                    <label class="form-label">
                        Apple touch image icon (min 180x180 pixels recommended)
                    </label>
                    <div class="input-group">
                        <!-- Файлын нэр -->
                        <input class="form-control"
                               type="text"
                               id="apple_touch_icon_name"
                               disabled
                               value="{{ record['apple_touch_icon']|e }}"
                               placeholder="{{ 'select-an-image'|text|e }}">
                        
                        <div class="input-group-append">
                            <div class="btn-group">
                                <!-- FILE INPUT -->
                                <input type="file"
                                       name="apple_touch_icon"
                                       id="apple_touch_icon"
                                       accept="image/*"
                                       maxlength="256"
                                       style="display:none;"
                                       onchange="onFileInput(this);">

                                <!-- Choose -->
                                <button class="btn btn-info" type="button"
                                        onclick="this.previousElementSibling.click();">
                                    {{ 'choose'|text }}
                                </button>

                                <!-- Remove -->
                                <button class="btn btn-danger" type="button"
                                        onclick="onFileClear(this);"
                                        style="{% if record['apple_touch_icon'] is empty %}display:none;{% endif %}">
                                    {{ 'remove'|text }}
                                </button>

                                <!-- Remove flag -->
                                <input type="hidden"
                                       name="apple_touch_icon_removed"
                                       value="0"
                                       type="number">
                            </div>
                        </div>
                    </div>
                    <!-- Apple touch icon файлын хэмжээ -->
                    <input class="form-control-plaintext small text-muted mt-1"
                           id="apple_touch_icon_size"
                           value="{{ record['apple_touch_icon_size'] ?? '' }}"
                           disabled>
                    
                    <!-- Preview -->
                    <img class="img-thumbnail img-fluid"
                         id="apple_touch_icon_preview"
                         src="{{ record['apple_touch_icon']|e }}"
                         style="max-height:480px;{% if record['apple_touch_icon'] is empty %}display:none;{% endif %}">
                </div> <!-- end col-right -->
            </div> <!-- end row -->

            <!-- SAVE BUTTON (Permission required) -->
            {% if user_can %}
                <button class="submit-settings btn btn-primary text-uppercase mt-3 shadow-sm">
                    <i class="bi bi-save pe-1"></i> {{ 'save'|text }}
                </button>
            {% endif %}
        </form>
    </div> <!-- END LOGO TAB -->
    
    <!-- 
        CONFIG TAB  
        ----------------------------------------------------
        Энэ tab нь JSON хэлбэртэй сайтын нэмэлт тохиргоог оруулах хэсэг.
        Жишээ:
            {
                "google_analytics": "...",
                "maintenance_mode": true,
                "homepage_slider_speed": 4000
            }
        Хэрэглэгч JSON structure алдаагүй оруулах шаардлагатай.
    -->
    <div class="tab-pane" id="tab-config" role="tabpanel">
        <!-- 
            CONFIG FORM
            ----------------------------------------------------
            - action = settings → үндсэн тохиргоо хадгалах endpoint
            - enctype="multipart/form-data" зайлшгүй биш боловч бусад tab-тай unified байлгах зорилготой
        -->
        <form class="needs-validation"
              novalidate
              action="{{ 'settings'|link }}"
              method="POST"
              enctype="multipart/form-data">

            <!-- 
                JSON valid байх ёстой гэдгийг сануулах жижиг тайлбар.
            -->
            <label class="form-label text-muted small">
                <i>must be valid JSON</i>
            </label>

            <!-- 
                Pretty Print товч
                ----------------------------------------------------
                Энэ товч нь JSON текстийг илүү сайхан (beautified) форматад оруулдаг.
                prettyPrint() функц нь доорх JS хэсэгт бичигдсэн.
            -->
            <a class="badge bg-info mb-2"
               href="javascript:;"
               onclick="prettyPrint();">
                pretty print
            </a>

            <!-- 
                JSON EDITOR TEXTAREA
                ----------------------------------------------------
                - 25 мөр өндөртэй
                - config талбарын утгыг энд харуулна
                - JSON structure бүхий текст
            -->
            <textarea class="form-control"
                      name="config"
                      id="config_editor"
                      rows="25"
                      style="height:450px">{{ record['config']|e }}</textarea>

            <!-- Хадгалах товч (зөвхөн эрхтэй хэрэглэгчид) -->
            {% if user_can %}
                <button class="submit-settings btn btn-primary text-uppercase mt-3 shadow-sm">
                    <i class="bi bi-save pe-1"></i> {{ 'save'|text }}
                </button>
            {% endif %}
        </form>
    </div> <!-- END CONFIG TAB -->
</div> <!-- END settings-tabs -->


<!-- 
    LOGGER SECTION (Зөвхөн system_logger эрхтэй үед харагдана)
    ------------------------------------------------------------
    Энэ хэсэг нь Settings-тэй холбоотой системийн log-уудыг харуулдаг.
    Жишээ нь:
        • settings updated
        • logo changed
        • config modified
    гэх мэт.
-->
{% if user.can('system_logger') %}
<div class="mt-5">
    <hr>

    <!-- Logger title -->
    <label class="form-label fw-bolder">
        {{ 'log'|text }} <i class="bi bi-clock-history"></i>
    </label>

    <!-- 
        Ачаалж байгаа үед харагдах loader (spinner)
        ----------------------------------------------------
        - Logs API дуудсан хооронд харагдана
        - Гүйцэтгэл дуусмагц нууж, log list-г харуулна
    -->
    <div class="spinner-grow mt-3" role="status" style="display:none">
        <span class="visually-hidden">Loading logs...</span>
    </div>

    <!-- 
        LOG LIST CONTAINER
        ----------------------------------------------------
        Энэ UL элементэд settings-* холбоотой лог мэдээлэл append хийгдэнэ.
        - max-height: 240px → scrollbar-тай болно
        - logger-protocol class → лог төрөл тус бүр өөр өөр өнгөтэй харагдана
    -->
    <ul class="list-group logger-protocol"
        id="logger-content"
        style="max-height:240px; overflow-y:auto">
    </ul>
</div>
{% endif %}

<script type="text/javascript">
    /* 
        JSON Pretty Print 
        -------------------------
        - config textarea-г олно
        - JSON parse → stringify(4 space indent)
        - Алдааны үед NotifyTop хэрэглэнэ
    */
    const prettyPrint = function () {
        try {
            const configEditor = document.querySelector('textarea#config_editor');
            if (!configEditor) {
                throw new Error('JSON editor not selected!');
            }

            const val = configEditor.value;
            if (val) {
                const obj = JSON.parse(val);
                const pretty = JSON.stringify(obj, null, 4);
                configEditor.value = pretty;
            }
        } catch (e) {
            NotifyTop('danger', `{{ 'error'|text|e }}`, e.message);
        }
    };

    /* 
        Файл upload хийх үед ажилладаг функц
        ------------------------------------------------------
        - Файлын нэрийг input-д харуулна
        - "Choose" → "Change"
        - Remove товчийг харуулна
        - Preview зураг update хийнэ
        - File size талбар шинэчилнэ
    */
    const onFileInput = function (fileInput) {
        /* ID шалгах */
        const id = fileInput.id;
        if (!id) {
            return NotifyTop('warning', `{{ 'error'|text|e }}`, 'Please set file input id!');
        }

        /* Файлын нэрийг текст input-д харуулах */
        const nameInput = document.getElementById(`${id}_name`);
        if (nameInput && fileInput.files.length > 0) {
            nameInput.value = fileInput.files[0].name;
        }

        /* Файлын хэмжээ харуулах */
        const sizeInput = document.getElementById(`${id}_size`);
        if (sizeInput && fileInput.files.length > 0) {
            const kb = Math.round(fileInput.files[0].size / 1024);
            sizeInput.value = `${kb} KB`;
        }

        /* "Choose" → "Change" */
        const browseBtn = fileInput.nextElementSibling;
        if (browseBtn) {
            browseBtn.textContent = `{{ 'change'|text|e }}`;
        }

        /* Remove товчийг харуулах */
        const removeBtn = browseBtn?.nextElementSibling;
        if (removeBtn && removeBtn.style.display === 'none') {
            removeBtn.style.display = 'block';
        }

        /* removed=0 болгох */
        const fileDeletedInput = removeBtn?.nextElementSibling;
        if (fileDeletedInput) {
            fileDeletedInput.value = 0;
        }

        /* Preview update */
        const reader = new FileReader();
        reader.onload = function (e) {
            const previewImg = document.getElementById(`${id}_preview`);
            if (previewImg) {
                previewImg.src = e.target.result;
                if (previewImg.style.display === 'none') {
                    previewImg.style.display = 'block';
                }
            }
        };
        reader.readAsDataURL(fileInput.files[0]);
    };

    /* 
        Файл Remove хийх үед
        ------------------------------------------------------
        - File input = '' болгоно
        - Preview арилгана
        - Name талбар хоосолно
        - Size талбар хоосолно
        - removed hidden input = 1
    */
    const onFileClear = function (removeBtn) {
        const fileInput = removeBtn?.previousElementSibling?.previousElementSibling;
        if (fileInput?.tagName === 'INPUT' && fileInput.type === 'file') {
            /* Preview хоослох */
            const previewImg = document.getElementById(`${fileInput.id}_preview`);
            if (previewImg) {
                previewImg.removeAttribute('src');
                previewImg.style.display = 'none';
            }

            /* Файлын нэр хоослох */
            const nameInput = document.getElementById(`${fileInput.id}_name`);
            if (nameInput) {
                nameInput.value = '';
            }

            /* File size хоослох */
            const sizeInput = document.getElementById(`${fileInput.id}_size`);
            if (sizeInput) {
                sizeInput.value = '';
            }

            /* "Choose" текст рүү буцаах */
            const browseBtn = fileInput.nextElementSibling;
            if (browseBtn) {
                browseBtn.textContent = `{{ 'choose'|text|e }}`;
            }

            /* Remove товчийг нуух */
            removeBtn.style.display = 'none';

            /* File input цэвэрлэх */
            fileInput.value = '';

            /* removed flag = 1 болгох */
            const fileDeletedInput = removeBtn.nextElementSibling;
            if (fileDeletedInput) {
                fileDeletedInput.value = 1;
            }
        }
    };

    /* 
        SAVE BUTTON → requestSubmit()
        ------------------------------------------------------
        - HTML form submit-ийг зөв trigger хийх
    */
    const submitters = document.querySelectorAll('button.submit-settings');
    submitters.forEach(function (button) {
        button.addEventListener('click', function (e) {
            e.preventDefault();

            const form = this.closest('form');
            if (!form) {
                return NotifyTop('danger', `{{ 'error'|text|e }}`, 'Form not found!');
            }
            
            form.requestSubmit();
        });
    });


    /* 
        FORM SUBMIT (AJAX FETCH)
        ------------------------------------------------------
        - Form validation
        - FormData → fetch
        - JSON response шалгах
        - Амжилттай бол reload()
    */
    document.querySelectorAll('.settings-tabs form').forEach(function (form) {
        form.addEventListener('submit', function (event) {
            event.preventDefault();

            const valid = this.checkValidity();
            this.classList.add('was-validated');

            if (!valid) {
                event.stopPropagation();
                return NotifyTop('danger', `{{ 'error'|text|e }}`, `{{ 'u-have-some-form-errors'|text|e }}`);
            }

            submitters.forEach(function (btn) { btn.spinNstop(); });

            const data = new FormData(this);
            fetch(
                this.action,
                {
                    body: data,
                    method: this.getAttribute('method') ?? 'POST'
                }
            ).then(res => {
                const contentType = res.headers.get('content-type') || '';
                if (contentType.includes('application/json')) return res.json();

                throw new Error(`HTTP [${res.status}]: ${res.statusText}`);
            }).then(response => {
                if (response.status !== 'success') {
                    throw new Error(response.message ? response.message : 'Invalid response!');
                }

                NotifyTop(
                    response.type ?? 'success',
                    response.title ?? `{{ 'success'|text|e }}`,
                    response.message ?? 'Settings updated'
                );

                window.location.reload();
            }).catch(error => {
                NotifyTop('danger', `{{ 'error'|text|e }}`, error.message);
            }).finally(() => {
                submitters.forEach(function (btn) { btn.spinNstop(); });
            });
        });
    });

    /* 
        LOGGER SECTION (system_logger) 
        ------------------------------------------------------
        - Logs retrieve → UL-д append хийнэ
        - Modal-д log харуулах
    */
    document.addEventListener('DOMContentLoaded', function () {
        const logger = document.querySelector('ul.logger-protocol');
        if (!logger || logger.tagName !== 'UL') {
            return;
        }

        const logsRetrieveLink = `{{ 'logs-retrieve'|link }}`;
        const logsViewLink = `{{ 'logs-view'|link }}`;

        const logger_id = logger.id ?? '';
        const table = logger_id.substring(logger_id.indexOf('-') + 1);

        if (!table) return;

        logger.style.display = 'none';
        const spinner = logger.previousElementSibling;
        spinner.style.display = 'block';

        fetch(
            `${logsRetrieveLink}?table=${table}`,
            {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    'ORDER BY': 'id Desc',
                    'CONTEXT': { 'action': 'settings-*' },
                    'LIMIT': 10000
                })
            }
        )
        .then(res => res.json())
        .then(response => {
            if (response.error) {
                throw new Error(response.error ?? `{{ 'something-went-wrong'|text|e }}`);
            }

            logger.innerHTML = '';

            const logModalLink = `${logsViewLink}?table=${table}&id=`;
            Object.values(response).forEach(log => {
                const log_li = document.createElement('li');
                log_li.classList.add('list-group-item', 'list-group-item-action');
                /* Log level-ийн өнгө */
                switch (log.level) {
                    case 'notice': log_li.classList.add('list-group-item-light'); break;
                    case 'info': log_li.classList.add('list-group-item-primary'); break;
                    case 'error': log_li.classList.add('list-group-item-danger'); break;
                    case 'warning': log_li.classList.add('list-group-item-warning'); break;
                    case 'alert': log_li.classList.add('list-group-item-info'); break;
                    case 'debug': log_li.classList.add('list-group-item-secondary'); break;
                    default: log_li.classList.add('list-group-item-dark'); break;
                }

                /* Clickable link (modal) */
                const a_link = document.createElement('a');
                a_link.textContent = `${log.created_at} [${log.id}]`;
                a_link.href = `${logModalLink}${log.id}`;
                a_link.setAttribute('data-bs-target', '#static-modal');
                a_link.setAttribute('data-bs-toggle', 'modal');
                a_link.addEventListener('click', function (e) {
                    e.preventDefault();
                    ajaxModal(a_link);
                });
                log_li.appendChild(a_link);
                log_li.appendChild(document.createTextNode(' '));

                /* Message */
                const span_msg = document.createElement('span');
                span_msg.innerHTML = log.message;
                log_li.appendChild(span_msg);

                log_li.appendChild(document.createTextNode(' '));

                /* User + Action */
                const span_user_action = document.createElement('span');
                span_user_action.innerHTML =
                    `<span class="text-muted small"><u>${log.context.action ?? ''} by ${log.context.auth_user?.username ?? ''}</u></span>`;
                span_user_action.classList.add('text-muted', 'small');
                log_li.appendChild(span_user_action);

                logger.appendChild(log_li);
            });
        })
        .catch(error => {
            console.log(error.message);
        })
        .finally(() => {
            logger.style.display = '';
            spinner.style.display = 'none';
        });
    });
</script>

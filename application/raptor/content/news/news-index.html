<!-- SweetAlert2 сан - устгах үед баталгаажуулах цонх гаргахад ашиглана -->
<script defer src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- ========== ТОЛГОЙ ХЭСЭГ ========== -->
<!-- Мэдээний хуудасны гарчиг болон шинэ мэдээ нэмэх товч -->
<div class="d-flex flex-wrap justify-content-between align-items-center text-uppercase rounded p-1 mb-2 shadow">
    <h3 class="px-2 my-auto fs-5 text-info text-uppercase">
        <i class="bi bi-book"></i> {{ 'news'|text }}
    </h3>
    <div class="ms-auto">
        <!-- Хэрэв хэрэглэгч system_content_insert эрхтэй бол шинэ мэдээ нэмэх товч харуулна -->
        {% if user.can('system_content_insert') %}
            <a class="btn btn-outline-success text-uppercase shadow-sm" href="{{ 'news-insert'|link }}">
                <i class="bi-plus-circle-dotted"></i> {{ 'new'|text }}
            </a>
        {% endif %}
    </div>
</div>

<!-- ========== ШҮҮЛТҮҮР ХЭСЭГ ========== -->
<!-- Мэдээг төрөл, ангилал гэх мэт шалгууруудаар шүүх навигаци -->
<nav class="d-flex navbar navbar-expand navbar-dark bg-info mb-2 rounded">
    <div class="container">
        <span class="text-light pe-2 my-auto">{{ 'filter'|text }}</span>
        <ul class="navbar-nav">
            <!-- Шүүлтүүр бүрийг давтаж dropdown үүсгэнэ -->
            {% for name,filter in filters %}
            <li class="nav-item dropdown ps-2 my-auto">
                <!-- Шүүлтүүрийн товч - дарахад сонголтууд гарч ирнэ -->
                <button class="btn btn-dark btn-sm dropdown-toggle content-filters" data-bs-toggle="dropdown" data-name="{{ name }}" aria-expanded="false" type="button">
                    {{ filter.title }}
                </button>
                <!-- Шүүлтүүрийн утгуудын жагсаалт -->
                <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end">
                    {% for val,label in filter.values %}
                        <li><button class="dropdown-item filter-values-{{ name }}" data-id="{{ val }}" type="button">{{ label }}</button></li>
                    {% endfor %}
                </ul>
            </li>
            {% endfor %}
            <!-- Шүүлтүүр хэрэглэх товч -->
            <li class="nav-item ps-2 my-auto">
                <button class="btn btn-secondary btn-sm shadow-sm disabled" id="set_filter" type="button">
                    <i class="bi bi-filter"></i>
                </button>
            </li>
            <!-- Шүүлтүүр цэвэрлэх товч -->
            <li class="nav-item ps-2 my-auto">
                <button class="btn btn-danger btn-sm shadow-sm disabled" id="reset_filter" type="button">
                    <i class="bi bi-x-circle"></i>
                </button>
            </li>
        </ul>
    </div>
</nav>

<!-- ========== МЭДЭЭНИЙ ХҮСНЭГТ ========== -->
<!-- Мэдээний жагсаалтыг харуулах хүснэгт - JavaScript-ээр өгөгдөл дүүргэнэ -->
<table class="table table-sm table-hover table-striped table-bordered" id="news">
    <thead>
        <tr class="text-uppercase">
            <th scope="col"><span class="text-secondary">ID /</span> {{ 'date'|text }}</th>      <!-- Мэдээний ID болон огноо -->
            <th scope="col"><i class="bi bi-translate"></i> </th>                                <!-- Хэлний туг -->
            <th scope="col">{{ 'photo'|text }}</th>                                              <!-- Зураг -->
            <th scope="col">{{ 'title'|text }}</th>                                              <!-- Гарчиг -->
            <th scope="col"><i class="bi bi-paperclip"></i> </th>                                <!-- Хавсралт файлын тоо -->
            <th scope="col">{{ 'type'|text }}</th>                                               <!-- Төрөл ба ангилал -->
            <th scope="col">{{ 'publish'|text }}</th>                                            <!-- Нийтлэгдсэн эсэх -->
            <th scope="col" style="width:10rem">{{ 'action'|text }}</th>                         <!-- Үйлдлийн товчнууд -->
        </tr>
    </thead>
</table>

<!-- ========== JAVASCRIPT ХЭСЭГ ========== -->
<script type="text/javascript">
    /* URL-ээс параметрүүдийг унших */
    const urlParams = new URLSearchParams(window.location.search);

    /* Шүүлтүүрийн товчнуудыг сонгох */
    const setFilter = document.querySelector('button[id="set_filter"]');      /* Шүүлтүүр хэрэглэх товч */
    const resetFilter = document.querySelector('button[id="reset_filter"]');  /* Шүүлтүүр цэвэрлэх товч */
    const filterBtns = document.querySelectorAll('button.content-filters');   /* Бүх шүүлтүүрийн dropdown товчнууд */

    /**
     * Шүүлтүүрийн утга өөрчлөгдөхөд дуудагдах функц
     * - Шүүлтүүрийн товчны загварыг шинэчилнэ
     * - Хэрэглэх/цэвэрлэх товчнуудын төлөвийг тохируулна
     */
    function onFilterChange()
    {
        const filterParams = new URLSearchParams();

        /* Бүх шүүлтүүрийг шалгаж параметр үүсгэнэ */
        filterBtns.forEach(filter => {
            /* Сонгогдсон шүүлтүүрийн товчны загварыг өөрчлөх */
            filter.classList.toggle('btn-outline-light', !!filter.dataset.id);
            if (filter.dataset.id) {
                filterParams.append(filter.dataset.name, filter.dataset.id);
            }
        });

        /* Одоогийн URL параметртэй харьцуулж товчны төлөвийг тохируулах */
        if (filterParams?.toString() !== urlParams?.toString()) {
            /* Өөрчлөлт байвал хэрэглэх товчийг идэвхжүүлнэ */
            setFilter.classList.remove('disabled', 'btn-secondary');
            setFilter.classList.add('btn-primary', 'btn-outline-light');
        } else {
            /* Өөрчлөлт байхгүй бол хэрэглэх товчийг идэвхгүйжүүлнэ */
            setFilter.classList.remove('btn-dark', 'btn-outline-light');
            setFilter.classList.add('disabled', 'btn-secondary');
        }
    }

    /* ========== ШҮҮЛТҮҮРИЙН DROPDOWN СОНГОЛТУУДАД EVENT LISTENER НЭМЭХ ========== */
    filterBtns.forEach(filter => {
        /* Тухайн шүүлтүүрийн бүх утгуудад click event нэмэх */
        document.querySelectorAll(`.filter-values-${filter.dataset.name}`).forEach(btn => {
            btn.addEventListener('click', function (e) {
                e.preventDefault();
                /* Товчны текст болон утгыг шинэчлэх */
                filter.textContent = e.target.textContent;
                filter.dataset.id = e.target.dataset?.id;
                onFilterChange();
            });
        });
    });

    /* ========== ШҮҮЛТҮҮР ХЭРЭГЛЭХ ТОВЧНЫ EVENT ========== */
    setFilter.addEventListener('click', function (btn) {
        btn.preventDefault();

        /* Сонгосон шүүлтүүрүүдийг цуглуулах */
        const params = [];
        filterBtns.forEach(filter => {
            if (filter.dataset.id) {
                params.push(`${filter.dataset.name}=${filter.dataset.id}`);
            }
        });

        /* Хэрэв шүүлтүүр сонгоогүй бол анхааруулга харуулах */
        if (params.length === 0) {
            return NotifyTop('danger', `{{ 'warning'|text|e }}`, 'Та шүүлтүүрээс ядаж нэгийг сонгоорой!');
        }

        /* Шүүлтүүрийн параметрүүдтэй хуудсыг дахин ачаалах */
        window.location.href = window.location.pathname + '?' + params.join('&');
    });

    /* ========== ШҮҮЛТҮҮР ЦЭВЭРЛЭХ ТОВЧНЫ EVENT ========== */
    resetFilter.addEventListener('click', function (a) {
        a.preventDefault();
        /* Параметргүйгээр хуудсыг дахин ачаалах */
        window.location.href = window.location.pathname;
    });

    /* ========== DOM БЭЛЭН БОЛСНЫ ДАРАА АЖИЛЛАХ КОД ========== */
    document.addEventListener('DOMContentLoaded', function () {
        /* URL-д параметр байвал шүүлтүүрийн төлвийг сэргээх */
        if (urlParams?.size > 0) {
            /* Цэвэрлэх товчийг идэвхжүүлэх */
            resetFilter.classList.remove('disabled');
            resetFilter.classList.add('btn-outline-light');

            /* Шүүлтүүр бүрийн утгыг URL-ээс унших */
            filterBtns.forEach(filter => {
                const value = urlParams.get(filter.dataset.name);
                if (value) {
                    filter.dataset.id = value;
                    /* Тухайн утгын текстийг олж товчинд харуулах */
                    const selector = `.filter-values-${filter.dataset.name}[data-id="${value}"]`;
                    const titleElement = document.querySelector(selector);
                    filter.textContent = titleElement?.textContent || value;
                    filter.classList.add('btn-outline-light');
                }
            });
        }

        /* ========== МЭДЭЭНИЙ ХҮСНЭГТИЙГ ЭХЛҮҮЛЭХ ========== */
        const news = new motable('table#news');

        /* Серверээс мэдээний жагсаалтыг татах */
        fetch(
            `{{ 'news-list'|link }}` + window.location.search
        ).then(res => {
            /* Хариуны төрлийг шалгах */
            if (res.headers.get('content-type')?.includes('application/json')) return res.json();
            throw new Error(`HTTP [${res.status}]: ${res.statusText}`);
        }).then(data => {
            /* Хариу буруу бол алдаа шидэх */
            if (!data.list) {
                throw new Error(data.message ?? 'Invalid response!');
            }

            /* ========== ХҮСНЭГТИЙН МӨРҮҮДИЙГ ҮҮСГЭХ ========== */
            let rowsHTML = '';
            const indexLink = `{{ 'news'|link }}`;

            /* Хэрэглэгчийн эрхүүдийг шалгах */
            const canUpdate = {{ user.can('system_content_update') ? 'true' : 'false' }};  /* Засах эрх */
            const canDelete = {{ user.can('system_content_delete') ? 'true' : 'false' }};  /* Устгах эрх */

            /* Нийтлэгдсэн гэсэн текстийг хэлнээс хамааруулан тохируулах */
            const published_text = document.documentElement.lang === 'mn' ? 'нийтэлсэн' : 'published';

            /* Мэдээ бүрийг давтаж хүснэгтийн мөр үүсгэх */
            data.list.forEach(record => {
                const id = record.id;

                /* Хэлний туг үүсгэх (en -> us туг руу хөрвүүлэх) */
                let flag = '';
                if (record.code) {
                    const codeFlag = record.code === 'en' ? 'us' : record.code;
                    flag = `<img src="https://flagcdn.com/20x15/${codeFlag}.png" srcset="https://flagcdn.com/40x30/${codeFlag}.png 2x" width="16" height="12">`;
                }

                /* Зургийг харуулах */
                let image = '';
                if (record.photo) {
                    image = `<img style="max-width:60px;max-height:60px" src="${record.photo}">`;
                }

                /* Төрөл ба ангиллын badge үүсгэх */
                let type_category = `<span class="badge bg-primary">${record.type}</span>`;
                type_category += ` <span class="badge bg-danger">${record.category}</span>`;

                /* Нийтлэгдсэн төлөвийг харуулах */
                const published = record.published === 1 ? `<i class="bi bi-emoji-heart-eyes-fill text-success"></i> ${published_text}<br/><small>${record['published_at']}</small>` : '<i class="bi bi-eye-slash"></i>';

                /* ========== ҮЙЛДЛИЙН ТОВЧНУУДЫГ ҮҮСГЭХ ========== */
                const buttons = [`<a class="btn btn-sm btn-warning mt-1 shadow-sm" href="${indexLink}/read/${record.id}"><i class="bi bi-book"></i></a>`];  /* Унших товч */
                buttons.push(`<a class="btn btn-sm btn-info mt-1 shadow-sm" href="${indexLink}/view/${record.id}"><i class="bi bi-eye"></i></a>`);          /* Харах товч */

                /* Засах эрхтэй бол засах товч нэмэх */
                if (canUpdate) {
                    buttons.push(`<a class="btn btn-sm btn-primary mt-1 shadow-sm" href="${indexLink}/${record.id}"><i class="bi bi-pencil-square"></i></a>`);
                }
                /* Устгах эрхтэй бол устгах товч нэмэх */
                if (canDelete) {
                    buttons.push(`<button class="deactivate-news btn btn-sm btn-danger mt-1 shadow-sm" type="button" value="${record.id}"><i class="bi bi-trash"></i></button>`);
                }
                const actions = `<div class="mb-1">${buttons.join(' ')}</div>`;

                /* Хүснэгтийн мөр үүсгэх */
                rowsHTML += `<tr><th scope="row"><span class="text-secondary">${id} /</span> ${record['created_date']}</th><td>${flag} <span class="text-secondary fw-lighter">${record.code}</span> </td><td>${image}</td><td>${record.title}</td><td>${data.files_counts[id] ?? 0}</td><td>${type_category}</td><td>${published}</td><td>${actions}</td></tr>`;
            });

            /* Хүснэгтэд өгөгдөл оруулах */
            news.setBody(rowsHTML);
            news.setReady();
        }).catch(err => {
            /* Алдаа гарвал хүснэгтэд харуулах */
            news.error(err);
        }).finally(() => {
            /* ========== AJAX MODAL ТОВЧНУУДАД EVENT НЭМЭХ ========== */
            const modals = news.table.querySelectorAll('.ajax-modal');
            modals.forEach(a => a.addEventListener('click', function () {
                ajaxModal(a);
            }));

            /* ========== МЭДЭЭ ИДЭВХГҮЙ БОЛГОХ (УСТГАХ) ТОВЧНУУДАД EVENT НЭМЭХ ========== */
            const deactivates = news.table.querySelectorAll('.deactivate-news');
            deactivates.forEach(btn => btn.addEventListener('click', function (e) {
                e.preventDefault();

                /* Хүснэгтийн мөрийг олох */
                const thisRow = btn.closest('tr');
                if (!thisRow) {
                    return NotifyTop('warning', `{{ 'error'|text|e }}`, 'Cannot select row!');
                }

                /* Мэдээний мэдээллийг авах */
                const id = btn.value;
                const title = thisRow.children[3].textContent.replace(/<\/?[^>]+(>|$)/g, '');

                /* Баталгаажуулах асуултын текстийг хэлнээс хамааруулан тохируулах */
                let question = document.documentElement.lang === 'mn'
                    ? `<p class="text-danger mb-3">Та (${title}) мэдээг идэвхгүй болгохдоо итгэлтэй байна уу?</p>`
                    : `<p class="text-danger mb-3">Are you sure to deactivate the news (${title})?</p>`;

                /* Зургийг SweetAlert-д харуулах эсэхийг шалгах */
                let src = '';
                const photo = thisRow.children[2].querySelector('img');
                if (photo && photo.src) {
                    src = photo.src;
                } else {
                    question = `<i class="bi bi-question-circle text-danger mb-4" style="font-size:3rem"></i><p>${question}</p>`;
                }

                /* ========== SWEETALERT БАТАЛГААЖУУЛАХ ЦОНХ ========== */
                Swal.fire({
                    imageUrl: src,
                    imageHeight: 64,
                    html: question,
                    showCancelButton: true,
                    cancelButtonText: `{{ 'cancel'|text|e }}`,
                    confirmButtonText: `<i class="bi bi-trash"></i> {{ 'delete'|text|e }}`,
                    confirmButtonColor: '#df4759',
                    showLoaderOnConfirm: true,
                    allowOutsideClick: () => !Swal.isLoading(),
                    backdrop: true,
                    preConfirm: () => {
                        /* Сервер рүү устгах хүсэлт илгээх */
                        return fetch(
                            `{{ 'news-deactivate'|link }}`,
                            {
                                method: 'DELETE',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({id, title})
                            }
                        ).then(res => {
                            return res.json();
                        }).then(response => {
                            /* Амжилттай бол хүснэгтээс мөр устгах */
                            if (response.status !== 'success') {
                                throw new Error(response.message ?? 'Invalid response!');
                            }

                            Swal.close();

                            /* Хүснэгтээс мөр устгах */
                            thisRow.remove();
                            news.setReady();

                            /* Амжилттай мэдэгдэл харуулах */
                            NotifyTop('success', `{{ 'success'|text|e }}`, response.message ?? `News:${id} deactivated`);
                        }).catch(error => {
                            /* Алдааг SweetAlert-д харуулах */
                            Swal.showValidationMessage(error.message);
                        });
                    }
                });
            }));
        });
    });
</script>

<!-- Мэдээний төрлүүдийн тодорхойлолт -->
{% set types = {
    'article': { 'mn': 'Мэдээ' },
    'announcement': { 'mn': 'Зарлал' },
    'embed': { 'mn': 'Шигтгэсэн' },
    'gallery': { 'mn': 'Цомог' },
    'video': { 'mn': 'Видео' },
    'audio': { 'mn': 'Аудио' },
    'live': { 'mn': 'Шууд' }
} %}
<!-- Мэдээний ангиллын тодорхойлолт -->
{% set categories = {
    'general': { 'mn': 'Ерөнхий' },
    'activity': { 'mn': 'Үйл ажиллагаа' },
    'press': { 'mn': 'Хэвлэлийн мэдээ' },
    'event': { 'mn': 'Арга хэмжээ' },
    'report': { 'mn': 'Тайлан' },
    'policy': { 'mn': 'Бодлого, дүрэм' },
    'fun': { 'mn': 'Хөгжилтэй' }
} %}
<!-- Mongolian WYSIWYG Editor - текст editor -->
<link href="{{ index }}/assets/css/moedit.css" rel="stylesheet">
<link href="{{ index }}/assets/css/moedit-icons.css" rel="stylesheet">
<script defer src="{{ index }}/assets/js/moedit.js"></script>
<script defer src="{{ index }}/assets/js/moedit.ui.js"></script>
<!-- mofiles - файл upload хүснэгт (dependency автоматаар ачаална) -->
<script defer src="{{ index }}/assets/js/mofiles.js"></script>
<!-- Хуудасны толгой хэсэг - гарчиг болон үйлдлийн товчнууд -->
<div class="d-flex flex-wrap justify-content-between align-items-center text-uppercase rounded p-1 mb-2 shadow">
    <h3 class="px-2 my-auto fs-6 text-success">
        <i class="bi bi-book"></i> {{ 'add-record'|text }} (news)
    </h3>
    <div class="ms-auto">
        <!-- Хэрэв хэрэглэгч мэдээ нэмэх эрхтэй бол хадгалах товч харуулах -->
        {% if user.can('system_content_insert') %}
            <button class="submit-insert btn btn-sm btn-success text-uppercase shadow-sm">
                <i class="bi bi-check-lg"></i> {{ 'save'|text }}
            </button>
        {% endif %}
        <!-- Жагсаалт руу буцах товч -->
        <a class="btn btn-sm btn-secondary shadow-sm" href="{{ 'news'|link }}">
            <i class="bi bi-arrow-left"></i> {{ 'list'|text }}
        </a>
    </div>
</div>
<!-- Мэдээ нэмэх форм -->
<form class="needs-validation" id="news_insert" action="{{ 'news-insert'|link }}" method="POST" enctype="multipart/form-data" novalidate>
    <!-- Эхний мөр: Хэл, Төрөл, Ангилал сонгох талбарууд -->
    <div class="row mt-3">
        <!-- Хэл сонгох талбар -->
        <div class="col-4">
            <label class="form-label">{{ 'language'|text }} <i class="bi bi-translate"></i></label>
            <select class="form-select" name="code">
                {% for code,language in localization.language %}
                    <option value="{{ code }}"{{ loop.first ? ' selected' : '' }}>{{ language['title']|e }}</option>
                {% endfor %}
            </select>
        </div>
        <!-- Мэдээний төрөл сонгох талбар (dropdown) -->
        <div class="col-4">
            <label class="form-label">{{ 'type'|text }}</label>
            <div class="input-group">
                <input class="form-control" name="type" type="text" value="{{ types|keys|first|e }}" maxlength="32">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false"></button>
                <ul class="dropdown-menu dropdown-menu-end" id="type_list">
                    {% for value,name in types %}
                        <li class="dropdown-item" value="{{ value|e }}">{{ name[localization.code] ?? value|capitalize }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        <!-- Мэдээний ангилал сонгох талбар (dropdown) -->
        <div class="col-4">
            <label class="form-label">{{ 'category'|text }}</label>
            <div class="input-group">
                <input class="form-control" name="category" type="text" value="{{ categories|keys|first|e }}" maxlength="32">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false"></button>
                <ul class="dropdown-menu dropdown-menu-end" id="category_list">
                    {% for value,name in categories %}
                        <li class="dropdown-item" value="{{ value|e }}">{{ name[localization.code] ?? value|capitalize }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    <!-- Мэдээний гарчиг -->
    <div class="mt-3">
        <label class="form-label">{{ 'title'|text }}</label>
        <input class="form-control" name="title" required value="" maxlength="255" type="text" autocomplete="off">
        <div class="invalid-feedback">{{ 'field-is-required'|text }}</div>
    </div>
    <!-- Агуулга болон Файлууд tab-ууд -->
    <ul class="nav nav-tabs mt-3" id="contentFilesTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="content-tab" data-bs-toggle="tab" data-bs-target="#content-pane" type="button" role="tab" aria-controls="content-pane" aria-selected="true">
                <i class="bi bi-text-paragraph"></i> {{ 'content'|text }}
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="files-tab" data-bs-toggle="tab" data-bs-target="#files-pane" type="button" role="tab" aria-controls="files-pane" aria-selected="false">
                <i class="bi bi-paperclip"></i> {{ 'files'|text }}
            </button>
        </li>
    </ul>
    <div class="tab-content border border-top-0 rounded-bottom p-3" id="contentFilesTabContent">
        <!-- Агуулга tab (WYSIWYG editor) -->
        <div class="tab-pane fade show active" id="content-pane" role="tabpanel" aria-labelledby="content-tab">
            <textarea id="content" name="content"></textarea>
        </div>
        <!-- Файлууд tab -->
        <div class="tab-pane fade" id="files-pane" role="tabpanel" aria-labelledby="files-tab">
            <table class="table table-striped table-hover" id="news_files"></table>
        </div>
    </div>
    <!-- Хэрэв хэрэглэгч нийтлэх эрхтэй бол нийтлэх болон сэтгэгдэл авах тохиргоо харуулах -->
    {% if user.can('system_content_publish') %}
    <div class="rounded border border-success mt-3 p-3">
        <div class="row">
            <!-- Нийтлэх эсэх сонголт -->
            <div class="col-4">
                <label class="form-label fw-bolder">{{ 'publish'|text }}</label>
                <div class="form-check form-switch">
                    <input class="form-check-input" name="published" type="checkbox" role="switch">
                    {{ localization.code == 'mn' ? 'сайт дээр харагдах' : 'visible on site' }}
                </div>
            </div>
            <!-- Онцлох мэдээ эсэх сонголт -->
            <div class="col-4">
                <label class="form-label fw-bolder">{{ localization.code == 'mn' ? 'Онцлох' : 'Featured' }}</label>
                <div class="form-check form-switch">
                    <input class="form-check-input" name="is_featured" type="checkbox" role="switch">
                    {{ localization.code == 'mn' ? 'нүүр хуудсанд онцлох' : 'feature on homepage' }}
                </div>
            </div>
            <!-- Сэтгэгдэл авах эсэх сонголт -->
            <div class="col-4">
                <label class="form-label fw-bolder">{{ 'comment'|text }}</label>
                <div class="form-check form-switch">
                    <input class="form-check-input" name="comment" type="checkbox" role="switch">
                    {{ 'can-comment'|text }}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</form>
<!-- Формын доорх үйлдлийн товчнууд -->
<div class="rounded p-2 mt-4 shadow">
    {% if user.can('system_content_insert') %}
        <button class="submit-insert btn btn-success text-uppercase shadow-sm">
            <i class="bi bi-check2"></i> {{ 'save'|text }}
        </button>
    {% endif %}
    <a class="btn btn-secondary text-uppercase shadow-sm" href="{{ 'news'|link }}">
        <i class="bi bi-arrow-left"></i> {{ 'list'|text }}
    </a>
</div>
<script type="text/javascript">
    /* Мэдээний төрөл сонгох үед editor-ийн горимыг өөрчлөх */
    const content = document.getElementById('content');
    const type = document.querySelector('input[name="type"]');
    let moeditInstance = null;

    document.getElementById('type_list').addEventListener('click', function (e) {
        if (e.target && e.target.nodeName === 'LI') {
            type.value = e.target.getAttribute('value');
            if (moeditInstance) {
                moeditInstance.toggleSource(type.value === 'embed');
            }
        }
    });

    /* Мэдээний ангилал сонгох event listener */
    const category = document.querySelector('input[name="category"]');
    document.getElementById('category_list').addEventListener('click', function (e) {
        if (e.target && e.target.nodeName === 'LI') {
            category.value = e.target.getAttribute('value');
        }
    });

    /* Header image файл хадгалах хувьсагч */
    let headerImageFile = null;

    /* DOM ачаалагдсаны дараа */
    document.addEventListener('DOMContentLoaded', function () {
        /* moedit (WYSIWYG текст засварлагч) идэвхжүүлэх */
        moeditInstance = new moedit(content, {
            shineUrl: `{{ 'moedit-ai'|link }}`,
            uploadUrl: `{{ 'content-image-post'|link({'table': 'news', 'id': 0}) }}`,
            onHeaderImageChange: function (file) {
                headerImageFile = file;
            }
        });

        /* Хэрэв 'embed' төрөл сонгогдвол source mode руу шилжих */
        if (type.value === 'embed') {
            moeditInstance.toggleSource(true);
        }

        /* mofiles - файл upload хүснэгт */
        const files = new mofiles('#news_files', {
            uploadUrl: `{{ 'files-post'|link({'input':'file', 'table':table, 'id':0}) }}`,
            deleteUrl: `{{ 'files-deactivate'|link({'table':table}) }}`,
            modalUrl: `{{ 'files-modal'|link({'table':table}) }}`,
            maxFileSize: `{{ max_file_size ?? '8mb' }}`,
            permissions: {
                update: {{ user.can('system_content_update') ? 'true' : 'false' }},
                delete: {{ user.can('system_content_delete') ? 'true' : 'false' }}
            },
            countBadge: '#files-tab',
            onEmbed: function (html) {
                if (moeditInstance) {
                    moeditInstance.insertHtml(html);
                    /* Content tab руу шилжих */
                    const contentTab = document.getElementById('content-tab');
                    if (contentTab) contentTab.click();
                    /* Editor-г идэвхжүүлж, оруулсан контент руу scroll хийх */
                    setTimeout(() => {
                        moeditInstance.editor.focus();
                        moeditInstance.editor.scrollTop = moeditInstance.editor.scrollHeight;
                    }, 100);
                }
            }
        });

        /* Форм илгээх функц */
        const formInsert = document.querySelector('form#news_insert');
        if (!formInsert) {
            NotifyTop('danger', `{{ 'error'|text|e }}`, 'Form not found!');
        } else {
            /* Хадгалах товчнууд дээр дарахад форм илгээх */
            const submitters = document.querySelectorAll('button.submit-insert');
            submitters.forEach(function (btn) {
                btn.addEventListener('click', function (e) {
                    e.preventDefault();
                    formInsert.requestSubmit();
                });
            });

            /* Форм submit хийхэд */
            formInsert.addEventListener('submit', function (event) {
                event.preventDefault();

                /* Формын баталгаажуулалт */
                const _valid = this.checkValidity();
                this.classList.add('was-validated');
                if (!_valid) {
                    event.stopPropagation();
                    return NotifyTop('danger', `{{ 'error'|text|e }}`, `{{ 'u-have-some-form-errors'|text|e }}`);
                }

                /* Товчнуудыг disable хийх (spinner харуулах) */
                submitters.forEach(function (btn) { btn.growNstop(); });

                /* FormData үүсгэж сервер рүү илгээх */
                const data = new FormData(this);

                /* Header image файлыг FormData-д нэмэх */
                if (headerImageFile) {
                    data.append('photo', headerImageFile);
                }

                /* Checkbox-уудыг normalize хийх (checked = 1, unchecked = 0) */
                const publishedCheckbox = this.querySelector('input[name="published"]');
                if (publishedCheckbox) {
                    data.set('published', publishedCheckbox.checked ? '1' : '0');
                }
                const isFeaturedCheckbox = this.querySelector('input[name="is_featured"]');
                if (isFeaturedCheckbox) {
                    data.set('is_featured', isFeaturedCheckbox.checked ? '1' : '0');
                }
                const commentCheckbox = this.querySelector('input[name="comment"]');
                if (commentCheckbox) {
                    data.set('comment', commentCheckbox.checked ? '1' : '0');
                }
                
                fetch(
                    this.action,
                    {
                        body: data,
                        method: this.getAttribute('method') ?? 'POST'
                    }
                ).then(res => {
                    if (res.headers.get('content-type')?.includes('application/json')) return res.json();
                    throw new Error(`HTTP [${res.status}]: ${res.statusText}`);
                }).then(response => {
                    if (response.status !== 'success') {
                        throw new Error(response.message ? response.message : 'Invalid response!');
                    }

                    /* Амжилттай бол мэдээний жагсаалт руу шилжих */
                    window.location.href = `{{ 'news'|link }}`;

                    NotifyTop(response.type ?? 'success', response.title ?? `{{ 'success'|text|e }}`, response.message ?? 'News created');
                }).catch(error => {
                    /* Алдаа гарсан тохиолдолд */
                    NotifyTop('danger', `{{ 'error'|text|e }}`, error.message);
                    submitters.forEach(function (btn) { btn.growNstop();});
                });
            });
        }
    });
</script>

<!-- Хуудасны төрлүүдийн тодорхойлолт -->
{% set types = {
    'menu': { 'mn': 'Цэс' },
    'important-menu': { 'mn': 'Чухал цэс' },
    'mega-menu': { 'mn': 'Мега цэс' },
    'special-page': { 'mn': 'Тусгай хуудас' },
    'embed': { 'mn': 'Шигтгэсэн' }
} %}
<!-- Хуудасны ангиллын тодорхойлолт -->
{% set categories = {
    'general': { 'mn': 'Ерөнхий' },
    'featured': { 'mn': 'Онцолсон' }
} %}
<!-- Mongolian WYSIWYG Editor - текст editor -->
<link href="{{ index }}/assets/moedit/moedit.css" rel="stylesheet">
<link href="{{ index }}/assets/moedit/moedit-icons.css" rel="stylesheet">
<script defer src="{{ index }}/assets/moedit/moedit.js"></script>
<script defer src="{{ index }}/assets/moedit/moedit.ui.js"></script>
<!-- Хуудасны толгой хэсэг -->
<div class="d-flex flex-wrap justify-content-between align-items-center text-uppercase rounded p-1 mb-2 shadow">
    <h3 class="px-2 my-auto fs-6 text-success">
        <i class="bi bi-book"></i> {{ 'add-record'|text }} (pages)
    </h3>
    <div class="ms-auto">
        {% if user.can('system_content_insert') %}
            <button class="submit-insert btn btn-sm btn-success text-uppercase shadow-sm">
                <i class="bi bi-check-lg"></i> {{ 'save'|text }}
            </button>
        {% endif %}
        <a class="btn btn-sm btn-secondary shadow-sm" href="{{ 'pages'|link }}">
            <i class="bi bi-arrow-left"></i> {{ 'pages'|text }}
        </a>
    </div>
</div>
<!-- Хуудас нэмэх форм -->
<form class="needs-validation" id="page_insert" action="{{ 'page-insert'|link }}" method="POST" enctype="multipart/form-data" novalidate>
    <!-- Эхний мөр: Хэл, Төрөл, Ангилал сонгох талбарууд -->
    <div class="row mt-3">
        <!-- Хэл сонгох талбар -->
        <div class="col-4">
            <label class="form-label">{{ 'language'|text }} <i class="bi bi-translate"></i></label>
            {% set first_code = localization.language|keys|first %}
            {% set first_flag = first_code == 'en' ? 'us' : first_code %}
            <div class="input-group">
                <span class="input-group-text" id="lang_flag">
                    <img src="https://flagcdn.com/20x15/{{ first_flag }}.png"
                         srcset="https://flagcdn.com/40x30/{{ first_flag }}.png 2x"
                         width="20" height="15" alt="{{ first_code }}">
                </span>
                <input class="form-control" name="code" type="text" value="{{ first_code|e }}" readonly>
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false"></button>
                <ul class="dropdown-menu dropdown-menu-end" id="lang_list">
                    {% for code,language in localization.language %}
                        {% set flag = code == 'en' ? 'us' : code %}
                        <li class="dropdown-item" value="{{ code|e }}">
                            <img src="https://flagcdn.com/16x12/{{ flag }}.png"
                                 srcset="https://flagcdn.com/32x24/{{ flag }}.png 2x"
                                 width="16" height="12" alt="{{ code }}"
                                 style="vertical-align:middle;margin-right:.35rem">{{ language['title']|e }}
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        <!-- Хуудасны төрөл сонгох талбар (dropdown) -->
        <div class="col-4">
            <label class="form-label">{{ 'type'|text }} <i class="bi bi-tag"></i></label>
            <div class="input-group">
                <input class="form-control" name="type" type="text" value="{{ types|keys|first|e }}" maxlength="32">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false"></button>
                <ul class="dropdown-menu dropdown-menu-end" id="type_list">
                    {% for value,name in types %}
                        <li class="dropdown-item" value="{{ value|e }}">{{ name[localization.code] ?? value|capitalize }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        <!-- Хуудасны ангилал сонгох талбар (dropdown) -->
        <div class="col-4">
            <label class="form-label">{{ 'category'|text }} <i class="bi bi-bookmark"></i></label>
            <div class="input-group">
                <input class="form-control" name="category" type="text" value="{{ categories|keys|first|e }}" maxlength="32">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false"></button>
                <ul class="dropdown-menu dropdown-menu-end" id="category_list">
                    {% for value,name in categories %}
                        <li class="dropdown-item" value="{{ value|e }}">{{ name[localization.code] ?? value|capitalize }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    <!-- Хоёр дахь мөр: Эцэг хуудас, Байрлал -->
    <div class="row mt-3">
        <div class="col-8">
            <label class="form-label">{{ 'parent'|text }} <i class="bi bi-diagram-3"></i></label>
            <select class="form-select" name="parent_id">
                <option value="0" selected>-</option>
                {% for id,info in infos %}
                    <option value="{{ id }}">{{ (info['parent_titles'] ?? '')|e }}{{ info['title']|e }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-4">
            <label class="form-label">{{ 'position'|text }} <i class="bi bi-sort-numeric-down"></i></label>
            <input class="form-control" name="position" value="100" placeholder="" type="number" autocomplete="off">
            <div class="invalid-feedback">{{ 'field-is-required'|text }}</div>
        </div>
    </div>
    <!-- Гарчиг -->
    <div class="mt-3">
        <label class="form-label">{{ 'title'|text }} <i class="bi bi-card-heading"></i></label>
        <input class="form-control" name="title" required value="" maxlength="255" type="text" autocomplete="off">
        <div class="invalid-feedback">{{ 'field-is-required'|text }}</div>
    </div>
    <!-- Тайлбар -->
    <div class="mt-3">
        <label class="form-label">{{ 'description'|text }} <i class="bi bi-text-paragraph"></i></label>
        <textarea class="form-control" name="description" rows="2"></textarea>
    </div>
    <!-- Агуулга -->
    <div class="mt-3">
        <textarea name="content"></textarea>
    </div>
    <!-- Холбоос -->
    <div class="mt-3">
        <label class="form-label">{{ 'link'|text }} <i class="bi bi-link-45deg"></i></label>
        <input class="form-control" name="link" type="url" value="" maxlength="255">
    </div>
    <!-- Хэрэв хэрэглэгч нийтлэх эрхтэй бол нийтлэх болон сэтгэгдэл авах тохиргоо харуулах -->
    {% if user.can('system_content_publish') %}
    <div class="rounded border border-success mt-3 p-3">
        <div class="row">
            <!-- Нийтлэх эсэх сонголт -->
            <div class="col-4">
                <label class="form-label fw-bolder">{{ 'publish'|text }} <i class="bi bi-globe"></i></label>
                <div class="form-check form-switch">
                    <input class="form-check-input" name="published" type="checkbox" role="switch">
                    {{ localization.code == 'mn' ? 'сайт дээр харагдах' : 'visible on site' }}
                </div>
            </div>
            <!-- Онцлох хуудас эсэх сонголт -->
            <div class="col-4">
                <label class="form-label fw-bolder">{{ localization.code == 'mn' ? 'Онцлох' : 'Featured' }} <i class="bi bi-star"></i></label>
                <div class="form-check form-switch">
                    <input class="form-check-input" name="is_featured" type="checkbox" role="switch">
                    {{ localization.code == 'mn' ? 'нүүр хуудсанд онцлох' : 'feature on homepage' }}
                </div>
            </div>
            <!-- Сэтгэгдэл авах эсэх сонголт -->
            <div class="col-4">
                <label class="form-label fw-bolder">{{ 'comment'|text }} <i class="bi bi-chat-dots"></i></label>
                <div class="form-check form-switch">
                    <input class="form-check-input" name="comment" type="checkbox" role="switch">
                    {{ 'can-comment'|text }}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</form>
<!-- Формын доорх үйлдлийн товчнууд -->
<div class="rounded p-2 mt-4 shadow">
    {% if user.can('system_content_insert') %}
        <button class="submit-insert btn btn-success text-uppercase shadow-sm">
            <i class="bi bi-check2"></i> {{ 'save'|text }}
        </button>
    {% endif %}
    <a class="btn btn-secondary text-uppercase shadow-sm" href="{{ 'pages'|link }}">
        <i class="bi bi-arrow-left"></i> {{ 'pages'|text }}
    </a>
</div>
<script type="text/javascript">
    /* Хуудасны төрөл сонгох үед editor-ийн горимыг өөрчлөх */
    const content = document.querySelector('textarea[name="content"]');
    const type = document.querySelector('input[name="type"]');

    document.getElementById('type_list').addEventListener('click', function (e) {
        if (e.target && e.target.nodeName === 'LI') {
            type.value = e.target.getAttribute('value');
            content._moedit?.toggleSource(type.value === 'embed');
        }
    });

    /* Хэл сонгох event listener */
    const langInput = document.querySelector('input[name="code"]');
    const langFlag = document.getElementById('lang_flag');
    document.getElementById('lang_list').addEventListener('click', function (e) {
        const li = e.target.closest('li.dropdown-item');
        if (li) {
            const code = li.getAttribute('value');
            langInput.value = code;
            const flag = code === 'en' ? 'us' : code;
            langFlag.innerHTML = `<img src="https://flagcdn.com/20x15/${flag}.png" srcset="https://flagcdn.com/40x30/${flag}.png 2x" width="20" height="15" alt="${code}">`;
        }
    });

    /* Хуудасны ангилал сонгох event listener */
    const category = document.querySelector('input[name="category"]');
    document.getElementById('category_list').addEventListener('click', function (e) {
        if (e.target && e.target.nodeName === 'LI') {
            category.value = e.target.getAttribute('value');
        }
    });

    /* DOM ачаалагдсаны дараа */
    document.addEventListener('DOMContentLoaded', function () {
        /* moedit (WYSIWYG текст засварлагч) идэвхжүүлэх */
        new moedit(content, {
            upload: {
                url: `{{ 'files-upload'|link }}`,
                folder: 'pages/temp/{{ user.profile['id'] }}',
                maxFileSize: {{ max_file_size }}
            },
            titleSelector: 'input[name="title"]',
            ai_helper: `{{ 'moedit-ai'|link }}`,
            sourceMode: type.value === 'embed'
        });

        /* Форм илгээх функц */
        const formInsert = document.querySelector('form#page_insert');
        if (!formInsert) {
            NotifyTop('danger', `{{ 'error'|text|e }}`, 'Form not found!');
        } else {
            /* Хадгалах товчнууд дээр дарахад форм илгээх */
            const submitters = document.querySelectorAll('button.submit-insert');
            submitters.forEach(function (btn) {
                btn.addEventListener('click', function (e) {
                    e.preventDefault();
                    formInsert.requestSubmit();
                });
            });

            /* Форм submit хийхэд */
            formInsert.addEventListener('submit', function (event) {
                event.preventDefault();

                /* Формын баталгаажуулалт */
                const _valid = this.checkValidity();
                this.classList.add('was-validated');
                if (!_valid) {
                    event.stopPropagation();
                    return NotifyTop('danger', `{{ 'error'|text|e }}`, `{{ 'u-have-some-form-errors'|text|e }}`);
                }

                /* Товчнуудыг disable хийх (spinner харуулах) */
                submitters.forEach(function (btn) { btn.growNstop(); });

                /* FormData үүсгэж сервер рүү илгээх */
                const data = new FormData(this);

                /* Checkbox-уудыг normalize хийх (checked = 1, unchecked = 0) */
                const publishedCheckbox = this.querySelector('input[name="published"]');
                if (publishedCheckbox) {
                    data.set('published', publishedCheckbox.checked ? '1' : '0');
                }
                const isFeaturedCheckbox = this.querySelector('input[name="is_featured"]');
                if (isFeaturedCheckbox) {
                    data.set('is_featured', isFeaturedCheckbox.checked ? '1' : '0');
                }
                const commentCheckbox = this.querySelector('input[name="comment"]');
                if (commentCheckbox) {
                    data.set('comment', commentCheckbox.checked ? '1' : '0');
                }

                /* Бүх файлуудын мэдээллийг JSON хэлбэрээр илгээх */
                if (content._moedit) {
                    data.append('files', JSON.stringify(content._moedit.getFiles()));
                }

                fetch(
                    this.action,
                    {
                        body: data,
                        method: this.getAttribute('method') ?? 'POST'
                    }
                ).then(res => {
                    if (res.headers.get('content-type')?.includes('application/json')) return res.json();
                    throw new Error(`HTTP [${res.status}]: ${res.statusText}`);
                }).then(response => {
                    if (response.status !== 'success') {
                        throw new Error(response.message ? response.message : 'Invalid response!');
                    }

                    /* Амжилттай бол хуудасны жагсаалт руу шилжих */
                    window.location.href = `{{ 'pages'|link }}`;

                    NotifyTop(response.type ?? 'success', response.title ?? `{{ 'success'|text|e }}`, response.message ?? 'Page created');
                }).catch(error => {
                    /* Алдаа гарсан тохиолдолд */
                    NotifyTop('danger', `{{ 'error'|text|e }}`, error.message);
                    submitters.forEach(function (btn) { btn.growNstop();});
                });
            });
        }
    });
</script>

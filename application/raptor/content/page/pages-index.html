<script defer src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- ========== ТОЛГОЙ ХЭСЭГ ========== -->
<div class="d-flex flex-wrap justify-content-between align-items-center text-uppercase rounded p-1 shadow">
    <h3 class="px-2 my-auto fs-5 text-primary text-uppercase">
        <i class="bi bi-book-half"></i> {{ 'pages'|text }}
    </h3>
    <div class="ms-auto">
        {% if user.can('system_content_insert') %}
            <a class="btn btn-outline-success text-uppercase shadow-sm" href="{{ 'page-insert'|link }}">
                <i class="bi-plus-circle-dotted"></i> {{ 'new'|text }}
            </a>
        {% endif %}
    </div>
</div>

<!-- ========== ШҮҮЛТҮҮР ХЭСЭГ ========== -->
<style>
.btn-filter {
    --bs-btn-color: var(--bs-emphasis-color);
    --bs-btn-border-color: var(--bs-emphasis-color);
    --bs-btn-hover-color: var(--bs-body-bg);
    --bs-btn-hover-bg: var(--bs-emphasis-color);
    --bs-btn-hover-border-color: var(--bs-emphasis-color);
    --bs-btn-active-color: var(--bs-body-bg);
    --bs-btn-active-bg: var(--bs-emphasis-color);
    --bs-btn-active-border-color: var(--bs-emphasis-color);
}
.btn-filter.active {
    color: var(--bs-body-bg);
    background-color: var(--bs-emphasis-color);
    border-color: var(--bs-emphasis-color);
}
</style>
<div class="d-flex align-items-center flex-wrap gap-2 mt-3 mb-2">
    <button class="btn btn-sm btn-secondary text-uppercase" id="filter_action" type="button">
        <i class="bi bi-funnel"></i> {{ 'filter'|text }}
    </button>
    {% for name,filter in filters %}
    <div class="dropdown">
        <button class="btn btn-sm btn-filter dropdown-toggle content-filters" data-bs-toggle="dropdown" data-name="{{ name }}" aria-expanded="false" type="button">
            {{ filter.title }}
        </button>
        <ul class="dropdown-menu dropdown-menu-end shadow">
            {% for val,label in filter.values %}
                <li><button class="dropdown-item filter-values-{{ name }}" data-id="{{ val }}" type="button">{{ label }}</button></li>
            {% endfor %}
        </ul>
    </div>
    {% endfor %}
</div>

<!-- ========== ХҮСНЭГТ ========== -->
<table class="table table-sm table-hover table-striped table-bordered" id="pages">
    <thead>
        <tr class="text-uppercase">
            <th scope="col">#</th>
            <th scope="col"><i class="bi bi-translate"></i> </th>
            <th scope="col"><i class="bi bi-image"></i></th>
            <th scope="col">{{ 'title'|text }}</th>
            <th scope="col"><i class="bi bi-paperclip"></i></th>
            <th scope="col">{{ 'type'|text }} / {{ 'category'|text }}</th>
            <th scope="col">{{ 'position'|text }}</th>
            <th scope="col">{{ 'publish'|text }}</th>
            <th scope="col" style="width:10rem">{{ 'action'|text }}</th>
        </tr>
    </thead>
</table>

<script type="text/javascript">
    const urlParams = new URLSearchParams(window.location.search);

    const filterAction = document.getElementById('filter_action');
    const filterBtns = document.querySelectorAll('button.content-filters');

    /* filter_action товчны төлөвийг шинэчлэх
       3 горим: idle (btn-secondary), changed (btn-danger), applied (btn-dark) */
    function onFilterChange()
    {
        filterBtns.forEach(f => {
            f.classList.toggle('active', !!f.dataset.id);
        });

        const currentParams = new URLSearchParams();
        filterBtns.forEach(f => { if (f.dataset.id) currentParams.append(f.dataset.name, f.dataset.id); });
        const hasFilter = currentParams.size > 0;
        const matchesUrl = currentParams.toString() === urlParams.toString();

        filterAction.classList.remove('btn-secondary', 'btn-danger', 'btn-dark');

        if (!hasFilter && urlParams.size === 0) {
            filterAction.classList.add('btn-secondary');
            filterAction.innerHTML = '<i class="bi bi-funnel"></i> {{ "filter"|text }}';
        } else if (hasFilter && matchesUrl) {
            filterAction.classList.add('btn-dark');
            filterAction.innerHTML = '<i class="bi bi-funnel-fill"></i> {{ "filter"|text }} <i class="bi bi-x-circle ms-1" data-reset></i>';
        } else {
            filterAction.classList.add('btn-danger');
            filterAction.innerHTML = '<i class="bi bi-funnel-fill"></i> {{ "filter"|text }} <i class="bi bi-x-circle ms-1" data-reset></i>';
        }

        const resetIcon = filterAction.querySelector('[data-reset]');
        if (resetIcon) {
            resetIcon.addEventListener('click', function (e) {
                e.stopPropagation();
                window.location.href = window.location.pathname;
            });
        }
    }

    filterBtns.forEach(filter => {
        document.querySelectorAll(`.filter-values-${filter.dataset.name}`).forEach(btn => {
            btn.addEventListener('click', function (e) {
                e.preventDefault();
                filter.textContent = e.target.textContent;
                filter.dataset.id = e.target.dataset?.id;
                onFilterChange();
            });
        });
    });

    filterAction.addEventListener('click', function (e) {
        e.preventDefault();
        if (filterAction.classList.contains('btn-secondary')) {
            return NotifyTop('warning', `{{ 'warning'|text|e }}`, '{{ localization.code == "mn" ? "Шүүлтүүрээс ядаж нэгийг сонгоорой" : "Select at least one filter" }}');
        }
        if (filterAction.classList.contains('btn-dark')) return;
        const params = [];
        filterBtns.forEach(filter => {
            if (filter.dataset.id) {
                params.push(`${filter.dataset.name}=${filter.dataset.id}`);
            }
        });
        if (params.length === 0) return;
        window.location.href = window.location.pathname + '?' + params.join('&');
    });

    document.addEventListener('DOMContentLoaded', function () {
        if (urlParams?.size > 0) {
            filterBtns.forEach(filter => {
                const value = urlParams.get(filter.dataset.name);
                if (value) {
                    filter.dataset.id = value;
                    const selector = `.filter-values-${filter.dataset.name}[data-id="${value}"]`;
                    const titleElement = document.querySelector(selector);
                    filter.textContent = titleElement?.textContent || value;
                    filter.classList.add('active');
                }
            });
            onFilterChange();
        }

        const pages = new motable('table#pages', { freezeColumns: [0] });
        fetch(
            `{{ 'pages-list'|link }}` + window.location.search
        ).then(res => {
            if (res.headers.get('content-type')?.includes('application/json')) return res.json();
            throw new Error(`HTTP [${res.status}]: ${res.statusText}`);
        }).then(data => {
            if (!data.list) {
                throw new Error(data.message ?? 'Invalid response!');
            }

            let rowsHTML = '';
            const indexLink = `{{ 'pages'|link }}`;
            const canUpdate = {{ user.can('system_content_update') ? 'true' : 'false' }};
            const canDelete = {{ user.can('system_content_delete') ? 'true' : 'false' }};
            const published_text = document.documentElement.lang === 'mn' ? 'нийтэлсэн' : 'published';

            data.list.forEach(page => {
                const id = page.id;

                let flag = '';
                if (page.code) {
                    const codeFlag = page.code === 'en' ? 'us' : page.code;
                    flag = `<img src="https://flagcdn.com/20x15/${codeFlag}.png" srcset="https://flagcdn.com/40x30/${codeFlag}.png 2x" width="16" height="12">`;
                }

                let image = '';
                if (page.photo) {
                    image = `<img style="max-width:60px;max-height:60px" src="${page.photo}">`;
                }

                let title = '';
                if (data.infos[id]['parent_titles']) {
                    title = `<span class="fw-lighter"><small>${data.infos[id]['parent_titles']}</small></span>`;
                }
                title += ` <span class="fw-medium">${page.title}</span>`;
                if (page.link) {
                    title += `<small class="bg-light d-block text-primary">${page.link}</small>`;
                }

                let type_category = `<span class="badge bg-warning text-dark">${page.type}</span>`;
                type_category += ` <span class="badge bg-secondary">${page.category}</span>`;

                const published = page.published === 1 ? `<i class="bi bi-emoji-heart-eyes-fill text-success"></i> ${published_text}<br/><small>${page['published_at']}</small>` : '<i class="bi bi-eye-slash"></i>';

                const buttons = [`<a class="btn btn-sm btn-warning mt-1 shadow-sm" href="${indexLink}/read/${page.id}"><i class="bi bi-book"></i></a>`];
                buttons.push(`<a class="btn btn-sm btn-info mt-1 shadow-sm" href="${indexLink}/view/${page.id}"><i class="bi bi-eye"></i></a>`);
                if (canUpdate) {
                    buttons.push(`<a class="btn btn-sm btn-primary mt-1 shadow-sm" href="${indexLink}/${page.id}"><i class="bi bi-pencil-square"></i></a>`);
                }
                if (canDelete) {
                    buttons.push(`<button class="deactivate-page btn btn-sm btn-danger mt-1 shadow-sm" type="button" value="${page.id}"><i class="bi bi-trash"></i></button>`);
                }
                const actions = `<div class="mb-1">${buttons.join(' ')}</div>`;

                rowsHTML += `<tr><th scope="row">${id}</th><td>${flag} <span class="text-secondary fw-lighter">${page.code}</span> </td><td>${image}</td><td>${title}</td><td>${data.files_counts[id]?.attach || ''}</td><td>${type_category}</td><td>${page.position}</td><td>${published}</td><td>${actions}</td></tr>`;
            });
            pages.setBody(rowsHTML);
            pages.setReady();
        }).catch(err => {
            pages.error(err);
        }).finally(() => {
            const modals = pages.table.querySelectorAll('.ajax-modal');
            modals.forEach(a => a.addEventListener('click', function () {
                ajaxModal(a);
            }));

            const deactivates = pages.table.querySelectorAll('.deactivate-page');
            deactivates.forEach(btn => btn.addEventListener('click', function (e) {
                e.preventDefault();

                const thisRow = btn.closest('tr');
                if (!thisRow) {
                    return NotifyTop('warning', `{{ 'error'|text|e }}`, 'Cannot select row!');
                }
                const id = btn.value;
                const title = thisRow.children[3].textContent.replace(/<\/?[^>]+(>|$)/g, '');
                let question = document.documentElement.lang === 'mn'
                    ? `<p class="text-danger mb-3">Та (${title}) хуудсыг идэвхгүй болгоход итгэлтэй байна уу?</p>`
                    : `<p class="text-danger mb-3">Are you sure to deactivate the page (${title})?</p>`;

                let src = '';
                const photo = thisRow.children[2].querySelector('img');
                if (photo && photo.src) {
                    src = photo.src;
                } else {
                    question = `<i class="bi bi-question-circle text-danger mb-4" style="font-size:3rem"></i><p>${question}</p>`;
                }
                Swal.fire({
                    imageUrl: src,
                    imageHeight: 64,
                    html: question,
                    showCancelButton: true,
                    cancelButtonText: `{{ 'cancel'|text|e }}`,
                    confirmButtonText: `<i class="bi bi-trash"></i> {{ 'delete'|text|e }}`,
                    confirmButtonColor: '#df4759',
                    showLoaderOnConfirm: true,
                    allowOutsideClick: () => !Swal.isLoading(),
                    backdrop: true,
                    preConfirm: () => {
                        return fetch(
                            `{{ 'page-deactivate'|link }}`,
                            {
                                method: 'DELETE',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({id, title})
                            }
                        ).then(res => {
                            return res.json();
                        }).then(response => {
                            if (response.status !== 'success') {
                                throw new Error(response.message ?? 'Invalid response!');
                            }

                            Swal.close();

                            thisRow.remove();
                            pages.setReady();

                            NotifyTop('success', `{{ 'success'|text|e }}`, response.message ?? `Page:${id} deactivated`);
                        }).catch(error => {
                            Swal.showValidationMessage(error.message);
                        });
                    }
                });
            }));
        });
    });
</script>

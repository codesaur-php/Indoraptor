<!-- Custom image preview overlay CSS (Fancybox-–∏–π–Ω –æ—Ä–æ–Ω–¥) -->
<style>
    .image-preview-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,.85);
        z-index: 9999;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }
    .image-preview-overlay img,
    .image-preview-overlay video {
        max-width: 90%;
        max-height: 85vh;
        object-fit: contain;
        cursor: default;
        border-radius: 4px;
    }
    .image-preview-overlay audio {
        cursor: default;
        min-width: 320px;
    }
    .image-preview-overlay pre {
        width: 90%;
        max-height: 85vh;
        overflow: auto;
        background: #f8f9fa;
        color: #212529;
        padding: 1rem;
        border-radius: 4px;
        font-size: .875rem;
        cursor: default;
        margin: 0;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    .image-preview-overlay iframe {
        width: 90%;
        height: 90vh;
        border: none;
        border-radius: 4px;
        background: #fff;
        cursor: default;
    }
    .image-preview-overlay .preview-close {
        position: absolute;
        top: 12px;
        right: 20px;
        color: #fff;
        font-size: 2.5rem;
        cursor: pointer;
        line-height: 1;
        z-index: 1;
    }
    .image-preview-overlay .preview-caption {
        color: #ccc;
        margin-top: 10px;
        font-size: .95rem;
        text-align: center;
        max-width: 80%;
    }
</style>

<!-- –§–∞–π–ª—ã–Ω —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫ -->
<div class="d-flex flex-wrap align-items-center gap-3 mt-2 mb-2" style="font-size:.875rem">
    <span class="lang-mn">
        <i class="bi bi-database-fill text-primary me-1"></i>
        <strong>{{ total['tables'] }}</strong> —Ö“Ø—Å–Ω—ç–≥—Ç,
        <strong>{{ total['rows'] }}</strong> —Ñ–∞–π–ª,
        <strong>{{ total['sizes'] }}</strong>
    </span>
    <span class="lang-en" hidden>
        <i class="bi bi-database-fill text-primary me-1"></i>
        <strong>{{ total['tables'] }}</strong> tables,
        <strong>{{ total['rows'] }}</strong> files,
        <strong>{{ total['sizes'] }}</strong>
    </span>
    <small class="text-body-tertiary fst-italic ms-auto">
        <span class="lang-mn">* –∫–æ–Ω—Ç–µ–Ω—Ç—ã–Ω —Ç–æ–ª–≥–æ–π –∑—É—Ä–∞–≥, –∞–≥—É—É–ª–≥—ã–Ω —Ñ–∞–π–ª —Ç–æ–æ—Ü–æ–≥–¥–æ–æ–≥“Ø–π</span>
        <span class="lang-en" hidden>* excludes header images &amp; inline files</span>
    </small>
</div>
<!-- –•“Ø—Å–Ω—ç–≥—Ç —Å–æ–Ω–≥–æ–ª—Ç -->
<div class="d-flex flex-wrap gap-1 mb-3">
    {% for name,info in tables %}
    <a class="btn btn-sm rounded-pill {{ name == table ? 'btn-primary' : 'btn-outline-secondary' }}"
       href="{{ 'files'|link }}?table={{ name|e }}">
        {{ name }}{{ name != 'files' ? ' (attachments)' : '' }}
        <span class="badge rounded-pill ms-1 {{ name == table ? 'text-bg-light' : 'text-bg-secondary' }}">
            {{ info['count'] }} &middot; {{ info['size'] }}
        </span>
    </a>
    {% else %}
    <span class="lang-mn text-body-secondary">–º—ç–¥—ç—ç–ª—ç–ª –æ–ª–¥—Å–æ–Ω–≥“Ø–π</span>
    <span class="lang-en text-body-secondary" hidden>no data found</span>
    {% endfor %}
</div>

<!--
    –§–∞–π–ª—ã–Ω –∂–∞–≥—Å–∞–∞–ª—Ç —Ö–∞—Ä—É—É–ª–∞—Ö —Ö“Ø—Å–Ω—ç–≥—Ç.
    –≠–Ω—ç —Ö“Ø—Å–Ω—ç–≥—Ç—ç–¥ tbody –±–∞–π—Ö–≥“Ø–π - JS (motable.append) –∞—à–∏–≥–ª–∞–Ω –¥–∏–Ω–∞–º–∏–∫–∞–∞—Ä “Ø“Ø—Å–≥—ç–Ω—ç.
-->
<table class="table table-sm table-bordered table-striped table-hover" id="files">
    <thead>
        <tr>
            <th scope="col">{{ 'file'|text }}</th>
            <th scope="col">{{ 'properties'|text }}</th>
            <th scope="col">{{ 'description'|text }}</th>
            <th scope="col">{{ 'keyword'|text }}</th>
            <th scope="col">{{ 'date'|text }}</th>
        </tr>
    </thead>
</table>

<script type="text/javascript">
    const _mn = document.documentElement.lang === 'mn';

    /* ---------------------------------------------------------------
       –§–ê–ô–õ–´–ù –¢–£–°–õ–ê–• –§–£–ù–ö–¶“Æ“Æ–î
       --------------------------------------------------------------- */

    /* URL/path-–æ–æ—Å –∑”©–≤—Ö”©–Ω —Ñ–∞–π–ª—ã–Ω –Ω—ç—Ä–∏–π–≥ —Å–∞–ª–≥–∞–∂ –∞–≤–Ω–∞ */
    function getBasename(url) {
        return url.split(/.*[\/|\\]/)[1];
    }

    /* –ë–∞–π—Ç—ã–Ω —Ö—ç–º–∂—ç—ç–≥ KB/MB/GB –±–æ–ª–≥–æ–Ω —Ö”©—Ä–≤“Ø“Ø–ª—ç—Ö */
    function formatSizeUnits(bytes) {
        const thresh = 1024;
        if (Math.abs(bytes) < thresh) {
            return bytes + 'b';
        }

        const units = ['kb', 'mb', 'gb', 'tb'];
        let u = -1;
        const r = 10 ** 1;

        do {
            bytes /= thresh;
            ++u;
        } while (
            Math.round(Math.abs(bytes) * r) / r >= thresh &&
            u < units.length - 1
        );

        return bytes.toFixed(1) + units[u];
    }

    /* HTML-–¥ –æ—Ä–æ—Ö —Ç–µ–∫—Å—Ç–∏–π–≥ escape–ª–∞—Ö (XSS-—ç—ç—Å —Ö–∞–º–≥–∞–∞–ª–Ω–∞) */
    function escapeStr(s) {
        let lookup = {
            '&': "&amp;",
            '"': "&quot;",
            '\'': "&apos;",
            '<': "&lt;",
            '>': "&gt;"
        };
        return s.replace(/[&"'<>]/g, c => lookup[c]);
    }

    /* üñº Custom image preview (Fancybox-–∏–π–Ω –æ—Ä–æ–Ω–¥)
       ------------------------------------------------------------ */
    function openFilePreview(src, caption, type) {
        const overlay = document.createElement('div');
        overlay.className = 'image-preview-overlay';

        let content = '';
        if (type === 'video') {
            content = `<video src="${src}" controls autoplay></video>`;
        } else if (type === 'audio') {
            content = `<audio src="${src}" controls autoplay></audio>`;
        } else if (type === 'pdf') {
            content = `<iframe src="${src}"></iframe>`;
        } else if (type === 'text') {
            content = `<pre>${_mn ? '–ê—á–∞–∞–ª–∂ –±–∞–π–Ω–∞...' : 'Loading...'}</pre>`;
        } else {
            content = `<img src="${src}" alt="">`;
        }

        overlay.innerHTML = `
            <span class="preview-close">&times;</span>
            ${content}
            ${caption ? `<div class="preview-caption">${caption}</div>` : ''}
        `;

        document.body.appendChild(overlay);
        document.body.style.overflow = 'hidden';

        if (type === 'text') {
            fetch(src)
                .then(res => res.text())
                .then(text => {
                    const pre = overlay.querySelector('pre');
                    if (pre) pre.textContent = text;
                })
                .catch(() => {
                    const pre = overlay.querySelector('pre');
                    if (pre) pre.textContent = _mn ? '–§–∞–π–ª—ã–Ω –∞–≥—É—É–ª–≥—ã–≥ –∞—á–∞–∞–ª–∂ —á–∞–¥—Å–∞–Ω–≥“Ø–π.' : 'Failed to load file content.';
                });
        }

        const close = () => {
            overlay.remove();
            document.body.style.overflow = '';
        };

        overlay.querySelector('.preview-close').addEventListener('click', close);
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) close();
        });

        const onKey = (e) => {
            if (e.key === 'Escape') {
                close();
                document.removeEventListener('keydown', onKey);
            }
        };
        document.addEventListener('keydown', onKey);
    }

    /* ---------------------------------------------------------------
       DOCUMENT READY - JS –∞–∂–∏–ª–ª–∞–≥–∞–∞ —ç–Ω–¥—ç—ç—Å —ç—Ö—ç–ª–Ω—ç
       --------------------------------------------------------------- */
    document.addEventListener('DOMContentLoaded', function () {
        /* üåê –•—ç–ª–Ω–∏–π toggle */
        if (!_mn) {
            document.querySelectorAll('.lang-mn').forEach(el => el.hidden = true);
            document.querySelectorAll('.lang-en').forEach(el => el.hidden = false);
        }

        /* Modal –Ω—ç—ç—Ö—ç–¥ –∞—à–∏–≥–ª–∞–≥–¥–∞—Ö files-link */
        const filesLink = `{{ 'files-modal'|link({'table': table}) }}`;

        /* motable.append - –Ω—ç–≥ file object-–≥ —Ö“Ø—Å–Ω—ç–≥—Ç—ç–¥ –Ω—ç–º—ç—Ö */
        motable.prototype.append = function (file) {
            /* –§–∞–π–ª—ã–Ω thumbnail/icon */
            let fileIcon;

            /* –§–∞–π–ª—ã–Ω –Ω—ç—Ä (basename) + HTML escape */
            let fileName = escapeStr(decodeURIComponent(getBasename(file['path'])));

            /* –§–∞–π–ª –Ω—ç—ç—Ö “Ø–µ–¥ —Ö–∞—Ä–∞–≥–¥–∞—Ö default behaviour */
            let fileLinkAttr =
                `target="__blank" onclick="return confirm('${_mn ? `–¢–∞ [${fileName}] —Ñ–∞–π–ª—ã–≥ –Ω—ç—ç—Ö–¥—ç—ç –∏—Ç–≥—ç–ª—Ç—ç–π –±–∞–π–Ω–∞ —É—É?` : `Are you sure you want to open this file [${fileName}]?`}')"`;


            /* Modal ‚Üí code tag —Ö—ç—Å—ç–≥ —Ä“Ø“Ø –∏–ª–≥—ç—ç—Ö –ª–∏–Ω–∫ */
            let fileAction = `
                <a class="btn btn-sm btn-dark ajax-modal"
                   data-bs-target="#static-modal"
                   data-bs-toggle="modal"
                   href="${filesLink}?modal=${file['type']}-tag&id=${file['id']}">
                    <i class="bi bi-code"></i>
                </a>
            `;

            /* –§–∞–π–ª—ã–Ω —Ç”©—Ä–ª”©”©—Å —Ö–∞–º–∞–∞—Ä—Å–∞–Ω —Ö–∞—Ä–∞–≥–¥–∞—Ö preview */
            switch (file['type']) {
                /* ----------------- IMAGE ----------------- */
                case 'image': {
                    fileIcon =
                        `<img src="${file['path']}"
                              style="max-height:7.5rem;max-width:20rem;height:100%">`;

                    const caption = file['description']
                        ? escapeStr(file['description'])
                        : fileName;
                    fileLinkAttr = `data-preview="image" data-caption="${caption}"`;
                }
                break;

                /* ----------------- VIDEO ----------------- */
                case 'video': {
                    fileIcon = `
                        <video style="max-height:15rem;height:100%;max-width:20rem;width:100%" controls>
                            <source src="${file['path']}">
                        </video>`;

                    const caption = file['description']
                        ? escapeStr(file['description'])
                        : fileName;
                    fileLinkAttr = `data-preview="video" data-caption="${caption}"`;
                }
                break;

                /* ----------------- AUDIO ----------------- */
                case 'audio': {
                    fileIcon = `
                        <audio controls>
                            <source src="${file['path']}" type="${file['mime_content_type']}">
                        </audio>`;

                    const caption = file['description']
                        ? escapeStr(file['description'])
                        : fileName;
                    fileLinkAttr = `data-preview="audio" data-caption="${caption}"`;
                }
                break;

                /* ----------------- OTHER ----------------- */
                default:
                    fileIcon = '<i class="bi bi-hdd"></i>';
                    fileAction = '';

                    const mime = file['mime_content_type'];

                    if (mime === 'application/pdf') {
                        /* PDF —Ñ–∞–π–ª—ã–≥ browser-–¥ —à—É—É–¥ preview —Ö–∏–π—Ö */
                        fileIcon = '<i class="bi bi-file-earmark-pdf" style="font-size:2rem;color:#dc3545"></i>';
                        const caption = file['description']
                            ? escapeStr(file['description'])
                            : fileName;
                        fileLinkAttr = `data-preview="pdf" data-caption="${caption}"`;
                    } else if (mime === 'text/plain' || mime === 'application/json' || mime === 'text/xml' || mime === 'application/xml') {
                        /* Text —Ñ–∞–π–ª—ã–≥ fetch —Ö–∏–π–∂ overlay –¥—ç—ç—Ä —Ö–∞—Ä—É—É–ª–∞—Ö */
                        fileIcon = '<i class="bi bi-file-earmark-text" style="font-size:2rem"></i>';
                        const caption = file['description']
                            ? escapeStr(file['description'])
                            : fileName;
                        fileLinkAttr = `data-preview="text" data-caption="${caption}"`;
                    }
                    break;
            }

            /* –§–∞–π–ª—ã–Ω –±–∞–π—Ä—à–ª—ã–Ω modal —Ä—É—É —á–∏–≥–ª“Ø“Ø–ª—ç—Ö –ª–∏–Ω–∫ */
            fileAction =
                `<a class="btn btn-sm btn-info ajax-modal"
                    data-bs-target="#static-modal" data-bs-toggle="modal"
                    href="${filesLink}?modal=location&id=${file['id']}">
                    <i class="bi bi-link"></i>
                  </a>${fileAction}`;

            /* –§–∞–π–ª—ã–Ω —Ö–∞—Ä–∞–≥–¥–∞—Ö –±–ª–æ–∫ (thumbnail + –Ω—ç—Ä + “Ø–π–ª–¥–ª“Ø“Ø–¥) */
            let fileFigure = `
                <a href="${file['path']}" ${fileLinkAttr}>
                    ${fileIcon}
                    <span style="display:block">${fileName}</span>
                </a>
                ${fileAction}
            `;

            /* –•“Ø—Å–Ω—ç–≥—Ç–∏–π–Ω –º”©—Ä (<tr>) –±–æ–ª–æ–Ω –±–∞–≥–∞–Ω—É—É–¥ (<td>) “Ø“Ø—Å–≥—ç—Ö */
            let row = document.createElement('tr');
            row.id = `file_${file['id']}`;
            row.style.fontSize = '.875rem';

            /* 1-—Ä –±–∞–≥–∞–Ω–∞ - preview + action */
            let cell1 = document.createElement('td');
            cell1.innerHTML =
                `<input name="files[]" value="${file['id']}" type="hidden">
                 ${fileFigure}`;
            row.appendChild(cell1);

            /* 2-—Ä –±–∞–≥–∞–Ω–∞ - MIME —Ç”©—Ä”©–ª + —Ñ–∞–π–ª —Ö—ç–º–∂—ç—ç */
            let cell2 = document.createElement('td');
            cell2.innerHTML = `
                <p style="max-width:11.25rem;word-wrap:break-all">
                    <u>${file['mime_content_type']}</u>
                </p>
                ${formatSizeUnits(file['size'])}`;
            row.appendChild(cell2);

            /* 3-—Ä –±–∞–≥–∞–Ω–∞ - description */
            let cell3 = document.createElement('td');
            cell3.innerHTML = file['description'] ?? '';
            row.appendChild(cell3);

            /* 4-—Ä –±–∞–≥–∞–Ω–∞ - keyword */
            let cell4 = document.createElement('td');
            cell4.innerHTML = file['keyword'] ?? '';
            row.appendChild(cell4);

            /* 5-—Ä –±–∞–≥–∞–Ω–∞ - created_at */
            let cell5 = document.createElement('td');
            cell5.innerHTML = file['created_at'] ?? '';
            row.appendChild(cell5);

            /* tbody –±–∞–π—Ö–≥“Ø–π –±–æ–ª —à–∏–Ω—ç—ç—Ä “Ø“Ø—Å–≥—ç–Ω—ç */
            let tBody = this.table.querySelector('tbody');
            if (!tBody) {
                tBody = document.createElement('tbody');
                this.table.appendChild(tBody);

                /* motable ‚Üí tbody-–¥ ”©–≥—Å”©–Ω custom style –±–∞–π–≤–∞–ª —Ö—ç—Ä—ç–≥–ª—ç—Ö */
                if (this.options.style.tbody) {
                    tBody.style.cssText = this.options.style.tbody;
                }
            }

            /* –ë—ç–ª–¥—Å—ç–Ω file row-–≥ append —Ö–∏–π–µ */
            tBody.appendChild(row);

            /* .ajax-modal –∫–ª–∞—Å—Å –±“Ø—Ö–∏–π –±“Ø—Ö action —Ç–æ–≤—á –¥—ç—ç—Ä modal –Ω—ç—ç—Ö */
            let rowModals = row.querySelectorAll('.ajax-modal');
            rowModals.forEach(a =>
                a.addEventListener('click', function (e) {
                    e.preventDefault();
                    ajaxModal(a);
                })
            );

            /* üñº data-preview attribute –±“Ø—Ö–∏–π –∑—É—Ä–∞–≥—Ç click handler –Ω—ç–º—ç—Ö */
            const previewLink = row.querySelector('[data-preview]');
            if (previewLink) {
                previewLink.addEventListener('click', function (e) {
                    e.preventDefault();
                    openFilePreview(this.href, this.dataset.caption || '', this.dataset.preview);
                });
            }
        };

        /* motable instance “Ø“Ø—Å–≥—ç–∂ –±–∞–π–Ω–∞ */
        const files = new motable(
            'table#files',
            { freezeColumns: [0] } /* 1-—Ä –±–∞–≥–∞–Ω—ã–≥ –Ω–∞–∞–ª—Ç—Ç–∞–π –±–æ–ª–≥–æ—Ö */
        );

        /* –§–∞–π–ª—ã–Ω –∂–∞–≥—Å–∞–∞–ª—Ç—ã–≥ backend-—ç—ç—Å AJAX-—Ä —Ç–∞—Ç–∞—Ö */
        fetch(`{{ 'files-list'|link({'table': table}) }}`)
            .then(res => {
                const contentType = res.headers.get('content-type') || '';
                if (contentType.includes('application/json')) return res.json();

                throw new Error(`HTTP [${res.status}]: ${res.statusText}`);
            })
            .then(data => {
                if (!data.list) {
                    throw new Error(data.message ?? 'Invalid response!');
                }

                /* –ñ–∞–≥—Å–∞–∞–ª—Ç—ã–Ω file –±“Ø—Ä–∏–π–≥ motable.append() –∞—à–∏–≥–ª–∞–Ω —Ö“Ø—Å–Ω—ç–≥—Ç—ç–¥ –Ω—ç–º—ç—Ö */
                data.list.forEach(file => files.append(file));

                /* motable table-–≥ –∞–∂–∏–ª–¥ –±—ç–ª—ç–Ω –±–æ–ª–≥–æ—Ö */
                files.setReady();
            })
            .catch(err => {
                files.error(err);
            });
    });
</script>

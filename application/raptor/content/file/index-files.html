<!-- SweetAlert2 —Å–∞–Ω - —Ñ–∞–π–ª—ã–≥ –∏–¥—ç–≤—Ö–≥“Ø–π –±–æ–ª–≥–æ—Ö –∑—ç—Ä—ç–≥ “Ø–π–ª–¥–ª–∏–π–Ω “Ø–µ–¥ –≥–æ—ë–º—Å–æ–≥ alert —Ö–∞—Ä—É—É–ª–∞—Ö–∞–¥ –∞—à–∏–≥–ª–∞–Ω–∞ -->
<script defer src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Plupload - –æ–ª–æ–Ω —Ç”©—Ä–ª–∏–π–Ω browser/runtime –¥—ç—ç—Ä —Ñ–∞–π–ª—ã–≥ upload —Ö–∏–π—Ö—ç–¥ –∞—à–∏–≥–ª–∞—Ö JS —Å–∞–Ω -->
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/plupload/3.1.5/plupload.full.min.js" integrity="sha512-yLlgKhLJjLhTYMuClLJ8GGEzwSCn/uwigfXug5Wf2uU5UdOtA8WRSMJHJcZ+mHgHmNY+lDc/Sfp86IT9hve0Rg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<!-- Fancybox - –∑—É—Ä–∞–≥ –±–æ–ª–æ–Ω –º–µ–¥–∏–∞ —Ñ–∞–π–ª—É—É–¥—ã–≥ modal lightbox —Ö—ç–ª–±—ç—Ä—ç—ç—Ä —Ç–æ–º—Ä—É—É–ª–∂ —Ö–∞—Ä–∞—Ö–∞–¥ –∞—à–∏–≥–ª–∞–Ω–∞ -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css">
<script defer src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js"></script>

<!--
    –î—ç—ç–¥ —Ç–∞–ª—ã–Ω callout —Ö—ç—Å—ç–≥ -
    –ú—ç–¥—ç—ç–ª–ª–∏–π–Ω —Å–∞–Ω–¥ –±“Ø—Ä—Ç–≥—ç–≥–¥—Å—ç–Ω –±“Ø—Ö —Ñ–∞–π–ª—ã–Ω –µ—Ä”©–Ω—Ö–∏–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫ –º—ç–¥—ç—ç–ª—ç–ª (—Ö—ç–¥—ç–Ω —Ö“Ø—Å–Ω—ç–≥—Ç, —Ö—ç–¥—ç–Ω —Ñ–∞–π–ª, –Ω–∏–π—Ç —Ö—ç–º–∂—ç—ç)
    –º”©–Ω —Ñ–∞–π–ª —Ö–∞–¥–≥–∞–ª–∂ –±—É–π –±“Ø—Ö —Ö“Ø—Å–Ω—ç–≥—Ç–∏–π–≥ –ª–∏–Ω–∫ —Ö—ç–ª–±—ç—Ä—ç—ç—Ä —Ö–∞—Ä—É—É–ª–Ω–∞.
-->
<div class="bd-callout bd-callout-dark text-bg-light alert alert-dismissible fade show shadow-sm">
    <span class="d-block mb-2">
        <i class="bi bi-folder-fill"></i>
        –ú—ç–¥—ç—ç–ª–ª–∏–π–Ω —Å–∞–Ω–¥ –Ω–∏–π—Ç
        <strong>{{ total['tables'] }}</strong>
        —Ö“Ø—Å–Ω—ç–≥—Ç—ç–¥
        <strong>{{ total['rows'] }}</strong>
        —à–∏—Ä—Ö—ç–≥ —Ñ–∞–π–ª —Ö–∞—Ç—É—É –¥–∏—Å–∫–Ω–∏–π
        <strong>{{ total['sizes'] }}</strong>
        —Ö—ç–º–∂—ç—ç–≥ —ç–∑—ç–ª—Å—ç–Ω –±–∞–π–Ω–∞.
    </span>
    {% for name,info in tables %}
        <!-- –•“Ø—Å–Ω—ç–≥—Ç –±“Ø—Ä –¥—ç—ç—Ä –¥–∞—Ä–∂ —Ç—É—Ö–∞–π–Ω —Ö“Ø—Å–Ω—ç–≥—Ç–∏–π–Ω —Ñ–∞–π–ª—ã–Ω –∂–∞–≥—Å–∞–∞–ª—Ç—ã–≥ (files?table=name) –Ω—ç—ç–∂ —Ö–∞—Ä–Ω–∞ -->
        <span class="d-inline-block ps-3">
            [<a class="badge bg-primary" href="{{ 'files'|link }}?table={{ name|e }}">
                <strong>{{ name }}</strong>: {{ info['count'] ~ ' -> ' ~ info['size'] }}
            </a>]
        </span>
    {% else %}
        –º—ç–¥—ç—ç–ª—ç–ª –æ–ª–¥—Å–æ–Ω–≥“Ø–π
    {% endfor %}
</div>

<!--
    –°–æ–Ω–≥–æ–≥–¥—Å–æ–Ω files table-–∏–π–Ω –≥–∞—Ä—á–∏–≥.
    –ñ–∏—à—ç—ç –Ω—å: files, pages_files –≥—ç—Ö –º—ç—Ç - {{ table }} —Ö—É–≤—å—Å–∞–≥—á–∏–π–≥ capitalize —Ö–∏–π–∂ —Ö–∞—Ä—É—É–ª–Ω–∞.
-->
<div class="d-flex flex-wrap justify-content-between align-items-center rounded p-1 mb-2 shadow">
    <h3 class="px-2 my-auto text-danger">
        <i class="bi bi-folder"></i> {{ table|capitalize }}
    </h3>
</div>

<!--
    Plupload init –∞–º–∂–∏–ª—Ç–≥“Ø–π –±–æ–ª–≤–æ–ª (—Ö—É—É—á–∏–Ω browser, Silverlight/HTML5 –¥—ç–º–∂–¥—ç–≥–≥“Ø–π “Ø–µ–¥) —Ö–∞—Ä–∞–≥–¥–∞—Ö fallback –º–µ—Å—Å–µ–∂.
    –î–∞—Ä–∞–∞ –Ω—å JS-—ç—ç—Ä filelist —ç–ª–µ–º–µ–Ω—Ç–∏–π–Ω –∞–≥—É—É–ª–≥—ã–≥ —Ö–æ–æ—Å–æ–ª–∂, upload —è–≤—Ü—ã–Ω log-–≥ —ç–Ω–¥ —Ö–∞—Ä—É—É–ª–Ω–∞.
-->
<div class="row text-danger mb-2">
    <div class="col-12" id="filelist">
        Your browser doesn't have Silverlight or HTML5 support.
    </div>
</div>

<!--
    –§–∞–π–ª —Å–æ–Ω–≥–æ—Ö, upload —Ö–∏–π—Ö —Ç–æ–≤—á–Ω—É—É–¥ - Plupload-–∏–π–Ω container.
    pickfiles ‚Üí —Ñ–∞–π–ª —Å–æ–Ω–≥–æ—Ö
    uploadfiles ‚Üí —Å–æ–Ω–≥–æ—Å–æ–Ω —Ñ–∞–π–ª—É—É–¥—ã–≥ —Å–µ—Ä–≤–µ—Ä —Ä“Ø“Ø upload —Ö–∏–π—Ö
-->
<div class="row">
    <div id="container">
        <button class="btn btn-sm btn-warning shadow-sm" id="pickfiles" type="button">
            {{ 'select-files'|text }}
        </button>
        <button class="btn btn-sm btn-secondary shadow-sm" id="uploadfiles" disabled type="button">
            {{ 'upload-files'|text }}
        </button>
    </div>
</div>

<!--
    –§–∞–π–ª—ã–Ω –∂–∞–≥—Å–∞–∞–ª—Ç—ã–Ω —Ö“Ø—Å–Ω—ç–≥—Ç.
    JS (motable) –¥—ç—ç—Ä—ç—ç—Å AJAX-—Ä data –∞–≤—á tbody-–≥ –¥–∏–Ω–∞–º–∏–∫–∞–∞—Ä “Ø“Ø—Å–≥—ç–Ω—ç.
    –≠–Ω–¥ –∑”©–≤—Ö”©–Ω —Ö“Ø—Å–Ω—ç–≥—Ç–∏–π–Ω —Ç–æ–ª–≥–æ–π —Ö—ç—Å–≥–∏–π–≥ (thead) ”©—Ä–≥”©–Ω”©.
-->
<table class="table table-sm table-bordered table-striped table-hover" id="files">
    <thead>
        <tr>
            <!-- –§–∞–π–ª—ã–Ω –Ω—ç—Ä, thumbnail, “Ø–π–ª–¥–ª–∏–π–Ω —Ç–æ–≤—á–Ω—É—É–¥ (link, tag, update, delete) -->
            <th scope="col">{{ 'file'|text }}</th>
            <!-- MIME —Ç”©—Ä”©–ª, —Ö—ç–º–∂—ç—ç –∑—ç—Ä—ç–≥ —Ç–µ—Ö–Ω–∏–∫–∏–π–Ω —à–∏–Ω–∂ —á–∞–Ω–∞—Ä -->
            <th scope="col">{{ 'properties'|text }}</th>
            <!-- –§–∞–π–ª—ã–Ω —Ç–∞–π–ª–±–∞—Ä - —Ö—ç—Ä—ç–≥–ª—ç–≥—á–∏–π–Ω –æ—Ä—É—É–ª—Å–∞–Ω description -->
            <th scope="col">{{ 'description'|text }}</th>
            <!-- –§–∞–π–ª—ã–Ω –∞–Ω–≥–∏–ª–∞–ª (category) -->
            <th scope="col">{{ 'category'|text }}</th>
            <!-- –§–∞–π–ª—ã–≥ keyword-–æ–æ—Ä —à“Ø“Ø—Ö, —Ö–∞–π—Ö–∞–¥ –∑–æ—Ä–∏—É–ª–∞–≥–¥—Å–∞–Ω —Ç“Ø–ª—Ö“Ø“Ø—Ä “Ø–≥ -->
            <th scope="col">{{ 'keyword'|text }}</th>
            <!-- “Æ“Ø—Å–≥—ç—Å—ç–Ω –æ–≥–Ω–æ–æ / created_at -->
            <th scope="col">{{ 'date'|text }}</th>
        </tr>
    </thead>
</table>

<script type="text/javascript">
    /* üß© HELPER FUNCTIONS
       ------------------------------------------------------------
       –§–∞–π–ª—ã–Ω –Ω—ç—Ä —Å–∞–ª–≥–∞—Ö, —Ö—ç–º–∂—ç—ç —Ñ–æ—Ä–º–∞—Ç–ª–∞—Ö, HTML escape —Ö–∏–π—Ö –º—ç—Ç
       –∂–∏–∂–∏–≥ —Ç—É—Å–ª–∞—Ö —Ñ—É–Ω–∫—Ü—É—É–¥ —ç–Ω–¥ –±–∞–π–Ω–∞. */
    
    /* URL —ç—Å–≤—ç–ª path-–æ–æ—Å –∑”©–≤—Ö”©–Ω —Ñ–∞–π–ª—ã–Ω –Ω—ç—Ä–∏–π–≥ —Å–∞–ª–≥–∞–∂ –∞–≤–∞—Ö */
    function getBasename(url) {
        return url.split(/.*[\/|\\]/)[1];
    }

    /* –ë–∞–π—Ç—ã–Ω —Ö—ç–º–∂—ç—ç–≥ kb, mb, gb ... –±–æ–ª–≥–æ–Ω —Ö”©—Ä–≤“Ø“Ø–ª—ç—Ö */
    function formatSizeUnits(bytes) {
        const thresh = 1024;
        if (Math.abs(bytes) < thresh) {
            return `${bytes}b`;
        }

        const units = ['kb', 'mb', 'gb', 'tb'];
        let u = -1;
        const r = 10 ** 1;
        do {
            bytes /= thresh;
            ++u;
        } while (Math.round(Math.abs(bytes) * r) / r >= thresh && u < units.length - 1);
        
        return `${bytes.toFixed(1)}${units[u]}`;
    }

    /* HTML-—Ç—ç–π —Ö–æ–ª–±–æ–≥–¥–æ—Ö –∞—é—É–ª–≥“Ø–π –±–∞–π–¥–ª—ã–Ω “Ø“Ø–¥–Ω—ç—ç—Å —ç–Ω–≥–∏–π–Ω escape */
    function escapeStr(s) {
        const lookup = {
            '&': "&amp;",
            '"': "&quot;",
            "'": "&apos;",
            '<': "&lt;",
            '>': "&gt;"
        };
        return s.replace(/[&"'<>]/g, c => lookup[c]);
    }

    /* üìå DOMContentLoaded - –ë“Ø—Ö JS —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å —ç–Ω–¥—ç—ç—Å —ç—Ö—ç–ª–Ω—ç
       -------------------------------------------------------------------
       –≠–Ω—ç –¥–æ—Ç–æ—Ä:
         ‚Ä¢ motable-–∏–π–Ω append override —Ö–∏–π—Ö
         ‚Ä¢ —Ñ–∞–π–ª—ã–Ω –∂–∞–≥—Å–∞–∞–ª—Ç—ã–≥ server-—ç—ç—Å fetch —Ö–∏–π—Ö
         ‚Ä¢ deactivate –∞–∂–∏–ª–ª–∞–≥–∞–∞–≥ —Ç–æ—Ö–∏—Ä—É—É–ª–∞—Ö
         ‚Ä¢ plupload uploader-–∏–π–≥ —ç—Ö–ª“Ø“Ø–ª—ç—Ö
       ------------------------------------------------------------------- */
    document.addEventListener('DOMContentLoaded', function () {
        /* –§–∞–π–ª—ã–Ω modal –Ω—ç—ç—Ö –ª–∏–Ω–∫ - TWIG-—ç—ç—Å –∏—Ä–Ω—ç */
        const filesModalLink = `{{ 'files-modal'|link({'table': table}) }}`;

        /* –•—ç—Ä—ç–≥–ª—ç–≥—á –∑–∞—Å–≤–∞—Ä–ª–∞—Ö —ç—Ä—Ö—Ç—ç–π —ç—Å—ç—Ö */
        const userCanUpdate = `{{ user.can('system_content_update') ? 'true' : '' }}`;

        /* –•—ç—Ä—ç–≥–ª—ç–≥—á —É—Å—Ç–≥–∞—Ö —ç—Ä—Ö—Ç—ç–π —ç—Å—ç—Ö */
        const userCanDelete = `{{ user.can('system_content_delete') ? 'true' : '' }}`;

        /* motable.prototype.append - —Å–µ—Ä–≤–µ—Ä—ç—ç—Å –∏—Ä—Å—ç–Ω –Ω—ç–≥ file object –±–∏—á–ª—ç–≥–∏–π–≥
           —Ö“Ø—Å–Ω—ç–≥—Ç—ç–¥ (table) <tr> —Ö—ç–ª–±—ç—Ä—ç—ç—Ä –Ω—ç–º—ç—Ö —Ñ—É–Ω–∫—Ü.
           -------------------------------------------------------------------
           –≠–Ω—ç —Ñ—É–Ω–∫—Ü:
             ‚Ä¢ –§–∞–π–ª—ã–Ω thumbnail / icon “Ø“Ø—Å–≥—ç–Ω—ç
             ‚Ä¢ Modal –Ω—ç—ç—Ö action —Ç–æ–≤—á–Ω—É—É–¥ “Ø“Ø—Å–≥—ç–Ω—ç
             ‚Ä¢ UPDATE, DELETE —ç—Ä—Ö“Ø“Ø–¥–∏–π–≥ —à–∞–ª–≥–∞–Ω–∞
             ‚Ä¢ Fancybox –±–æ–ª–æ–Ω modal —Ö–æ–ª–±–æ–æ—Å—É—É–¥—ã–≥ –∞–≤—Ç–æ–º–∞—Ç–∞–∞—Ä –±—ç—Ö–∂“Ø“Ø–ª–Ω—ç */
        motable.prototype.append = function (file) {
            /* üìå –§–∞–π–ª—ã–Ω —Ç”©—Ä”©–ª–¥ —Ç–æ—Ö–∏—Ä—Å–æ–Ω icon/preview —Ç–æ–¥–æ—Ä—Ö–æ–π–ª–æ—Ö */
            let fileIcon = '';
            const fileName = escapeStr(getBasename(file['path']));

            /* default link attribute - —Ñ–∞–π–ª –Ω—ç—ç—Ö “Ø–µ–¥ confirm –∞—Å—É—É–Ω–∞ */
            let fileLinkAttr =
                `target="__blank" onclick="return confirm('Are you sure you want to open this file [${fileName}]?')"`;

            /* –§–∞–π–ª—ã–Ω —Ç”©—Ä”©–ª–¥ —Å—É—É—Ä–∏–ª—Å–∞–Ω modal action (code tag –≥—ç—Ö –º—ç—Ç) */
            let fileAction = `
                <a class="btn btn-sm btn-dark ajax-modal"
                    data-bs-target="#static-modal" data-bs-toggle="modal"
                    href="${filesModalLink}?modal=${file['type']}-tag&id=${file['id']}">
                    <i class="bi bi-code"></i>
                </a>`;

            if (file['type'] === 'image') {
                /* üì∑ IMAGE file preview */
                fileIcon =
                    `<img src="${file['path']}" style="max-height:7.5rem; max-width:20rem; height:100%">`;

                /* GIF-—ç—ç—Å –±—É—Å–∞–¥ –∑—É—Ä–∞–≥—Ç fancybox —Ö—ç—Ä—ç–≥–ª—ç–Ω—ç */
                if (file['mime_content_type'] !== 'image/gif') {
                    const caption = file['description']
                        ? escapeStr(file['description'])
                        : fileName;
                    fileLinkAttr = `file-data-fancybox data-caption="${caption}"`;
                }
            } else if (file['type'] === 'video') {
                /* üé• VIDEO preview */
                fileIcon = `
                    <video style="max-height:15rem; height:100%; max-width:20rem; width:100%" controls>
                        <source src="${file['path']}">
                    </video>`;
            } else if (file['type'] === 'audio') {
                /* üéµ AUDIO preview */
                fileIcon = `
                    <audio controls>
                        <source src="${file['path']}" type="${file['mime_content_type']}">
                    </audio>`;
            } else {
                /* üóÑ OTHER file types (doc, zip, pdf...) */
                fileIcon = '<i class="bi bi-hdd"></i>';
                fileAction = ''; /* code tag modal-—ã–≥ –Ω—É—É—Ö */
            }

            /* Location modal (path —Ö–∞—Ä–∞—Ö / —Ö—É—É–ª–±–∞—Ä –∞–≤–∞—Ö) */
            fileAction = `
                <a class="btn btn-sm btn-info ajax-modal"
                    data-bs-target="#static-modal" data-bs-toggle="modal"
                    href="${filesModalLink}?modal=location&id=${file['id']}">
                    <i class="bi bi-link"></i>
                </a>
                ${fileAction}
            `;

            /* Update modal (–∑–∞—Å–≤–∞—Ä–ª–∞—Ö —ç—Ä—Ö—Ç—ç–π –±–æ–ª) */
            if (userCanUpdate) {
                fileAction += `
                    <a class="btn btn-sm btn-primary shadow-sm ajax-modal"
                        data-bs-target="#static-modal" data-bs-toggle="modal"
                        href="${filesModalLink}?modal=files-update&id=${file['id']}">
                        <i class="bi bi-pencil-square"></i>
                    </a>`;
            }

            /* Delete (deactivate) button (—É—Å—Ç–≥–∞—Ö —ç—Ä—Ö—Ç—ç–π –±–æ–ª) */
            if (userCanDelete) {
                fileAction += `
                    <button class="deactivate-file btn btn-sm btn-danger shadow-sm"
                        value="${file['id']}" type="button">
                        <i class="bi bi-trash"></i>
                    </button>`;
            }

            /* FILE + NAME + ACTIONS –•–û–õ–ë–û–ñ –ë–õ–û–ö “Æ“Æ–°–ì–≠–• */
            let fileFigure = `
                <a href="${file['path']}" ${fileLinkAttr}>
                    ${fileIcon}
                    <span style="display:block">${fileName}</span>
                </a>
                ${fileAction}
            `;

            /* üß± <tr> –º”©—Ä –±–æ–ª–æ–Ω <td> –Ω“Ø–¥–Ω“Ø“Ø–¥–∏–π–≥ “Ø“Ø—Å–≥—ç—Ö */
            const row = document.createElement('tr');
            row.id = `file_${file['id']}`;
            row.style.fontSize = '.875rem';

            /* üìå 1-—Ä –±–∞–≥–∞–Ω–∞: thumbnail + “Ø–π–ª–¥–ª“Ø“Ø–¥ */
            const cell1 = document.createElement('td');
            cell1.innerHTML =
                `<input name="files[]" value="${file['id']}" type="hidden">
                 ${fileFigure}`;
            row.appendChild(cell1);

            /* üìå 2-—Ä –±–∞–≥–∞–Ω–∞: MIME —Ç”©—Ä”©–ª + —Ö—ç–º–∂—ç—ç */
            const cell2 = document.createElement('td');
            cell2.innerHTML = `
                <p style="max-width:11.25rem; word-wrap:break-all">
                    <u>${file['mime_content_type']}</u>
                </p>
                ${formatSizeUnits(file['size'])}`;
            row.appendChild(cell2);

            /* üìå 3-—Ä –±–∞–≥–∞–Ω–∞ - description */
            const cell3 = document.createElement('td');
            cell3.innerHTML = file['description'] ?? '';
            row.appendChild(cell3);

            /* üìå 4-—Ä –±–∞–≥–∞–Ω–∞ - category */
            const cell4 = document.createElement('td');
            cell4.innerHTML = file['category'] ?? '';
            row.appendChild(cell4);

            /* üìå 5-—Ä –±–∞–≥–∞–Ω–∞ - keyword */
            const cell5 = document.createElement('td');
            cell5.innerHTML = file['keyword'] ?? '';
            row.appendChild(cell5);

            /* üìå 6-—Ä –±–∞–≥–∞–Ω–∞ - created_at */
            const cell6 = document.createElement('td');
            cell6.innerHTML = file['created_at'] ?? '';
            row.appendChild(cell6);

            let tBody = this.table.querySelector('tbody');
            /* üß© tbody –±–∞–π—Ö–≥“Ø–π –±–æ–ª “Ø“Ø—Å–≥—ç–Ω—ç */
            if (!tBody) {
                tBody = document.createElement('tbody');
                this.table.appendChild(tBody);

                /* motable —Ç–æ—Ö–∏—Ä–≥–æ–æ–Ω–¥ tbody-–≥–∏–π–Ω custom style –±–∞–π—Å–∞–Ω –±–æ–ª –∞—à–∏–≥–ª–∞–Ω–∞ */
                if (this.options.style.tbody) {
                    tBody.style.cssText = this.options.style.tbody;
                }
            }
            
            /* –ë—ç–ª–¥—Å—ç–Ω file row-–≥ append —Ö–∏–π–µ */
            tBody.appendChild(row);

            /* ü™ü Modal –Ω—ç—ç–¥—ç–≥ –±“Ø—Ö .ajax-modal –ª–∏–Ω–∫ –¥—ç—ç—Ä click handler –Ω—ç–º—ç—Ö */
            const rowModals = row.querySelectorAll('.ajax-modal');
            rowModals.forEach(a => a.addEventListener('click', function (e) {
                e.preventDefault();
                ajaxModal(a);
            }));

            const thisTable = this; /* motable instance —Ö–∞–¥–≥–∞–ª–∞—Ö */
            
            /* üóë –§–ê–ô–õ–´–ù –ë–ò–ß–õ–≠–ì–ò–ô–ì –ò–î–≠–í–•–ì“Æ–ô –ë–û–õ–ì–û–• (Soft Delete)
               -------------------------------------------------------------------
               –≠–Ω—ç —Ö—ç—Å—ç–≥ deactivate-file —Ç–æ–≤—á –¥—ç—ç—Ä –¥–∞—Ä—Å–Ω–∞–∞—Ä:
                 ‚Ä¢ –ó—É—Ä–≥–∏–π–Ω thumbnail / icon –±“Ø—Ö–∏–π –±–∞—Ç–∞–ª–≥–∞–∞–∂—É—É–ª–∞—Ö modal –≥–∞—Ä–≥–∞–Ω–∞
                 ‚Ä¢ –•—ç—Ä—ç–≥–ª—ç–≥—á OK –¥–∞—Ä–≤–∞–ª DELETE fetch API —É—Ä—É—É —Ö“Ø—Å—ç–ª—Ç –∏–ª–≥—ç—ç–Ω—ç
                 ‚Ä¢ –ê–º–∂–∏–ª—Ç—Ç–∞–π –±–æ–ª —Ö“Ø—Å–Ω—ç–≥—Ç—ç—ç—Å —Ç—É—Ö–∞–π–Ω <tr> –º”©—Ä–∏–π–≥ —É—Å—Ç–≥–∞–Ω–∞
                 ‚Ä¢ motable.setReady() –¥—É—É–¥–∞–≥–¥–∞–Ω–∞ (—à–∏–Ω—ç—á–∏–ª—Å—ç–Ω —Ç”©–ª”©–≤)
               ------------------------------------------------------------------- */
            const deactivateFileBtn = row.querySelector('.deactivate-file');
            if (deactivateFileBtn) {
                deactivateFileBtn.addEventListener('click', function (e) {
                    e.preventDefault();

                    /* üåê –º–æ–Ω–≥–æ–ª / –∞–Ω–≥–ª–∏ —Ö—ç–ª –¥—ç—ç—Ä –±–∞—Ç–∞–ª–≥–∞–∞–∂—É—É–ª–∞—Ö —Ç–µ–∫—Å—Ç */
                    const questionTemplate = (title) => {
                        if (document.documentElement.lang === 'mn') {
                            return `
                                <p class="text-danger mb-3">
                                    –¢–∞ <strong>${escapeStr(title)}</strong> —Ñ–∞–π–ª—ã–Ω –±–∏—á–ª—ç–≥–∏–π–≥
                                    –∏–¥—ç–≤—Ö–≥“Ø–π –±–æ–ª–≥–æ—Ö–æ–¥ –∏—Ç–≥—ç–ª—Ç—ç–π –±–∞–π–Ω–∞ —É—É?<br/><br/>
                                    –ë–æ–¥–∏—Ç —Ñ–∞–π–ª –Ω—å —É—Å—Ç–∞—Ö–≥“Ø–π - –∑”©–≤—Ö”©–Ω –±–∏—á–ª—ç–≥ (metadata) –ª –∏–¥—ç–≤—Ö–≥“Ø–π –±–æ–ª–Ω–æ.
                                </p>`;
                        }
                        return `
                            <p class="text-danger mb-3">
                                Are you sure you want to deactivate the file record
                                <strong>${escapeStr(title)}</strong>?
                            </p>`;
                    };

                    /* üÜî –ò–¥—ç–≤—Ö–≥“Ø–π –±–æ–ª–≥–æ—Ö –≥—ç–∂ –±—É–π —Ñ–∞–π–ª—ã–Ω id –¥—É–≥–∞–∞—Ä */
                    const id = deactivateFileBtn.value;

                    /* –§–∞–π–ª—ã–Ω –Ω—ç—Ä–∏–π–≥ row –¥–æ—Ç–æ—Ä—Ö thumbnail —Ö—ç—Å–≥—ç—ç—Å —É–Ω—à–∏–∂ –∞–≤–Ω–∞ */
                    const rawTitle = row.children[0].textContent.trim();
                    let question = questionTemplate(rawTitle);

                    /* üñº –•—ç—Ä—ç–≤ –∑—É—Ä–∞–≥ –±–æ–ª thumbnail —Ö–∞—Ä—É—É–ª–Ω–∞ */
                    const imgNode = row.children[0].querySelector('img');
                    let imgSrc = '';

                    if (imgNode) {
                        imgSrc = imgNode.src;
                    } else {
                        /* –•—ç—Ä—ç–≤ –∑—É—Ä–∞–≥ –±–∏—à –±–æ–ª HDD icon + —Ç–µ–∫—Å—Ç */
                        question = `
                            <i class="bi bi-hdd text-danger mb-4" style="font-size:3rem"></i>
                            ${question}
                        `;
                    }

                    /* –•—ç—Ä—ç–≥–ª—ç–≥—á—ç—ç—Ä –±–∞—Ç–ª—É—É–ª–∞—Ö */
                    Swal.fire({
                        imageUrl: imgSrc,
                        imageHeight: 64,
                        html: question,
                        showCancelButton: true,
                        cancelButtonText: `{{ 'cancel'|text|e }}`,
                        confirmButtonText: `<i class="bi bi-trash"></i> {{ 'delete'|text|e }}`,
                        confirmButtonColor: '#df4759',
                        showLoaderOnConfirm: true,
                        allowOutsideClick: () => !Swal.isLoading(),
                        backdrop: true,
                        preConfirm: () => {
                            const url = `{{ 'files-deactivate'|link({'table':table}) }}`;
                            return fetch(url, {
                                method: 'DELETE',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ id })
                            })
                            .then(res => res.json())
                            .then(response => {
                                if (response.status !== 'success') {
                                    throw new Error(response.message ?? 'Invalid response!');
                                }

                                /* success ‚Üí alert —Ö–∞–∞–∂, –º—ç–¥—ç–≥–¥—ç–ª –≥–∞—Ä–≥–∞–∂, row —É—Å—Ç–≥–∞–Ω–∞ */
                                Swal.close();
                                NotifyTop(
                                    'success',
                                    `{{ 'success'|text|e }}`,
                                    response.message ?? `File:${id} deactivated`
                                );

                                row.remove();         // <tr> —Ö“Ø—Å–Ω—ç–≥—Ç—ç—ç—Å —É—Å—Ç–≥–∞—Ö
                                thisTable.setReady(); // motable refresh/update
                            })
                            .catch(error => {
                                Swal.showValidationMessage(error.message);
                            });
                        }
                    });
                });
            }
        };
        
        /* motable instance “Ø“Ø—Å–≥—ç–∂ –±–∞–π–Ω–∞ */
        const files = new motable(
            'table#files',
            { freezeColumns: [0] } /* —ç—Ö–Ω–∏–π –±–∞–≥–∞–Ω—ã–≥ –Ω–∞–∞–ª—Ç—Ç–∞–π –±–æ–ª–≥–æ—Ö */
        );
        
        /* –§–∞–π–ª—ã–Ω –∂–∞–≥—Å–∞–∞–ª—Ç—ã–≥ backend-—ç—ç—Å AJAX-—Ä —Ç–∞—Ç–∞—Ö */
        fetch(
            `{{ 'files-list'|link({'table': table}) }}`
        ).then(res => {
            const contentType = res.headers.get('content-type') || '';
            if (contentType.includes('application/json')) return res.json();
            
            throw new Error(`HTTP [${res.status}]: ${res.statusText}`);
        }).then(data => {
            if (!data.list) {
                throw new Error(data.message ?? 'Invalid response!');
            }
            
            /* –ñ–∞–≥—Å–∞–∞–ª—Ç—ã–Ω file –±“Ø—Ä–∏–π–≥ motable.append() –∞—à–∏–≥–ª–∞–Ω —Ö“Ø—Å–Ω—ç–≥—Ç—ç–¥ –Ω—ç–º—ç—Ö */
            data.list.forEach(file => { files.append(file); });
            
            /* motable table-–≥ –∞–∂–∏–ª–¥ –±—ç–ª—ç–Ω –±–æ–ª–≥–æ—Ö */
            files.setReady();
        }).catch(err => {
            files.error(err);
        }).finally(() => {
            /* Fancybox-–≥ –∑—É—Ä–≥—ã–Ω —Ñ–∞–π–ª—É—É–¥–∞–¥ bind —Ö–∏–π—Ö */
            Fancybox.bind('[file-data-fancybox]', {groupAll: true});
        });
        
        /* ===================================================================
           üì§ Plupload - –§–ê–ô–õ UPLOAD –ë–ê –•–Ø–ù–ê–õ–¢
           -------------------------------------------------------------------
           –≠–Ω—ç uploader –¥–∞—Ä–∞–∞—Ö workflow-–≥ –≥“Ø–π—Ü—ç—Ç–≥—ç–Ω—ç:
              1) –§–∞–π–ª —Å–æ–Ω–≥–æ—Ö (pickfiles)
              2) –°–æ–Ω–≥–æ—Å–æ–Ω —Ñ–∞–π–ª—É—É–¥—ã–≥ –∂–∞–≥—Å–∞–∞–ª—Ç–∞–¥ —Ö–∞—Ä—É—É–ª–∞—Ö
              3) Upload —Ç–æ–≤—á –¥–∞—Ä–º–∞–≥—Ü uploader.start()
              4) Upload —è–≤—Ü—ã–Ω —Ö—É–≤—å (progress) —Ö–∞—Ä—É—É–ª–∞—Ö
              5) –°–µ—Ä–≤–µ—Ä–∏–π–Ω —Ö–∞—Ä–∏—É JSON-–≥ –∞—é—É–ª–≥“Ø–π parse —Ö–∏–π—Ö
              6) –ê–º–∂–∏–ª—Ç—Ç–∞–π –±–æ–ª motable.append() –∞—à–∏–≥–ª–∞–∂ —Ñ–∞–π–ª—ã–≥ —Ö“Ø—Å–Ω—ç–≥—Ç—ç–¥ –Ω—ç–º—ç—Ö
              7) Fancybox-–≥ image —Ç”©—Ä”©–ª–¥ bind —Ö–∏–π—Ö
              8) Error-—É—É–¥—ã–≥ NotifyTop –∞—à–∏–≥–ª–∞–∂ —Ö–∞—Ä—É—É–ª–∞—Ö
           ------------------------------------------------------------------- */
        const fileList = document.getElementById('filelist');
        const uploadFilesBtn = document.getElementById('uploadfiles');

        /* Plupload uploader instance */
        const uploader = new plupload.Uploader({
            runtimes: 'html5,flash,silverlight,html4',
            browse_button: 'pickfiles',
            container: document.getElementById('container'),
            
            /* FileController::post ‚Üí files-post endpoint —Ä—É—É upload —Ö–∏–π–Ω—ç */
            url: `{{ 'files-post'|link({'input':'file', 'table':table, 'id':0}) }}`,
            
            /* –§–∞–π–ª upload-–¥ —Ç–æ—Ö–∏—Ä–æ—Ö filter */
            filters: {
                max_file_size: `{{ max_file_size ?? '8mb' }}`,
                mime_types: [
                    {title: 'Images', extensions: 'jpg,jpeg,jpe,png,gif,ico,webp'},
                    {title: 'Documents', extensions: 'pdf,doc,docx,xls,xlsx,ppt,pptx,pps,ppsx,odt'},
                    {title: 'Audio', extensions: 'mp3,m4a,ogg,wav'},
                    {title: 'Video', extensions: 'mp4,m4v,mov,wmv,avi,mpg,ogv,3gp,3g2'},
                    {title: 'Text files', extensions: 'txt,xml,json'},
                    {title: 'Archives', extensions: 'zip,rar'}
                ]
            },

            /* Flash / Silverlight fallback –∑–∞–º—É—É–¥ */
            flash_swf_url: 'https://cdn.jsdelivr.net/gh/moxiecode/plupload/js/Moxie.swf',
            silverlight_xap_url: 'https://cdn.jsdelivr.net/gh/moxiecode/plupload/js/Moxie.xap',

            /* üß© PLUPLOAD CALLBACK-–£–£–î */
            init: {
                /* PostInit ‚Üí uploader.init() –¥—É—É—Å–∞–∞–¥ UI-–≥ —Ü—ç–≤—ç—Ä–ª—ç—Ö */
                PostInit: function () {
                    if (fileList) fileList.innerHTML = '';
                    if (uploadFilesBtn) {
                        uploadFilesBtn.onclick = function () {
                            uploader.start();
                            return false;
                        };
                    }
                },

                /* FilesAdded ‚Üí —Ñ–∞–π–ª —Å–æ–Ω–≥–æ—Å–æ–Ω –¥–∞—Ä—É–π–¥ –∂–∞–≥—Å–∞–∞–ª—Ç–∞–¥ –Ω—ç–º—ç—Ö */
                FilesAdded: function (up, files) {
                    files.forEach(function (file) {
                        if (fileList) {
                            fileList.innerHTML += `
                                <div id="${file.id}">
                                    ${escapeStr(file.name)} (${plupload.formatSize(file.size)})
                                    <b></b> <em></em>
                                </div>`;
                        }
                    });
                    
                    /* Upload —Ç–æ–≤—á–∏–π–≥ –∏–¥—ç–≤—Ö–∂“Ø“Ø–ª—ç—Ö */
                    if (uploadFilesBtn && uploadFilesBtn.disabled) {
                        uploadFilesBtn.removeAttribute('disabled');
                        uploadFilesBtn.classList.remove('btn-secondary');
                        uploadFilesBtn.classList.add('btn-info');
                    }
                },

                /* UploadProgress ‚Üí –•—É–≤—å —Ö–∞—Ä—É—É–ª–∞—Ö */
                UploadProgress: function (up, file) {
                    const row = document.getElementById(file.id);
                    if (row) {
                        const b = row.getElementsByTagName('b')[0];
                        if (b) b.innerHTML = `<i class="bi bi-upload"></i> sending ${file.percent}%`;
                    }

                    if (uploadFilesBtn) {
                        uploadFilesBtn.setAttribute('disabled', '');
                    }
                },

                /* FileUploaded ‚Üí —Å–µ—Ä–≤–µ—Ä —Ö–∞—Ä–∏—É–≥ –±–æ–ª–æ–≤—Å—Ä—É—É–ª–∞—Ö */
                FileUploaded: function (up, file, response) {
                    let res = null;
                    /* –ê—é—É–ª–≥“Ø–π JSON parse */
                    try {
                        res = JSON.parse(response.response);
                    } catch (e) {
                        res = { error: { message: 'Invalid response! (JSON parse failed)' } };
                    }
                    const row = document.getElementById(file.id);

                    /* –•–∞—Ä–∏—É –∞–º–∂–∏–ª—Ç—Ç–∞–π (res.path –±–∞–π—Ö —ë—Å—Ç–æ–π) */
                    if (res && res.path) {
                        if (row) {
                            const b = row.getElementsByTagName('b')[0];
                            if (b) b.innerHTML = '<i class="bi bi-check"></i> success';
                            row.classList.add('text-success');
                        }

                        /* –§–∞–π–ª—ã–≥ —Ö“Ø—Å–Ω—ç–≥—Ç—ç–¥ –Ω—ç–º—ç—Ö */
                        files.append(res);
                        files.setReady();

                        /* Fancybox –¥–∞—Ö–∏–Ω bind */
                        if (res['type'] === 'image' && res['mime_content_type'] !== 'image/gif') {
                            Fancybox.bind('[file-data-fancybox]', { groupAll: true });
                        }

                        NotifyTop(
                            'primary',
                            `{{ 'success'|text }}`,
                            `Your file [${escapeStr(file.name)}] was uploaded successfully.`
                        );                    
                    } else {
                        /* –ê–ª–¥–∞–∞ –≥–∞—Ä—Å–∞–Ω —Ç–æ—Ö–∏–æ–ª–¥–æ–ª */
                        let errorMessage = 'Unknown error!';

                        if (res && res.error && res.error.message) {
                            errorMessage = res.error.message;
                        }

                        if (row) {
                            const b = row.getElementsByTagName('b')[0];
                            const em = row.getElementsByTagName('em')[0];
                            if (b) b.innerHTML = '<i class="bi bi-x"></i> error';
                            if (em) em.innerHTML = escapeStr(errorMessage);
                            row.classList.add('text-danger');
                        }

                        NotifyTop('danger', `{{ 'error'|text }}`, errorMessage);
                    }

                    /* –ë“Ø—Ö —Ñ–∞–π–ª—É—É–¥ upload —Ö–∏–π–≥–¥—Å—ç–Ω —ç—Å—ç—Ö–∏–π–≥ —à–∞–ª–≥–∞–∂ ‚Üí —Ç–æ–≤—á–∏–¥ —Å—Ç–∞—Ç—É—Å –æ–Ω–æ–æ—Ö */
                    if (fileList) {
                        const children = fileList.children;
                        let finished = 0;

                        for (let i = 0; i < children.length; i++) {
                            const child = children[i];
                            const b = child.getElementsByTagName('b')[0];
                            if (b && b.innerHTML !== '') finished++;
                        }

                        if (finished === children.length) {
                            uploadFilesBtn.classList.remove('btn-info');
                            uploadFilesBtn.classList.add('btn-secondary');
                            uploadFilesBtn.setAttribute('disabled', '');
                        } else {
                            uploadFilesBtn.removeAttribute('disabled');
                        }
                    }
                },

                /* Error ‚Üí uploader —Ç“Ø–≤—à–Ω–∏–π –∞–ª–¥–∞–∞ */
                Error: function (up, err) {
                    const errRow = document.getElementById(err.file?.id);
                    if (errRow) {
                        const b = errRow.getElementsByTagName('b')[0];
                        const em = errRow.getElementsByTagName('em')[0];
                        if (b) b.innerHTML = '<i class="bi bi-x"></i> failed';
                        if (em) em.innerHTML = escapeStr(err.message);
                        errRow.classList.add('text-danger');
                    }

                    NotifyTop(
                        'danger',
                        `{{ 'error'|text }} ${String(err.code).replace(/\D/g, '')}`,
                        err.message
                    );
                }
            }
        });

        /* Uploader-–≥ —ç—Ö–ª“Ø“Ø–ª—ç—Ö */
        uploader.init();
    });
</script>

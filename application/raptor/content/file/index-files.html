<!-- SweetAlert2 —Å–∞–Ω - —Ñ–∞–π–ª—ã–≥ –∏–¥—ç–≤—Ö–≥“Ø–π –±–æ–ª–≥–æ—Ö –∑—ç—Ä—ç–≥ “Ø–π–ª–¥–ª–∏–π–Ω “Ø–µ–¥ –≥–æ—ë–º—Å–æ–≥ alert —Ö–∞—Ä—É—É–ª–∞—Ö–∞–¥ –∞—à–∏–≥–ª–∞–Ω–∞ -->
<script defer src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Custom image preview overlay CSS (Fancybox-–∏–π–Ω –æ—Ä–æ–Ω–¥) -->
<style>
    .image-preview-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,.85);
        z-index: 9999;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }
    .image-preview-overlay img,
    .image-preview-overlay video {
        max-width: 90%;
        max-height: 85vh;
        object-fit: contain;
        cursor: default;
        border-radius: 4px;
    }
    .image-preview-overlay audio {
        cursor: default;
        min-width: 320px;
    }
    .image-preview-overlay pre {
        width: 90%;
        max-height: 85vh;
        overflow: auto;
        background: #f8f9fa;
        color: #212529;
        padding: 1rem;
        border-radius: 4px;
        font-size: .875rem;
        cursor: default;
        margin: 0;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    .image-preview-overlay iframe {
        width: 90%;
        height: 90vh;
        border: none;
        border-radius: 4px;
        background: #fff;
        cursor: default;
    }
    .image-preview-overlay .preview-close {
        position: absolute;
        top: 12px;
        right: 20px;
        color: #fff;
        font-size: 2.5rem;
        cursor: pointer;
        line-height: 1;
        z-index: 1;
    }
    .image-preview-overlay .preview-caption {
        color: #ccc;
        margin-top: 10px;
        font-size: .95rem;
        text-align: center;
        max-width: 80%;
    }
</style>

<!-- –§–∞–π–ª—ã–Ω —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫ -->
<div class="d-flex flex-wrap align-items-center gap-3 mt-2 mb-2" style="font-size:.875rem">
    <span class="lang-mn">
        <i class="bi bi-database-fill text-primary me-1"></i>
        <strong>{{ total['tables'] }}</strong> —Ö“Ø—Å–Ω—ç–≥—Ç,
        <strong id="stat-total-rows">{{ total['rows'] }}</strong> —Ñ–∞–π–ª,
        <strong id="stat-total-size">{{ total['sizes'] }}</strong>
    </span>
    <span class="lang-en" hidden>
        <i class="bi bi-database-fill text-primary me-1"></i>
        <strong>{{ total['tables'] }}</strong> tables,
        <strong id="stat-total-rows-en">{{ total['rows'] }}</strong> files,
        <strong id="stat-total-size-en">{{ total['sizes'] }}</strong>
    </span>
    <small class="text-body-tertiary fst-italic ms-auto">
        <span class="lang-mn">* –∫–æ–Ω—Ç–µ–Ω—Ç—ã–Ω —Ç–æ–ª–≥–æ–π –∑—É—Ä–∞–≥, –∞–≥—É—É–ª–≥—ã–Ω —Ñ–∞–π–ª —Ç–æ–æ—Ü–æ–≥–¥–æ–æ–≥“Ø–π</span>
        <span class="lang-en" hidden>* excludes header images &amp; inline files</span>
    </small>
</div>
<!-- –•“Ø—Å–Ω—ç–≥—Ç —Å–æ–Ω–≥–æ–ª—Ç -->
<div class="d-flex flex-wrap gap-1 mb-3">
    {% for name,info in tables %}
    <a class="btn btn-sm rounded-pill {{ name == table ? 'btn-primary' : 'btn-outline-secondary' }}"
       href="{{ 'files'|link }}?table={{ name|e }}"
       data-table="{{ name|e }}" data-count="{{ info['count'] }}">
        {{ name }}{{ name != 'files' ? ' (attachments)' : '' }}
        <span class="badge rounded-pill ms-1 {{ name == table ? 'text-bg-light' : 'text-bg-secondary' }}">
            <span class="stat-info">{{ info['count'] }} &middot; {{ info['size'] }}</span>
        </span>
    </a>
    {% else %}
    <span class="lang-mn text-body-secondary">–º—ç–¥—ç—ç–ª—ç–ª –æ–ª–¥—Å–æ–Ω–≥“Ø–π</span>
    <span class="lang-en text-body-secondary" hidden>no data found</span>
    {% endfor %}
</div>

<!--
    –§–∞–π–ª —Å–æ–Ω–≥–æ—Ö, upload —Ö–∏–π—Ö —Ö—ç—Å—ç–≥ - Native JS file input.
    Hidden input + —Ç–æ–≤—á–Ω—É—É–¥ + —Å–æ–Ω–≥–æ—Å–æ–Ω —Ñ–∞–π–ª—É—É–¥—ã–Ω –∂–∞–≥—Å–∞–∞–ª—Ç.
-->
<div class="row">
    <div class="col-12">
        <input type="file" id="fileInput" multiple hidden accept=".jpg,.jpeg,.jpe,.png,.gif,.ico,.webp,.svg,.avif,.bmp,.tif,.tiff,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.pps,.ppsx,.odt,.ods,.odp,.csv,.rtf,.psd,.mp3,.m4a,.ogg,.wav,.aac,.flac,.wma,.mp4,.m4v,.mov,.wmv,.avi,.mpg,.ogv,.3gp,.3g2,.webm,.txt,.xml,.json,.zip,.rar,.7z,.gz,.tar">
        <button class="btn btn-sm btn-warning shadow-sm" id="pickfiles" type="button">
            {{ 'select-files'|text }}
        </button>
        <button class="btn btn-sm btn-secondary shadow-sm" id="uploadfiles" disabled type="button">
            {{ 'upload-files'|text }}
        </button>
        <label class="form-check form-check-inline form-switch ms-3 mb-0" style="font-size:.875rem">
            <input class="form-check-input" type="checkbox" id="optimizeCheck">
            <span class="form-check-label lang-mn">–ó—É—Ä–∞–≥ optimize —Ö–∏–π—Ö</span>
            <span class="form-check-label lang-en" hidden>Optimize images</span>
        </label>
    </div>
</div>

<!-- –°–æ–Ω–≥–æ—Å–æ–Ω —Ñ–∞–π–ª—É—É–¥—ã–Ω –∂–∞–≥—Å–∞–∞–ª—Ç (upload —Ö–∏–π—Ö–∏–π–Ω ”©–º–Ω”© –Ω—ç—Ä, —Ö—ç–º–∂—ç—ç —Ö–∞—Ä—É—É–ª–Ω–∞) -->
<div class="row text-danger mb-2">
    <div class="col-12" id="filelist"></div>
</div>

<!--
    –§–∞–π–ª—ã–Ω –∂–∞–≥—Å–∞–∞–ª—Ç—ã–Ω —Ö“Ø—Å–Ω—ç–≥—Ç.
    JS (motable) –¥—ç—ç—Ä—ç—ç—Å AJAX-—Ä data –∞–≤—á tbody-–≥ –¥–∏–Ω–∞–º–∏–∫–∞–∞—Ä “Ø“Ø—Å–≥—ç–Ω—ç.
    –≠–Ω–¥ –∑”©–≤—Ö”©–Ω —Ö“Ø—Å–Ω—ç–≥—Ç–∏–π–Ω —Ç–æ–ª–≥–æ–π —Ö—ç—Å–≥–∏–π–≥ (thead) ”©—Ä–≥”©–Ω”©.
-->
<table class="table table-sm table-bordered table-striped table-hover" id="files">
    <thead>
        <tr>
            <!-- –§–∞–π–ª—ã–Ω –Ω—ç—Ä, thumbnail, “Ø–π–ª–¥–ª–∏–π–Ω —Ç–æ–≤—á–Ω—É—É–¥ (link, tag, update, delete) -->
            <th scope="col">{{ 'file'|text }}</th>
            <!-- MIME —Ç”©—Ä”©–ª, —Ö—ç–º–∂—ç—ç –∑—ç—Ä—ç–≥ —Ç–µ—Ö–Ω–∏–∫–∏–π–Ω —à–∏–Ω–∂ —á–∞–Ω–∞—Ä -->
            <th scope="col">{{ 'properties'|text }}</th>
            <!-- –§–∞–π–ª—ã–Ω —Ç–∞–π–ª–±–∞—Ä - —Ö—ç—Ä—ç–≥–ª—ç–≥—á–∏–π–Ω –æ—Ä—É—É–ª—Å–∞–Ω description -->
            <th scope="col">{{ 'description'|text }}</th>
            <!-- –§–∞–π–ª—ã–≥ keyword-–æ–æ—Ä —à“Ø“Ø—Ö, —Ö–∞–π—Ö–∞–¥ –∑–æ—Ä–∏—É–ª–∞–≥–¥—Å–∞–Ω —Ç“Ø–ª—Ö“Ø“Ø—Ä “Ø–≥ -->
            <th scope="col">{{ 'keyword'|text }}</th>
            <!-- “Æ“Ø—Å–≥—ç—Å—ç–Ω –æ–≥–Ω–æ–æ / created_at -->
            <th scope="col">{{ 'date'|text }}</th>
        </tr>
    </thead>
</table>

<script type="text/javascript">
    const _mn = document.documentElement.lang === 'mn';

    /* üß© HELPER FUNCTIONS
       ------------------------------------------------------------
       –§–∞–π–ª—ã–Ω –Ω—ç—Ä —Å–∞–ª–≥–∞—Ö, —Ö—ç–º–∂—ç—ç —Ñ–æ—Ä–º–∞—Ç–ª–∞—Ö, HTML escape —Ö–∏–π—Ö –º—ç—Ç
       –∂–∏–∂–∏–≥ —Ç—É—Å–ª–∞—Ö —Ñ—É–Ω–∫—Ü—É—É–¥ —ç–Ω–¥ –±–∞–π–Ω–∞. */

    /* URL —ç—Å–≤—ç–ª path-–æ–æ—Å –∑”©–≤—Ö”©–Ω —Ñ–∞–π–ª—ã–Ω –Ω—ç—Ä–∏–π–≥ —Å–∞–ª–≥–∞–∂ –∞–≤–∞—Ö */
    function getBasename(url) {
        return url.split(/.*[\/|\\]/)[1];
    }

    /* –ë–∞–π—Ç—ã–Ω —Ö—ç–º–∂—ç—ç–≥ kb, mb, gb ... –±–æ–ª–≥–æ–Ω —Ö”©—Ä–≤“Ø“Ø–ª—ç—Ö */
    function formatSizeUnits(bytes) {
        const thresh = 1024;
        if (Math.abs(bytes) < thresh) {
            return `${bytes}b`;
        }

        const units = ['kb', 'mb', 'gb', 'tb'];
        let u = -1;
        const r = 10 ** 1;
        do {
            bytes /= thresh;
            ++u;
        } while (Math.round(Math.abs(bytes) * r) / r >= thresh && u < units.length - 1);

        return `${bytes.toFixed(1)}${units[u]}`;
    }

    /* HTML-—Ç—ç–π —Ö–æ–ª–±–æ–≥–¥–æ—Ö –∞—é—É–ª–≥“Ø–π –±–∞–π–¥–ª—ã–Ω “Ø“Ø–¥–Ω—ç—ç—Å —ç–Ω–≥–∏–π–Ω escape */
    function escapeStr(s) {
        const lookup = {
            '&': "&amp;",
            '"': "&quot;",
            "'": "&apos;",
            '<': "&lt;",
            '>': "&gt;"
        };
        return s.replace(/[&"'<>]/g, c => lookup[c]);
    }

    /* üñº Custom image preview (Fancybox-–∏–π–Ω –æ—Ä–æ–Ω–¥)
       ------------------------------------------------------------ */
    function openFilePreview(src, caption, type) {
        const overlay = document.createElement('div');
        overlay.className = 'image-preview-overlay';

        let content = '';
        if (type === 'video') {
            content = `<video src="${src}" controls autoplay></video>`;
        } else if (type === 'audio') {
            content = `<audio src="${src}" controls autoplay></audio>`;
        } else if (type === 'pdf') {
            content = `<iframe src="${src}"></iframe>`;
        } else if (type === 'text') {
            content = `<pre>${_mn ? '–ê—á–∞–∞–ª–∂ –±–∞–π–Ω–∞...' : 'Loading...'}</pre>`;
        } else {
            content = `<img src="${src}" alt="">`;
        }

        overlay.innerHTML = `
            <span class="preview-close">&times;</span>
            ${content}
            ${caption ? `<div class="preview-caption">${caption}</div>` : ''}
        `;

        document.body.appendChild(overlay);
        document.body.style.overflow = 'hidden';

        if (type === 'text') {
            fetch(src)
                .then(res => res.text())
                .then(text => {
                    const pre = overlay.querySelector('pre');
                    if (pre) pre.textContent = text;
                })
                .catch(() => {
                    const pre = overlay.querySelector('pre');
                    if (pre) pre.textContent = _mn ? '–§–∞–π–ª—ã–Ω –∞–≥—É—É–ª–≥—ã–≥ –∞—á–∞–∞–ª–∂ —á–∞–¥—Å–∞–Ω–≥“Ø–π.' : 'Failed to load file content.';
                });
        }

        const close = () => {
            overlay.remove();
            document.body.style.overflow = '';
        };

        overlay.querySelector('.preview-close').addEventListener('click', close);
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) close();
        });

        const onKey = (e) => {
            if (e.key === 'Escape') {
                close();
                document.removeEventListener('keydown', onKey);
            }
        };
        document.addEventListener('keydown', onKey);
    }

    /* üìå DOMContentLoaded - –ë“Ø—Ö JS —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å —ç–Ω–¥—ç—ç—Å —ç—Ö—ç–ª–Ω—ç
       -------------------------------------------------------------------
       –≠–Ω—ç –¥–æ—Ç–æ—Ä:
         ‚Ä¢ motable-–∏–π–Ω append override —Ö–∏–π—Ö
         ‚Ä¢ —Ñ–∞–π–ª—ã–Ω –∂–∞–≥—Å–∞–∞–ª—Ç—ã–≥ server-—ç—ç—Å fetch —Ö–∏–π—Ö
         ‚Ä¢ deactivate –∞–∂–∏–ª–ª–∞–≥–∞–∞–≥ —Ç–æ—Ö–∏—Ä—É—É–ª–∞—Ö
         ‚Ä¢ native file upload –ª–æ–≥–∏–∫
       ------------------------------------------------------------------- */
    document.addEventListener('DOMContentLoaded', function () {
        /* üåê –•—ç–ª–Ω–∏–π toggle */
        if (!_mn) {
            document.querySelectorAll('.lang-mn').forEach(el => el.hidden = true);
            document.querySelectorAll('.lang-en').forEach(el => el.hidden = false);
        }

        /* –§–∞–π–ª—ã–Ω modal –Ω—ç—ç—Ö –ª–∏–Ω–∫ - TWIG-—ç—ç—Å –∏—Ä–Ω—ç */
        const filesModalLink = `{{ 'files-modal'|link({'table': table}) }}`;

        /* –•—ç—Ä—ç–≥–ª—ç–≥—á –∑–∞—Å–≤–∞—Ä–ª–∞—Ö —ç—Ä—Ö—Ç—ç–π —ç—Å—ç—Ö */
        const userCanUpdate = `{{ user.can('system_content_update') ? 'true' : '' }}`;

        /* –•—ç—Ä—ç–≥–ª—ç–≥—á —É—Å—Ç–≥–∞—Ö —ç—Ä—Ö—Ç—ç–π —ç—Å—ç—Ö */
        const userCanDelete = `{{ user.can('system_content_delete') ? 'true' : '' }}`;

        /* motable.prototype.append - —Å–µ—Ä–≤–µ—Ä—ç—ç—Å –∏—Ä—Å—ç–Ω –Ω—ç–≥ file object –±–∏—á–ª—ç–≥–∏–π–≥
           —Ö“Ø—Å–Ω—ç–≥—Ç—ç–¥ (table) <tr> —Ö—ç–ª–±—ç—Ä—ç—ç—Ä –Ω—ç–º—ç—Ö —Ñ—É–Ω–∫—Ü.
           -------------------------------------------------------------------
           –≠–Ω—ç —Ñ—É–Ω–∫—Ü:
             ‚Ä¢ –§–∞–π–ª—ã–Ω thumbnail / icon “Ø“Ø—Å–≥—ç–Ω—ç
             ‚Ä¢ Modal –Ω—ç—ç—Ö action —Ç–æ–≤—á–Ω—É—É–¥ “Ø“Ø—Å–≥—ç–Ω—ç
             ‚Ä¢ UPDATE, DELETE —ç—Ä—Ö“Ø“Ø–¥–∏–π–≥ —à–∞–ª–≥–∞–Ω–∞
             ‚Ä¢ Image preview –±–æ–ª–æ–Ω modal —Ö–æ–ª–±–æ–æ—Å—É—É–¥—ã–≥ –∞–≤—Ç–æ–º–∞—Ç–∞–∞—Ä –±—ç—Ö–∂“Ø“Ø–ª–Ω—ç */
        motable.prototype.append = function (file) {
            /* üìå –§–∞–π–ª—ã–Ω —Ç”©—Ä”©–ª–¥ —Ç–æ—Ö–∏—Ä—Å–æ–Ω icon/preview —Ç–æ–¥–æ—Ä—Ö–æ–π–ª–æ—Ö */
            let fileIcon = '';
            const fileName = escapeStr(decodeURIComponent(getBasename(file['path'])));

            /* default link attribute - —Ñ–∞–π–ª –Ω—ç—ç—Ö “Ø–µ–¥ confirm –∞—Å—É—É–Ω–∞ */
            let fileLinkAttr =
                `target="__blank" onclick="return confirm('${_mn ? `–¢–∞ [${fileName}] —Ñ–∞–π–ª—ã–≥ –Ω—ç—ç—Ö–¥—ç—ç –∏—Ç–≥—ç–ª—Ç—ç–π –±–∞–π–Ω–∞ —É—É?` : `Are you sure you want to open this file [${fileName}]?`}')"`;


            /* –§–∞–π–ª—ã–Ω —Ç”©—Ä”©–ª–¥ —Å—É—É—Ä–∏–ª—Å–∞–Ω modal action (code tag –≥—ç—Ö –º—ç—Ç) */
            let fileAction = `
                <a class="btn btn-sm btn-dark ajax-modal"
                    data-bs-target="#static-modal" data-bs-toggle="modal"
                    href="${filesModalLink}?modal=${file['type']}-tag&id=${file['id']}">
                    <i class="bi bi-code"></i>
                </a>`;

            if (file['type'] === 'image') {
                /* üì∑ IMAGE file preview */
                fileIcon =
                    `<img src="${file['path']}" style="max-height:7.5rem; max-width:20rem; height:100%">`;

                const caption = file['description']
                    ? escapeStr(file['description'])
                    : fileName;
                fileLinkAttr = `data-preview="image" data-caption="${caption}"`;
            } else if (file['type'] === 'video') {
                /* üé• VIDEO preview */
                fileIcon = `
                    <video style="max-height:15rem; height:100%; max-width:20rem; width:100%" controls>
                        <source src="${file['path']}">
                    </video>`;

                const caption = file['description']
                    ? escapeStr(file['description'])
                    : fileName;
                fileLinkAttr = `data-preview="video" data-caption="${caption}"`;
            } else if (file['type'] === 'audio') {
                /* üéµ AUDIO preview */
                fileIcon = `
                    <audio controls>
                        <source src="${file['path']}" type="${file['mime_content_type']}">
                    </audio>`;

                const caption = file['description']
                    ? escapeStr(file['description'])
                    : fileName;
                fileLinkAttr = `data-preview="audio" data-caption="${caption}"`;
            } else {
                /* üóÑ OTHER file types (doc, zip, pdf...) */
                fileIcon = '<i class="bi bi-hdd"></i>';
                fileAction = '';

                const mime = file['mime_content_type'];

                if (mime === 'application/pdf') {
                    /* PDF —Ñ–∞–π–ª—ã–≥ browser-–¥ —à—É—É–¥ preview —Ö–∏–π—Ö */
                    fileIcon = '<i class="bi bi-file-earmark-pdf" style="font-size:2rem;color:#dc3545"></i>';
                    const caption = file['description']
                        ? escapeStr(file['description'])
                        : fileName;
                    fileLinkAttr = `data-preview="pdf" data-caption="${caption}"`;
                } else if (mime === 'text/plain' || mime === 'application/json' || mime === 'text/xml' || mime === 'application/xml') {
                    /* Text —Ñ–∞–π–ª—ã–≥ fetch —Ö–∏–π–∂ overlay –¥—ç—ç—Ä —Ö–∞—Ä—É—É–ª–∞—Ö */
                    fileIcon = '<i class="bi bi-file-earmark-text" style="font-size:2rem"></i>';
                    const caption = file['description']
                        ? escapeStr(file['description'])
                        : fileName;
                    fileLinkAttr = `data-preview="text" data-caption="${caption}"`;
                }
            }

            /* Location modal (path —Ö–∞—Ä–∞—Ö / —Ö—É—É–ª–±–∞—Ä –∞–≤–∞—Ö) */
            fileAction = `
                <a class="btn btn-sm btn-info ajax-modal"
                    data-bs-target="#static-modal" data-bs-toggle="modal"
                    href="${filesModalLink}?modal=location&id=${file['id']}">
                    <i class="bi bi-link"></i>
                </a>
                ${fileAction}
            `;

            /* Update modal (–∑–∞—Å–≤–∞—Ä–ª–∞—Ö —ç—Ä—Ö—Ç—ç–π –±–æ–ª) */
            if (userCanUpdate) {
                fileAction += `
                    <a class="btn btn-sm btn-primary shadow-sm ajax-modal"
                        data-bs-target="#static-modal" data-bs-toggle="modal"
                        href="${filesModalLink}?modal=files-update&id=${file['id']}">
                        <i class="bi bi-pencil-square"></i>
                    </a>`;
            }

            /* Delete (deactivate) button (—É—Å—Ç–≥–∞—Ö —ç—Ä—Ö—Ç—ç–π –±–æ–ª) */
            if (userCanDelete) {
                fileAction += `
                    <button class="deactivate-file btn btn-sm btn-danger shadow-sm"
                        value="${file['id']}" type="button">
                        <i class="bi bi-trash"></i>
                    </button>`;
            }

            /* FILE + NAME + ACTIONS –•–û–õ–ë–û–ñ –ë–õ–û–ö “Æ“Æ–°–ì–≠–• */
            let fileFigure = `
                <a href="${file['path']}" ${fileLinkAttr}>
                    ${fileIcon}
                    <span style="display:block">${fileName}</span>
                </a>
                ${fileAction}
            `;

            /* üß± <tr> –º”©—Ä –±–æ–ª–æ–Ω <td> –Ω“Ø–¥–Ω“Ø“Ø–¥–∏–π–≥ “Ø“Ø—Å–≥—ç—Ö */
            const row = document.createElement('tr');
            row.id = `file_${file['id']}`;
            row.style.fontSize = '.875rem';

            /* üìå 1-—Ä –±–∞–≥–∞–Ω–∞: thumbnail + “Ø–π–ª–¥–ª“Ø“Ø–¥ */
            const cell1 = document.createElement('td');
            cell1.innerHTML =
                `<input name="files[]" value="${file['id']}" type="hidden">
                 ${fileFigure}`;
            row.appendChild(cell1);

            /* üìå 2-—Ä –±–∞–≥–∞–Ω–∞: MIME —Ç”©—Ä”©–ª + —Ö—ç–º–∂—ç—ç */
            const cell2 = document.createElement('td');
            cell2.innerHTML = `
                <p style="max-width:11.25rem; word-wrap:break-all">
                    <u>${file['mime_content_type']}</u>
                </p>
                ${formatSizeUnits(file['size'])}`;
            row.appendChild(cell2);

            /* üìå 3-—Ä –±–∞–≥–∞–Ω–∞ - description */
            const cell3 = document.createElement('td');
            cell3.innerHTML = file['description'] ?? '';
            row.appendChild(cell3);

            /* üìå 4-—Ä –±–∞–≥–∞–Ω–∞ - keyword */
            const cell4 = document.createElement('td');
            cell4.innerHTML = file['keyword'] ?? '';
            row.appendChild(cell4);

            /* üìå 5-—Ä –±–∞–≥–∞–Ω–∞ - created_at */
            const cell5 = document.createElement('td');
            cell5.innerHTML = file['created_at'] ?? '';
            row.appendChild(cell5);

            let tBody = this.table.querySelector('tbody');
            /* üß© tbody –±–∞–π—Ö–≥“Ø–π –±–æ–ª “Ø“Ø—Å–≥—ç–Ω—ç */
            if (!tBody) {
                tBody = document.createElement('tbody');
                this.table.appendChild(tBody);

                /* motable —Ç–æ—Ö–∏—Ä–≥–æ–æ–Ω–¥ tbody-–≥–∏–π–Ω custom style –±–∞–π—Å–∞–Ω –±–æ–ª –∞—à–∏–≥–ª–∞–Ω–∞ */
                if (this.options.style.tbody) {
                    tBody.style.cssText = this.options.style.tbody;
                }
            }

            /* –ë—ç–ª–¥—Å—ç–Ω file row-–≥ append —Ö–∏–π–µ */
            tBody.appendChild(row);

            /* ü™ü Modal –Ω—ç—ç–¥—ç–≥ –±“Ø—Ö .ajax-modal –ª–∏–Ω–∫ –¥—ç—ç—Ä click handler –Ω—ç–º—ç—Ö */
            const rowModals = row.querySelectorAll('.ajax-modal');
            rowModals.forEach(a => a.addEventListener('click', function (e) {
                e.preventDefault();
                ajaxModal(a);
            }));

            /* üñº data-preview attribute –±“Ø—Ö–∏–π –∑—É—Ä–∞–≥—Ç click handler –Ω—ç–º—ç—Ö */
            const previewLink = row.querySelector('[data-preview]');
            if (previewLink) {
                previewLink.addEventListener('click', function (e) {
                    e.preventDefault();
                    openFilePreview(this.href, this.dataset.caption || '', this.dataset.preview);
                });
            }

            const thisTable = this; /* motable instance —Ö–∞–¥–≥–∞–ª–∞—Ö */

            /* üóë –§–ê–ô–õ–´–ù –ë–ò–ß–õ–≠–ì–ò–ô–ì –ò–î–≠–í–•–ì“Æ–ô –ë–û–õ–ì–û–• (Soft Delete)
               -------------------------------------------------------------------
               –≠–Ω—ç —Ö—ç—Å—ç–≥ deactivate-file —Ç–æ–≤—á –¥—ç—ç—Ä –¥–∞—Ä—Å–Ω–∞–∞—Ä:
                 ‚Ä¢ –ó—É—Ä–≥–∏–π–Ω thumbnail / icon –±“Ø—Ö–∏–π –±–∞—Ç–∞–ª–≥–∞–∞–∂—É—É–ª–∞—Ö modal –≥–∞—Ä–≥–∞–Ω–∞
                 ‚Ä¢ –•—ç—Ä—ç–≥–ª—ç–≥—á OK –¥–∞—Ä–≤–∞–ª DELETE fetch API —É—Ä—É—É —Ö“Ø—Å—ç–ª—Ç –∏–ª–≥—ç—ç–Ω—ç
                 ‚Ä¢ –ê–º–∂–∏–ª—Ç—Ç–∞–π –±–æ–ª —Ö“Ø—Å–Ω—ç–≥—Ç—ç—ç—Å —Ç—É—Ö–∞–π–Ω <tr> –º”©—Ä–∏–π–≥ —É—Å—Ç–≥–∞–Ω–∞
                 ‚Ä¢ motable.setReady() –¥—É—É–¥–∞–≥–¥–∞–Ω–∞ (—à–∏–Ω—ç—á–∏–ª—Å—ç–Ω —Ç”©–ª”©–≤)
               ------------------------------------------------------------------- */
            const deactivateFileBtn = row.querySelector('.deactivate-file');
            if (deactivateFileBtn) {
                deactivateFileBtn.addEventListener('click', function (e) {
                    e.preventDefault();

                    /* üåê –º–æ–Ω–≥–æ–ª / –∞–Ω–≥–ª–∏ —Ö—ç–ª –¥—ç—ç—Ä –±–∞—Ç–∞–ª–≥–∞–∞–∂—É—É–ª–∞—Ö —Ç–µ–∫—Å—Ç */
                    const questionTemplate = (title) => {
                        if (document.documentElement.lang === 'mn') {
                            return `
                                <p class="text-danger mb-3">
                                    –¢–∞ <strong>${escapeStr(title)}</strong> —Ñ–∞–π–ª—ã–Ω –±–∏—á–ª—ç–≥–∏–π–≥
                                    –∏–¥—ç–≤—Ö–≥“Ø–π –±–æ–ª–≥–æ—Ö–æ–¥ –∏—Ç–≥—ç–ª—Ç—ç–π –±–∞–π–Ω–∞ —É—É?<br/><br/>
                                    –ë–æ–¥–∏—Ç —Ñ–∞–π–ª –Ω—å —É—Å—Ç–∞—Ö–≥“Ø–π - –∑”©–≤—Ö”©–Ω –±–∏—á–ª—ç–≥ (metadata) –ª –∏–¥—ç–≤—Ö–≥“Ø–π –±–æ–ª–Ω–æ.
                                </p>`;
                        }
                        return `
                            <p class="text-danger mb-3">
                                Are you sure you want to deactivate the file record
                                <strong>${escapeStr(title)}</strong>?
                            </p>`;
                    };

                    /* üÜî –ò–¥—ç–≤—Ö–≥“Ø–π –±–æ–ª–≥–æ—Ö –≥—ç–∂ –±—É–π —Ñ–∞–π–ª—ã–Ω id –¥—É–≥–∞–∞—Ä */
                    const id = deactivateFileBtn.value;

                    /* –§–∞–π–ª—ã–Ω –Ω—ç—Ä–∏–π–≥ row –¥–æ—Ç–æ—Ä—Ö thumbnail —Ö—ç—Å–≥—ç—ç—Å —É–Ω—à–∏–∂ –∞–≤–Ω–∞ */
                    const rawTitle = row.children[0].textContent.trim();
                    let question = questionTemplate(rawTitle);

                    /* üñº –•—ç—Ä—ç–≤ –∑—É—Ä–∞–≥ –±–æ–ª thumbnail —Ö–∞—Ä—É—É–ª–Ω–∞ */
                    const imgNode = row.children[0].querySelector('img');
                    let imgSrc = '';

                    if (imgNode) {
                        imgSrc = imgNode.src;
                    } else {
                        /* –•—ç—Ä—ç–≤ –∑—É—Ä–∞–≥ –±–∏—à –±–æ–ª HDD icon + —Ç–µ–∫—Å—Ç */
                        question = `
                            <i class="bi bi-hdd text-danger mb-4" style="font-size:3rem"></i>
                            ${question}
                        `;
                    }

                    /* –•—ç—Ä—ç–≥–ª—ç–≥—á—ç—ç—Ä –±–∞—Ç–ª—É—É–ª–∞—Ö */
                    Swal.fire({
                        imageUrl: imgSrc,
                        imageHeight: 64,
                        html: question,
                        showCancelButton: true,
                        cancelButtonText: `{{ 'cancel'|text|e }}`,
                        confirmButtonText: `<i class="bi bi-trash"></i> {{ 'delete'|text|e }}`,
                        confirmButtonColor: '#df4759',
                        showLoaderOnConfirm: true,
                        allowOutsideClick: () => !Swal.isLoading(),
                        backdrop: true,
                        preConfirm: () => {
                            const url = `{{ 'files-deactivate'|link({'table':table}) }}`;
                            return fetch(url, {
                                method: 'DELETE',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ id })
                            })
                            .then(res => res.json())
                            .then(response => {
                                if (response.status !== 'success') {
                                    throw new Error(response.message ?? 'Invalid response!');
                                }

                                /* success ‚Üí alert —Ö–∞–∞–∂, –º—ç–¥—ç–≥–¥—ç–ª –≥–∞—Ä–≥–∞–∂, row —É—Å—Ç–≥–∞–Ω–∞ */
                                Swal.close();
                                NotifyTop(
                                    'success',
                                    `{{ 'success'|text|e }}`,
                                    response.message ?? (_mn ? `–§–∞–π–ª:${id} –∏–¥—ç–≤—Ö–≥“Ø–π –±–æ–ª—Å–æ–Ω` : `File:${id} deactivated`)
                                );

                                row.remove();         // <tr> —Ö“Ø—Å–Ω—ç–≥—Ç—ç—ç—Å —É—Å—Ç–≥–∞—Ö
                                thisTable.setReady(); // motable refresh/update
                            })
                            .catch(error => {
                                Swal.showValidationMessage(error.message);
                            });
                        }
                    });
                });
            }
        };

        /* motable instance “Ø“Ø—Å–≥—ç–∂ –±–∞–π–Ω–∞ */
        const files = new motable(
            'table#files',
            { freezeColumns: [0] } /* —ç—Ö–Ω–∏–π –±–∞–≥–∞–Ω—ã–≥ –Ω–∞–∞–ª—Ç—Ç–∞–π –±–æ–ª–≥–æ—Ö */
        );

        /* –§–∞–π–ª—ã–Ω –∂–∞–≥—Å–∞–∞–ª—Ç—ã–≥ backend-—ç—ç—Å AJAX-—Ä —Ç–∞—Ç–∞—Ö */
        fetch(
            `{{ 'files-list'|link({'table': table}) }}`
        ).then(res => {
            const contentType = res.headers.get('content-type') || '';
            if (contentType.includes('application/json')) return res.json();

            throw new Error(`HTTP [${res.status}]: ${res.statusText}`);
        }).then(data => {
            if (!data.list) {
                throw new Error(data.message ?? 'Invalid response!');
            }

            /* –ñ–∞–≥—Å–∞–∞–ª—Ç—ã–Ω file –±“Ø—Ä–∏–π–≥ motable.append() –∞—à–∏–≥–ª–∞–Ω —Ö“Ø—Å–Ω—ç–≥—Ç—ç–¥ –Ω—ç–º—ç—Ö */
            data.list.forEach(file => { files.append(file); });

            /* motable table-–≥ –∞–∂–∏–ª–¥ –±—ç–ª—ç–Ω –±–æ–ª–≥–æ—Ö */
            files.setReady();
        }).catch(err => {
            files.error(err);
        });

        /* ===================================================================
           üì§ NATIVE FILE UPLOAD
           -------------------------------------------------------------------
           –≠–Ω—ç upload –ª–æ–≥–∏–∫ –¥–∞—Ä–∞–∞—Ö workflow-–≥ –≥“Ø–π—Ü—ç—Ç–≥—ç–Ω—ç:
              1) –§–∞–π–ª —Å–æ–Ω–≥–æ—Ö (pickfiles ‚Üí hidden file input)
              2) Client-side validation (—Ö—ç–º–∂—ç—ç, extension)
              3) –°–æ–Ω–≥–æ—Å–æ–Ω —Ñ–∞–π–ª—É—É–¥—ã–≥ –∂–∞–≥—Å–∞–∞–ª—Ç–∞–¥ —Ö–∞—Ä—É—É–ª–∞—Ö
              4) Upload —Ç–æ–≤—á –¥–∞—Ä–º–∞–≥—Ü fetch API-—Ä —Ñ–∞–π–ª –±“Ø—Ä–∏–π–≥ –¥–∞—Ä–∞–∞–ª–∞–ª–∞–∞—Ä upload
              5) Per-file status: uploading ‚Üí success/error
              6) –ê–º–∂–∏–ª—Ç—Ç–∞–π –±–æ–ª motable.append() + files.setReady()
           ------------------------------------------------------------------- */
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('filelist');
        const pickFilesBtn = document.getElementById('pickfiles');
        const uploadFilesBtn = document.getElementById('uploadfiles');

        /* Upload URL */
        const uploadUrl = `{{ 'files-post'|link({'table': table}) }}`;

        /* –û–¥–æ–æ–≥–∏–π–Ω —Ö“Ø—Å–Ω—ç–≥—Ç–∏–π–Ω badge element */
        const currentBadge = document.querySelector(`a.badge[data-table="{{ table|e }}"]`);
        let tableBytes = {{ tables[table]['bytes'] ?? 0 }};

        /* Upload –∞–º–∂–∏–ª—Ç—Ç–∞–π –±“Ø—Ä–¥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫ —à–∏–Ω—ç—á–ª—ç—Ö */
        function updateStats(fileSize) {
            if (!currentBadge) return;

            /* Badge count + size —à–∏–Ω—ç—á–ª—ç—Ö */
            let count = parseInt(currentBadge.dataset.count) || 0;
            count++;
            currentBadge.dataset.count = count;
            tableBytes += fileSize;
            const infoEl = currentBadge.querySelector('.stat-info');
            if (infoEl) infoEl.textContent = `${count} -> ${formatSizeUnits(tableBytes)}`;

            /* Total rows —à–∏–Ω—ç—á–ª—ç—Ö */
            ['stat-total-rows', 'stat-total-rows-en'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = parseInt(el.textContent) + 1;
            });

            /* Total size —à–∏–Ω—ç—á–ª—ç—Ö */
            updateStats._totalBytes = (updateStats._totalBytes ?? {{ total['total_bytes'] }}) + fileSize;
            ['stat-total-size', 'stat-total-size-en'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = formatSizeUnits(updateStats._totalBytes);
            });
        }

        /* –•—è–∑–≥–∞–∞—Ä–ª–∞–ª—Ç—ã–Ω —Ç–æ—Ö–∏—Ä–≥–æ–æ */
        const maxBytes = {{ max_file_size ?? 8388608 }};
        const allowedExtensions = [
            'jpg','jpeg','jpe','png','gif','ico','webp','svg','avif','bmp','tif','tiff',
            'pdf','doc','docx','xls','xlsx','ppt','pptx','pps','ppsx','odt','ods','odp','csv','rtf','psd',
            'mp3','m4a','ogg','wav','aac','flac','wma',
            'mp4','m4v','mov','wmv','avi','mpg','ogv','3gp','3g2','webm',
            'txt','xml','json',
            'zip','rar','7z','gz','tar'
        ];

        /* "Select files" —Ç–æ–≤—á ‚Üí hidden file input-–≥ trigger —Ö–∏–π—Ö */
        pickFilesBtn.addEventListener('click', () => fileInput.click());

        /* –§–∞–π–ª —Å–æ–Ω–≥–æ—Å–æ–Ω “Ø–µ–¥ ‚Üí validation + –∂–∞–≥—Å–∞–∞–ª—Ç–∞–¥ —Ö–∞—Ä—É—É–ª–∞—Ö */
        fileInput.addEventListener('change', function () {
            fileList.innerHTML = '';

            const selectedFiles = Array.from(this.files);
            if (!selectedFiles.length) return;

            let hasValid = false;

            selectedFiles.forEach((file, i) => {
                const ext = file.name.split('.').pop().toLowerCase();
                let status = '';
                let statusClass = '';

                if (!allowedExtensions.includes(ext)) {
                    status = `<em class="text-danger">${_mn ? `.${escapeStr(ext)} ”©—Ä–≥”©—Ç–≥”©–ª –∑”©–≤—à”©”©—Ä”©–≥–¥”©”©–≥“Ø–π` : `extension .${escapeStr(ext)} not allowed`}</em>`;
                    statusClass = 'text-muted';
                } else if (file.size > maxBytes) {
                    status = `<em class="text-danger">${_mn ? `—Ö—ç–º–∂—ç—ç —Ö—ç—Ç—ç—Ä—Å—ç–Ω (${formatSizeUnits(maxBytes)})` : `exceeds max size ${formatSizeUnits(maxBytes)}`}</em>`;
                    statusClass = 'text-muted';
                } else {
                    hasValid = true;
                }

                fileList.innerHTML += `
                    <div id="upload_${i}" class="${statusClass}">
                        ${escapeStr(file.name)} (${formatSizeUnits(file.size)})
                        <b>${status}</b>
                    </div>`;
            });

            /* Upload —Ç–æ–≤—á–∏–π–≥ –∏–¥—ç–≤—Ö–∂“Ø“Ø–ª—ç—Ö (—Ö“Ø—á–∏–Ω—Ç—ç–π —Ñ–∞–π–ª –±–∞–π–≤–∞–ª) */
            if (hasValid) {
                uploadFilesBtn.removeAttribute('disabled');
                uploadFilesBtn.classList.remove('btn-secondary');
                uploadFilesBtn.classList.add('btn-info');
            } else {
                uploadFilesBtn.setAttribute('disabled', '');
                uploadFilesBtn.classList.remove('btn-info');
                uploadFilesBtn.classList.add('btn-secondary');
            }
        });

        /* "Upload" —Ç–æ–≤—á ‚Üí —Ñ–∞–π–ª –±“Ø—Ä–∏–π–≥ –¥–∞—Ä–∞–∞–ª–∞–ª–∞–∞—Ä fetch API-—Ä upload —Ö–∏–π—Ö */
        uploadFilesBtn.addEventListener('click', async function () {
            const selectedFiles = Array.from(fileInput.files);
            if (!selectedFiles.length) return;

            uploadFilesBtn.setAttribute('disabled', '');
            pickFilesBtn.setAttribute('disabled', '');

            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                const rowEl = document.getElementById(`upload_${i}`);
                const ext = file.name.split('.').pop().toLowerCase();

                /* –•“Ø—á–∏–Ω–≥“Ø–π —Ñ–∞–π–ª—É—É–¥—ã–≥ –∞–ª–≥–∞—Å–∞—Ö */
                if (!allowedExtensions.includes(ext) || file.size > maxBytes) continue;

                /* Uploading —Å—Ç–∞—Ç—É—Å */
                if (rowEl) {
                    const b = rowEl.querySelector('b');
                    if (b) b.innerHTML = `<i class="bi bi-upload"></i> ${_mn ? '–∏–ª–≥—ç—ç–∂ –±–∞–π–Ω–∞...' : 'uploading...'}`;
                }

                try {
                    const formData = new FormData();
                    formData.append('file', file);
                    if (document.getElementById('optimizeCheck').checked) {
                        formData.append('optimize', '1');
                    }

                    const response = await fetch(uploadUrl, {
                        method: 'POST',
                        body: formData
                    });

                    const res = await response.json();

                    if (res && res.path) {
                        /* –ê–º–∂–∏–ª—Ç—Ç–∞–π */
                        if (rowEl) {
                            const b = rowEl.querySelector('b');
                            if (b) b.innerHTML = `<i class="bi bi-check"></i> ${_mn ? '–∞–º–∂–∏–ª—Ç—Ç–∞–π' : 'success'}`;
                            rowEl.classList.add('text-success');
                        }

                        files.append(res);
                        files.setReady();
                        updateStats(res.size || 0);

                        NotifyTop(
                            'primary',
                            `{{ 'success'|text }}`,
                            _mn ? `[${escapeStr(file.name)}] —Ñ–∞–π–ª –∞–º–∂–∏–ª—Ç—Ç–∞–π –±–∞–π—Ä—à–ª–∞–∞.` : `Your file [${escapeStr(file.name)}] was uploaded successfully.`
                        );
                    } else {
                        /* –°–µ—Ä–≤–µ—Ä –∞–ª–¥–∞–∞ –±—É—Ü–∞–∞—Å–∞–Ω */
                        const errorMessage = (res && res.error && res.error.message)
                            ? res.error.message
                            : (_mn ? '–¢–æ–¥–æ—Ä—Ö–æ–π–≥“Ø–π –∞–ª–¥–∞–∞!' : 'Unknown error!');

                        if (rowEl) {
                            const b = rowEl.querySelector('b');
                            if (b) b.innerHTML = `<i class="bi bi-x"></i> ${_mn ? '–∞–ª–¥–∞–∞' : 'error'} <em>${escapeStr(errorMessage)}</em>`;
                            rowEl.classList.add('text-danger');
                        }

                        NotifyTop('danger', `{{ 'error'|text }}`, errorMessage);
                    }
                } catch (err) {
                    /* Network / parse –∞–ª–¥–∞–∞ */
                    if (rowEl) {
                        const b = rowEl.querySelector('b');
                        if (b) b.innerHTML = `<i class="bi bi-x"></i> ${_mn ? '–∞–º–∂–∏–ª—Ç–≥“Ø–π' : 'failed'} <em>${escapeStr(err.message)}</em>`;
                        rowEl.classList.add('text-danger');
                    }

                    NotifyTop('danger', `{{ 'error'|text }}`, err.message);
                }
            }

            /* –ë“Ø—Ö upload –¥—É—É—Å—Å–∞–Ω ‚Üí —Ç–æ–≤—á–Ω—É—É–¥—ã–Ω —Å—Ç–∞—Ç—É—Å —à–∏–Ω—ç—á–ª—ç—Ö */
            pickFilesBtn.removeAttribute('disabled');
            uploadFilesBtn.classList.remove('btn-info');
            uploadFilesBtn.classList.add('btn-secondary');
            uploadFilesBtn.setAttribute('disabled', '');
            fileInput.value = '';
        });
    });
</script>

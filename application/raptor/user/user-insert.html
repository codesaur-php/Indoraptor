<!-- ‚úÖ –•—ç—Ä—ç–≥–ª—ç–≥—á —à–∏–Ω—ç—ç—Ä “Ø“Ø—Å–≥—ç—Ö —Ñ–æ—Ä–º—ã–Ω —Ç–æ–ª–≥–æ–π —Ö—ç—Å—ç–≥ -->
<div class="d-flex flex-wrap justify-content-between align-items-center text-uppercase rounded p-1 mb-2 shadow">
    <h3 class="px-2 my-auto fs-6 text-success">
        <i class="bi bi-person-plus-fill"></i> {{ 'create-new-user'|text }}
    </h3>
    <div class="ms-auto">
        {% if user.can('system_user_insert') %}
            <!-- –§–æ—Ä–º–∞–∞—Å “Ø–ª —Ö–∞–º–∞–∞—Ä–∞–Ω –¥—ç—ç—Ä, –¥–æ–æ—Ä –±–∞–π—Ä–ª–∞—Ö submit —Ç–æ–≤—á–ª—É—É—Ä—É—É–¥ -->
            <button class="submit-insert btn btn-sm btn-success text-uppercase shadow-sm">
                <i class="bi bi-check"></i> {{ 'submit'|text }}
            </button>
        {% endif %}
        <a class="btn btn-sm btn-secondary shadow-sm" href="{{ 'users'|link }}">
            <i class="bi bi-arrow-left"></i> {{ 'users'|text }}
        </a>
    </div>
</div>

<!-- ‚úÖ Tab —Ü—ç—Å: –•—É–≤–∏–π–Ω –º—ç–¥—ç—ç–ª—ç–ª / –ó—É—Ä–∞–≥ / –ë–∞–π–≥—É—É–ª–ª–∞–≥–∞ -->
<ul class="nav nav-tabs" role="tablist">
    <li class="nav-item">
        <a class="nav-link active show" data-bs-toggle="tab" href="#tab-personal">
            {{ 'personal-info'|text }} <i class="bi bi-postcard"></i>
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#tab-picture">
            {{ 'image'|text }} <i class="bi bi-camera"></i>
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#tab-organization">
            {{ 'organization'|text }} <i class="bi bi-building"></i>
        </a>
    </li>
</ul>

<!-- ‚úÖ –•—ç—Ä—ç–≥–ª—ç–≥—á —à–∏–Ω—ç—ç—Ä “Ø“Ø—Å–≥—ç—Ö “Ø–Ω–¥—Å—ç–Ω FORM -->
<form class="needs-validation pt-3" novalidate id="user_insert" action="{{ 'user-insert'|link }}" method="POST" enctype="multipart/form-data">
    <div class="tab-content">
        <!-- üß∑ 1-—Ä tab: –•—É–≤–∏–π–Ω –º—ç–¥—ç—ç–ª—ç–ª -->
        <div class="tab-pane active show" id="tab-personal" role="tabpanel">
            <div class="mb-3">
                <label class="form-label">{{ 'login'|text }}</label>
                <input class="form-control" required name="username" value="" maxlength="128" placeholder="" type="text" autocomplete="off">
                <div class="invalid-feedback">{{ 'field-is-required'|text }}</div>
            </div>
            <div class="mb-3">
                <label class="form-label">{{ 'password'|text }}</label>
                <input class="form-control" required name="password" value="" maxlength="256" placeholder="" type="password" autocomplete="off">
                <div class="invalid-feedback">{{ 'field-is-required'|text }}</div>
            </div>
            <div class="mb-3">
                <label class="form-label">{{ 'firstname'|text }}</label>
                <input class="form-control" required name="first_name" value="" maxlength="128" autocomplete="off">
                <div class="invalid-feedback">{{ 'field-is-required'|text }}</div>
            </div>
            <div class="mb-3">
                <label class="form-label">{{ 'lastname'|text }}</label>
                <input class="form-control" required name="last_name" value="" maxlength="128" placeholder="" type="text" autocomplete="off">
                <div class="invalid-feedback">{{ 'field-is-required'|text }}</div>
            </div>
            <div class="mb-3">
                <label class="form-label">{{ 'telephone'|text }}</label>
                <input class="form-control" required name="phone" value="" maxlength="128" placeholder="" type="text" autocomplete="off">
                <div class="invalid-feedback">{{ 'field-is-required'|text }}</div>
            </div>
            <div class="mb-3">
                <label class="form-label">{{ 'email'|text }}</label>
                <div class="input-group">
                    <div class="input-group-prepend"><span class="input-group-text">@</span></div>
                    <input class="form-control" required name="email" value="" maxlength="128" placeholder="" type="email" autocomplete="off">
                    <div class="invalid-feedback">{{ 'enter-valid-email'|text }}</div>
                </div>
            </div>
        </div>

        <!-- üß∑ 2-—Ä tab: –•—ç—Ä—ç–≥–ª—ç–≥—á–∏–π–Ω –∑—É—Ä–∞–≥ -->
        <div class="tab-pane" id="tab-picture" role="tabpanel">
            <div class="input-group">
                <!-- –ó—É—Ä–∞–≥ —Å–æ–Ω–≥–æ—Ö–æ–¥ —Ö–∞—Ä–∞–≥–¥–∞—Ö —Ñ–∞–π–ª—ã–Ω –Ω—ç—Ä -->
                <input class="form-control" type="text" id="photo_name" disabled value="" placeholder="{{ 'select-an-image'|text|e }}">
                <div class="input-group-append">
                    <div class="btn-group">
                        <!-- –ñ–∏–Ω—Ö—ç–Ω—ç file input (–Ω—É—É—Å–∞–Ω) -->
                        <input type="file" name="photo" accept="image/*" maxlength="256" style="display:none;">
                        <!-- File —Å–æ–Ω–≥–æ—Ö —Ç–æ–≤—á -->
                        <button class="photo-browse btn btn-info" type="button" onclick="this.previousElementSibling.click();">
                            {{ 'choose'|text }}
                        </button>
                    </div>
                </div>
            </div>
            <!-- –ó—É—Ä–∞–≥ —Å–æ–Ω–≥–æ—Å–Ω—ã –¥–∞—Ä–∞–∞—Ö —É—Ä—å–¥—á–∏–ª—Å–∞–Ω —Ö–∞—Ä–∞–≥–¥–∞—Ü -->
            <img class="img-thumbnail img-fluid" id="photo_preview" src="" style="display:none;">
        </div>

        <!-- üß∑ 3-—Ä tab: –ë–∞–π–≥—É—É–ª–ª–∞–≥–∞ —Å–æ–Ω–≥–æ—Ö —Ö—ç—Å—ç–≥ -->
        <div class="tab-pane" id="tab-organization" role="tabpanel">
            <label class="form-label">{{ 'organization'|text }}</label>
            <select class="form-control" name="organization">
                {% for org in organizations %}
                    <option value="{{ org['id'] }}"{{ loop.first ? ' selected' : '' }}>
                        {{ org['name']|e }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </div>
</form>

<!-- ‚úÖ –î–æ–æ–¥ —Ö—ç—Å–≥–∏–π–Ω Submit / –ë—É—Ü–∞—Ö —Ç–æ–≤—á–Ω—É—É–¥ (–¥—ç—ç—Ä—Ö—Ç—ç–π –∏–∂–∏–ª —Ñ—É–Ω–∫—Ü—Ç—ç–π) -->
<div class="rounded p-2 mt-3 shadow">
    {% if user.can('system_user_insert') %}
        <button class="submit-insert btn btn-success text-uppercase shadow-sm">
            <i class="bi bi-check"></i> {{ 'submit'|text }}
        </button>
    {% endif %}
    <a class="btn btn-secondary text-uppercase shadow-sm" href="{{ 'users'|link }}">
        <i class="bi bi-arrow-left"></i> {{ 'users'|text }}
    </a>
</div>

<script type="text/javascript">
    /* –ó—É—Ä–∞–≥ —Å–æ–Ω–≥–æ–ª—Ç—Ç–æ–π —Ö–æ–ª–±–æ–æ—Ç–æ–π —ç–ª–µ–º–µ–Ω—Ç“Ø“Ø–¥–∏–π–≥ –±—ç–ª—ç–Ω –±–æ–ª–≥–æ—Ö */
    const photoName = document.getElementById('photo_name');
    const photoBrowse = document.querySelector('button.photo-browse');
    const photoPreview = document.getElementById('photo_preview');
    const photo = document.querySelector('input[name="photo"]');

    /* ------------------------------------------------------
     *  File input –¥—ç—ç—Ä –∑—É—Ä–∞–≥ —Å–æ–Ω–≥–æ–≥–¥–æ—Ö–æ–¥:
     *   - –§–∞–π–ª—ã–Ω –Ω—ç—Ä–∏–π–≥ —Ç–µ–∫—Å—Ç —Ç–∞–ª–±–∞—Ä—Ç —Ö–∞—Ä—É—É–ª–∞—Ö
     *   - "–°–æ–Ω–≥–æ—Ö" —Ç–æ–≤—á–∏–π–≥ "”®”©—Ä—á–ª”©—Ö" –±–æ–ª–≥–æ–Ω —Å–æ–ª–∏—Ö
     *   - –•—ç—Ä—ç–≤ “Ø“Ø—Å—ç—ç–≥“Ø–π –±–æ–ª "–£—Å—Ç–≥–∞—Ö" —Ç–æ–≤—á “Ø“Ø—Å–≥—ç—Ö
     *   - –£—Ä—å–¥—á–∏–ª—Å–∞–Ω —Ö–∞—Ä–∞–≥–¥–∞—Ü –∑—É—Ä–∞–≥ “Ø–∑“Ø“Ø–ª—ç—Ö
     * ------------------------------------------------------ */
    photo.addEventListener('change', function (e) {
        e.preventDefault();

        /* FormData-–¥ –∏–ª–≥—ç—ç–≥–¥—ç—Ö name attribute-–∏–π–≥ –±–∞—Ç–∞–ª–≥–∞–∞–∂—É—É–ª–∞—Ö */
        photo.name = 'photo';

        /* –°–æ–Ω–≥–æ—Å–æ–Ω —Ñ–∞–π–ª—ã–Ω –Ω—ç—Ä–∏–π–≥ —Ö–∞—Ä—É—É–ª–∞—Ö */
        if (photo.files && photo.files[0]) {
            photoName.value = photo.files[0].name;
        } else {
            photoName.value = '';
        }

        /* "–°–æ–Ω–≥–æ—Ö" ‚Üí "”®”©—Ä—á–ª”©—Ö" */
        photoBrowse.innerHTML = `{{ 'change'|text|e }}`;

        /* –•—ç—Ä—ç–≤ –¥–∞—Ä–∞–∞–≥–∏–π–Ω sibling –Ω—å BUTTON –±–∏—à –±–æ–ª "–£—Å—Ç–≥–∞—Ö" —Ç–æ–≤—á —à–∏–Ω—ç—ç—Ä “Ø“Ø—Å–≥—ç–Ω—ç */
        if (photoBrowse.nextElementSibling?.tagName !== 'BUTTON') {
            const photoClear = document.createElement('button');
            photoClear.classList.add('btn', 'btn-danger');
            photoClear.type = 'button';
            photoClear.innerHTML = `{{ 'remove'|text }}`;

            /* "–£—Å—Ç–≥–∞—Ö" —Ç–æ–≤—á –¥–∞—Ä–∞–≥–¥–∞—Ö “Ø–µ–¥ –∑—É—Ä–∞–≥ –±–æ–ª–æ–Ω —Å–æ–Ω–≥–æ–ª—Ç—ã–≥ reset —Ö–∏–π—Ö */
            photoClear.addEventListener('click', function (e) {
                e.preventDefault();

                /* –£—Ä—å–¥—á–∏–ª—Å–∞–Ω —Ö–∞—Ä–∞–≥–¥–∞—Ü —É—Å—Ç–≥–∞—Ö */
                photoPreview.removeAttribute('src');
                photoPreview.style.display = 'none';

                /* –§–∞–π–ª—ã–Ω –Ω—ç—Ä —Ç–∞–ª–±–∞—Ä—ã–≥ —Ü—ç–≤—ç—Ä–ª—ç—Ö */
                photoName.value = '';

                /* "”®”©—Ä—á–ª”©—Ö" —Ç–æ–≤—á–∏–π–≥ –¥–∞—Ö–∏–Ω "–°–æ–Ω–≥–æ—Ö" –±–æ–ª–≥–æ—Ö */
                photoBrowse.innerHTML = `{{ 'choose'|text|e }}`;

                /* File input-–∏–π–Ω —É—Ç–≥—ã–≥ reset —Ö–∏–π—Ö, name-–≥ –∞—Ä–∏–ª–≥–∞—Ö */
                photo.value = '';
                photo.removeAttribute('name');

                /* "–£—Å—Ç–≥–∞—Ö" —Ç–æ–≤—á–∏–π–≥ DOM-–æ–æ—Å —É—Å—Ç–≥–∞—Ö */
                photoClear.remove();
            });

            /* –®–∏–Ω—ç—ç—Ä “Ø“Ø—Å–≥—ç—Å—ç–Ω —Ç–æ–≤—á–∏–π–≥ "–°–æ–Ω–≥–æ—Ö" —Ç–æ–≤—á–Ω—ã —Ö–∞–∂—É—É–¥ –±–∞–π—Ä–ª—É—É–ª–∞—Ö */
            if (photoBrowse.nextSibling) {
                photoBrowse.parentNode.insertBefore(photoClear, photoBrowse.nextSibling);
            } else {
                photoBrowse.parentNode.appendChild(photoClear);
            }
        }

        /* –°–æ–Ω–≥–æ—Å–æ–Ω –∑—É—Ä–≥–∏–π–≥ —É—Ä—å–¥—á–∏–ª—Å–∞–Ω —Ö–∞—Ä–∞–≥–¥–∞—Ü (preview) “Ø–∑“Ø“Ø–ª—ç—Ö */
        if (photo.files && photo.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                photoPreview.src = e.target.result;
                if (photoPreview.style.display === 'none') {
                    photoPreview.style.display = 'block';
                }
            };
            reader.readAsDataURL(photo.files[0]);
        }
    });

    /* DOM –±—ç–ª—ç–Ω –±–æ–ª–º–æ–≥—Ü form submit –ª–æ–≥–∏–∫ –±—ç–ª–¥—ç—Ö */
    document.addEventListener('DOMContentLoaded', function () {
        /* –•—ç—Ä—ç–≥–ª—ç–≥—á —à–∏–Ω—ç—ç—Ä “Ø“Ø—Å–≥—ç—Ö FORM —ç–ª–µ–º–µ–Ω—Ç */
        const formInsert = document.querySelector('form#user_insert');

        /* –•—ç—Ä—ç–≤ form –æ–ª–¥–æ—Ö–≥“Ø–π –±–æ–ª –∞–ª–¥–∞–∞ –º—ç–¥—ç–≥–¥—ç–ª —Ö–∞—Ä—É—É–ª–∞–∞–¥ –∑–æ–≥—Å–æ–æ–Ω–æ */
        if (!formInsert) {
            NotifyTop('danger', `{{ 'error'|text|e }}`, 'Form not found!');
            return;
        }

        /* –§–æ—Ä–º-—Å –≥–∞–¥—É—É—Ä –±–∞–π—Ä—à–∏—Ö "submit-insert" —Ç–æ–≤—á–Ω—É—É–¥—ã–≥ form.requestSubmit()-—Ç—ç–π —Ö–æ–ª–±–æ—Ö */
        const submitters = document.querySelectorAll('button.submit-insert');
        submitters.forEach(function (btn) {
            btn.addEventListener('click', function (e) {
                e.preventDefault();
                formInsert.requestSubmit();
            });
        });

        /* --------------------------------------------------
         *  FORM submit event:
         *   - HTML5 validation —à–∞–ª–≥–∞—Ö
         *   - –ê–ª–¥–∞–∞ –±–∞–π–≤–∞–ª NotifyTop-—Ä –º—ç–¥—ç–≥–¥—ç—Ö
         *   - –ó”©–≤ –±–æ–ª fetch –∞—à–∏–≥–ª–∞–Ω backend —Ä“Ø“Ø –∏–ª–≥—ç—ç—Ö
         * -------------------------------------------------- */
        formInsert.addEventListener('submit', function (event) {
            event.preventDefault();

            /* HTML5 built-in validation */
            const isValid = this.checkValidity();
            this.classList.add('was-validated');

            if (!isValid) {
                event.stopPropagation();
                NotifyTop(
                    'danger',
                    `{{ 'error'|text|e }}`,
                    `{{ 'u-have-some-form-errors'|text|e }}`
                );
                return;
            }

            /* Submit —Ç–æ–≤—á–ª—É—É—Ä—É—É–¥ –¥—ç—ç—Ä growNstop() animation –∞–∂–∏–ª–ª—É—É–ª–∞—Ö (loading effect) */
            submitters.forEach(function (btn) {
                btn.growNstop();
            });

            /* FormData –∞—à–∏–≥–ª–∞–Ω –±“Ø—Ö —Ç–∞–ª–±–∞—Ä—É—É–¥—ã–≥ –∞—á–∞–∞–ª–∞—Ö */
            const data = new FormData(this);

            /* ----------------------------------------------
             *  Fetch API –∞—à–∏–≥–ª–∞–Ω backend —Ä“Ø“Ø —Ö“Ø—Å—ç–ª—Ç –∏–ª–≥—ç—ç—Ö
             *  - this.action ‚Üí form action URL
             *  - method –∞—Ç—Ä–∏–±—É—Ç –±–∞–π–≤–∞–ª –∞—à–∏–≥–ª–∞–Ω–∞, “Ø–≥“Ø–π –±–æ–ª POST
             * ---------------------------------------------- */
            fetch(this.action, {
                body: data,
                method: this.getAttribute('method') ?? 'POST'
            })
            .then(function (res) {
                const contentType = res.headers.get('content-type') || '';
                /* –•–∞—Ä–∏—É JSON —Ç”©—Ä”©–ª—Ç—ç–π –±–æ–ª res.json() –±–æ–ª–≥–æ–∂ –±—É—Ü–∞–∞–Ω–∞ */
                if (contentType.includes('application/json')) return res.json();

                /* JSON –±–∏—à –±–æ–ª –∞–ª–¥–∞–∞ —à–∏–¥–Ω—ç */
                throw new Error(`HTTP [${res.status}]: ${res.statusText}`);
            })
            .then(function (response) {
                /* Backend —Ç–∞–ª–∞–∞—Å –∏—Ä—Å—ç–Ω business –∞–ª–¥–∞–∞ —à–∞–ª–≥–∞—Ö */
                if (response.status !== 'success') {
                    throw new Error(response.message || 'Invalid response!');
                }

                /* –ê–º–∂–∏–ª—Ç—Ç–∞–π –±–æ–ª —Ö—ç—Ä—ç–≥–ª—ç–≥—á–¥–∏–π–Ω –∂–∞–≥—Å–∞–∞–ª—Ç —Ä—É—É —á–∏–≥–ª“Ø“Ø–ª—ç—Ö */
                window.location.href = `{{ 'users'|link }}`;

                /* –ê–º–∂–∏–ª—Ç—ã–Ω –º—ç–¥—ç–≥–¥—ç–ª */
                NotifyTop(
                    response.type ?? 'success',
                    response.title ?? `{{ 'success'|text|e }}`,
                    response.message ?? 'User created'
                );
            })
            .catch(function (error) {
                /* –°“Ø–ª–∂—ç—ç–Ω–∏–π —ç—Å–≤—ç–ª backend-—ç—ç—Å –∏—Ä—Å—ç–Ω –∞–ª–¥–∞–∞ */
                NotifyTop('danger', `{{ 'error'|text|e }}`, error.message);

                /* –ê–ª–¥–∞–∞ –≥–∞—Ä—Å–∞–Ω “Ø–µ–¥ loading animation-“Ø“Ø–¥–∏–π–≥ –∑–æ–≥—Å–æ–æ—Ö */
                submitters.forEach(function (btn) {
                    btn.growNstop();
                });
            });
        });
    });
</script>

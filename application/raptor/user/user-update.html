{% set can_update_me = user.can('system_user_update') or (user.profile['id'] == record['id']) %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<div class="d-flex flex-wrap justify-content-between align-items-center text-uppercase rounded p-1 mb-2 shadow">
    <h3 class="px-2 my-auto fs-6 text-primary">
        <i class="bi bi-person-lines-fill"></i> {{ record['first_name'] ~ ' ' ~ record['last_name'] }}
    </h3>
    <div class="ms-auto">
        {% if can_update_me %}
            <button class="submit-update btn btn-sm btn-primary text-uppercase shadow-sm">
                <i class="bi bi-check"></i> {{ 'submit'|text }}
            </button>
        {% endif %}
        {% if user.can('system_user_index') %}
        <a class="btn btn-sm btn-secondary shadow-sm" href="{{ 'users'|link }}">
            <i class="bi bi-arrow-left"></i> {{ 'users'|text }}
        </a>
        {% endif %}
    </div>
</div>
<ul class="nav nav-tabs mt-1" role="tablist">
    <li class="nav-item"><a class="nav-link active show" data-bs-toggle="tab" href="#tab-personal">{{ 'personal-info'|text }} <i class="bi bi-postcard"></i></a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-picture">{{ 'image'|text }} <i class="bi bi-camera"></i></a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-options">{{ 'options'|text }} <i class="bi bi-toggle-on"></i></a></li>
</ul>
<form class="needs-validation pt-3" novalidate id="user_update" action="{{ 'user-update'|link({'id': record['id']}) }}" method="PUT" enctype="multipart/form-data">
    <div class="tab-content">
        <div class="tab-pane active show" id="tab-personal" role="tabpanel">
            <div class="mb-3">
                <label class="form-label">{{ 'login'|text }}</label>
                <input class="form-control" required name="username" value="{{ record['username']|e }}" maxlength="128" placeholder="" type="text" autocomplete="off">
                <div class="invalid-feedback">{{ 'field-is-required'|text }}</div>
            </div>
            <div class="mb-3">
                <label class="form-label">{{ 'firstname'|text }}</label>
                <input class="form-control" required name="first_name" value="{{ record['first_name']|e }}" maxlength="128" autocomplete="off">
                <div class="invalid-feedback">{{ 'field-is-required'|text }}</div>
            </div>
            <div class="mb-3">
                <label class="form-label">{{ 'lastname'|text }}</label>
                <input class="form-control" required name="last_name" value="{{ record['last_name']|e }}" maxlength="128" placeholder="" type="text" autocomplete="off">
                <div class="invalid-feedback">{{ 'field-is-required'|text }}</div>
            </div>
            <div class="mb-3">
                <label class="form-label">{{ 'telephone'|text }}</label>
                <input class="form-control" required name="phone" value="{{ record['phone']|e }}" maxlength="128" placeholder="" type="text" autocomplete="off">
                <div class="invalid-feedback">{{ 'field-is-required'|text }}</div>
            </div>
            <div class="mb-3">
                <label class="form-label">{{ 'email'|text }}</label>
                <div class="input-group">
                    <div class="input-group-prepend"><span class="input-group-text">@</span></div>
                    <input class="form-control" required name="email" value="{{ record['email']|e }}" maxlength="128" placeholder="" type="email" autocomplete="off">
                    <div class="invalid-feedback">{{ 'enter-valid-email'|text }}</div>
                </div>
            </div>
        </div>
        <div class="tab-pane" id="tab-picture" role="tabpanel">
            <div class="input-group">
                <input class="form-control" type="text" id="photo_name" disabled value="{{ record['photo']|e }}" placeholder="{{ 'select-an-image'|text|e }}">
                <div class="input-group-append">
                    <div class="btn-group">
                        <input type="file" name="photo" id="photo" accept="image/*" maxlength="256" style="display:none;" onchange="onFileInput(this);">
                        <button class="photo-browse btn btn-info" type="button" onclick="this.previousElementSibling.click();">{{ 'choose'|text }}</button>
                        <button class="btn btn-danger" type="button" onclick="onFileClear(this);" style="{% if record['photo'] is empty %}display:none;{% endif %}">{{ 'remove'|text }}</button>
                        <input type="hidden" name="photo_removed" value="0" type="number">
                    </div>
                </div>
            </div>
            <img class="img-thumbnail img-fluid" id="photo_preview" src="{{ record['photo']|e }}" style="{% if record['photo'] is empty %}display:none;{% endif %}">
        </div>
        <div class="tab-pane" id="tab-options" role="tabpanel">
            {% if user.can('system_user_organization_set') %}
                <label class="form-label">{{ 'organization'|text }}</label>
                <div class="form-text" id="organzationHelpBlock">хэрэглэгчийн харъяалагдах байгууллагыг сонгон тохируулна уу</div>
                <select class="form-control" multiple name="organizations[]" id="organizations" aria-describedby="organzationHelpBlock">
                    {% for organization in organizations %}
                        <option value="{{ organization['id'] }}"{% if organization['id'] in current_organizations %} selected{% endif %}>{{ organization['name'] }}</option>
                    {% endfor %}
                </select>
            {% endif %}
            {% if user.can('system_rbac') %}
                <label class="mt-1">{{ 'role'|text }}</label>
                <div class="form-text" id="roleHelpBlock">хэрэглэгчийн дүрийг сонгон тохируулна уу</div>
                <select class="form-control" multiple name="roles[]" id="roles" aria-describedby="roleHelpBlock">
                    {% for key,data in roles %}
                        <optgroup label="{{ rbacs[key]|e }}" alias="{{ key|e }}">
                            {% for value,name in data %}
                                <option value="{{ value|e }}"{% if value in current_roles %} selected{% endif %}>[{{ name[0]|e }}] {{ name[1]|e }}</option>
                            {% endfor %}
                        </optgroup>
                    {% endfor %}
                </select>
            {% endif %}
        </div>
    </div>
</form>
<div class="rounded p-2 mt-3 shadow">
    {% if can_update_me %}
        <button class="submit-update btn btn-primary text-uppercase shadow-sm">
            <i class="bi bi-check"></i> {{ 'submit'|text }}
        </button>
    {% endif %}
    {% if user.can('system_user_index') %}
    <a class="btn btn-secondary text-uppercase shadow-sm" href="{{ 'users'|link }}">
        <i class="bi bi-arrow-left"></i> {{ 'users'|text }}
    </a>
    {% endif %}
</div>
<script type="text/javascript">
    const onFileInput = function (fileInput) {
        let id = fileInput.id;
        if (!id) {
            return NotifyTop('warning', `{{ 'error'|text|e }}`, 'Please set file input id!');
        }
        
        let nameInput = document.getElementById(id + '_name');
        if (nameInput) {
            nameInput.value = fileInput.files[0].name;
        }

        let browseBtn = fileInput.nextElementSibling;
        if (browseBtn) {
            browseBtn.textContent = `{{ 'change'|text|e }}`;
        }

        let removeBtn = browseBtn.nextElementSibling;
        if (removeBtn && removeBtn.style.display === 'none') {
            removeBtn.style.display = 'block';
        }
        let fileDeletedInput = removeBtn.nextElementSibling;
        if (fileDeletedInput) fileDeletedInput.value = 0;

        let reader = new FileReader();
        reader.onload = function (e) {
            let previewImg = document.getElementById(id + '_preview');
            if (previewImg) {
                previewImg.src = e.target.result;
                if (previewImg.style.display === 'none') {
                    previewImg.style.display = 'block';
                }
            }
        };
        reader.readAsDataURL(fileInput.files[0]);
    };

    const onFileClear = function (removeBtn) {
        let fileInput = removeBtn?.previousElementSibling?.previousElementSibling;
        if (fileInput?.tagName === 'INPUT' && fileInput.type === 'file') {
            let previewImg = document.getElementById(fileInput.id + '_preview');
            if (previewImg) {
                previewImg.removeAttribute('src');
            }
            let nameInput = document.getElementById(fileInput.id + '_name');
            if (nameInput) {
                nameInput.value = '';
            }

            let browseBtn = fileInput.nextElementSibling;
            if (browseBtn) {
                browseBtn.textContent = `{{ 'choose'|text|e }}`;
            }

            removeBtn.style.display = 'none';

            fileInput.value = '';
            
            let fileDeletedInput = removeBtn.nextElementSibling;
            if (fileDeletedInput) fileDeletedInput.value = 1;
        }
    };

    document.addEventListener('DOMContentLoaded', function () {
        const organizations = document.getElementById('organizations');
        if (organizations) {
            new Choices(organizations, {removeItemButton: true});
        }
        const roles = document.getElementById('roles');
        if (roles) {
            new Choices(roles, {removeItemButton: true});
        }

        const formUpdate = document.querySelector('form#user_update');
        if (!formUpdate) {
            NotifyTop('danger', `{{ 'error'|text|e }}`, 'Form not found!');
        } else {
            const submitters = document.querySelectorAll('button.submit-update');
            submitters.forEach(function (button) {
                button.addEventListener('click', function (e) {
                    e.preventDefault();
                    formUpdate.requestSubmit();
                });
            });

            formUpdate.addEventListener('submit', function (event) {
                event.preventDefault();

                const _valid = this.checkValidity();
                this.classList.add('was-validated');
                if (!_valid) {
                    event.stopPropagation();
                    return NotifyTop('danger', `{{ 'error'|text|e }}`, `{{ 'u-have-some-form-errors'|text|e }}`);
                }

                submitters.forEach(function (btn) { btn.growNstop(); });

                const data = new FormData(this);
                fetch(
                    this.action,
                    {
                        body: data,
                        method: this.getAttribute('method') ?? 'PUT'
                    }
                ).then(res => {
                    let contentType = res.headers.get('content-type');
                    if (contentType.indexOf('application/json') !== -1) {
                        return res.json();
                    }
                    throw new Error("HTTP [{0}]: {1}".format(res.status, res.statusText));
                }).then(response => {
                    if (response.status !== 'success') {
                        throw new Error(response.message ? response.message : 'Invalid response!');
                    }

                    {% if user.can('system_user_index') %}
                        window.location.href = `{{ 'users'|link }}`;
                    {% else %}
                        window.location.href = `{{ 'home'|link }}`;
                    {% endif %}

                    NotifyTop(response.type ?? 'success', response.title ?? `{{ 'success'|text|e }}`, response.message ?? 'User updated');
                }).catch(error => {
                    NotifyTop('danger', `{{ 'error'|text|e }}`, error.message);
                    submitters.forEach(function (btn) { btn.growNstop(); });
                });
            });
        }
    });
</script>

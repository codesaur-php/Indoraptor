<!-- üß© –®–∏–Ω—ç—ç—Ä —Ö—ç—Ä—ç–≥–ª—ç–≥—á –±–æ–ª–æ—Ö —Ö“Ø—Å—ç–ª—Ç“Ø“Ø–¥–∏–π–Ω Modal (signup requests) -->
<div class="modal-xl modal-dialog modal-dialog-scrollable" role="document">
    <div class="modal-content">

        <!-- üîµ Modal Header -->
        <div class="modal-header">
            <h3 class="modal-title fs-6 text-uppercase text-primary">
                <!-- –®–∏–Ω—ç —Ö—ç—Ä—ç–≥–ª—ç–≥—á —Ö“Ø—Å—ç–ª—Ç icon -->
                <i class="bi bi-person-plus-fill"></i> {{ 'request-new-user'|text }}
            </h3>
            <!-- –•–∞–∞—Ö —Ç–æ–≤—á -->
            <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="{{ 'close'|text|e }}"></button>
        </div>

        <!-- üü© Modal Body -->
        <div class="modal-body">

            <!-- üìã Signup —Ö“Ø—Å—ç–ª—Ç“Ø“Ø–¥–∏–π–Ω —Ö“Ø—Å–Ω—ç–≥—Ç -->
            <table class="table table-hover table-striped-columns table-bordered" id="signup">
                <thead>
                    <tr>
                        <!-- –¢–æ–ª–≥–æ–π —Ö—ç—Å–≥–∏–π–Ω –±–∞–≥–∞–Ω—É—É–¥ - –±“Ø—Ö i18n —Ç–µ–∫—Å—Ç Twig-—ç—ç—Ä inject —Ö–∏–π–≥–¥—ç–Ω—ç -->
                        <th class="text-primary" scope="col">{{ 'username'|text }}</th>
                        <th class="text-primary" scope="col">{{ 'email'|text }}</th>
                        <th class="text-primary" scope="col">{{ 'language'|text }}</th>
                        <th class="text-primary" scope="col">{{ 'date-created'|text }}</th>
                        <th class="text-primary" scope="col">{{ 'status'|text }}</th>
                        <th class="text-primary" scope="col">{{ 'action'|text }}</th>
                    </tr>
                </thead>
                <tbody>

                    <!-- üîÅ Backend-–∞–∞—Å –∏—Ä—Å—ç–Ω signup —Ö“Ø—Å—ç–ª—Ç“Ø“Ø–¥–∏–π–≥ –¥–∞–≤—Ç–∞–∂ —Ö–∞—Ä—É—É–ª–∂ –±–∞–π–Ω–∞ -->
                    {% for row in rows %}
                        <tr>

                            <!-- Username -->
                            <td scope="row"><strong>{{ row['username'] }}</strong></td>

                            <!-- Email -->
                            <td>{{ row['email'] }}</td>

                            <!-- üåê –•—ç–ª ‚Üí flag –¥“Ø—Ä—Å -->
                            <td>
                                {# EN –±–æ–ª ‚Üí US flag, –±—É—Å–∞–¥ —Ö—ç–ª ‚Üí ”©”©—Ä–∏–π–Ω code #}
                                {% set flag =  row['code'] == 'en' ? 'us' :  row['code'] %}
                                <img src="https://flagcdn.com/20x15/{{ flag }}.png"
                                     srcset="https://flagcdn.com/40x30/{{ flag }}.png 2x"
                                     width="20" height="15">
                            </td>

                            <!-- –û–≥–Ω–æ–æ -->
                            <td>{{ row['created_at'] }}</td>

                            <!-- üìå –•“Ø—Å—ç–ª—Ç–∏–π–Ω —Ç”©–ª”©–≤ -->
                            <td>
                                {% if row['is_active'] == 2 %}
                                    <span class="badge bg-info">approved</span>
                                {% elseif row['is_active'] == 0 %}
                                    <span class="badge bg-danger">deactivated</span>
                                {% else %}
                                    <span class="badge bg-warning">waiting</span>
                                {% endif %}
                            </td>

                            <!-- ‚ú® “Æ–π–ª–¥—ç–ª“Ø“Ø–¥ - –∑”©–≤—Ö”©–Ω waiting —Ç”©–ª”©–≤—Ç —Ö–∞—Ä–∞–≥–¥–∞–Ω–∞ -->
                            <td>
                                {% if row['is_active'] == 1 %}
                                    {% if user.can('system_user_insert') %}
                                        <!-- –ó”©–≤—à”©”©—Ä”©—Ö -->
                                        <button class="approve-user-request btn btn-sm btn-success mb-1 shadow-sm"
                                                value="{{ row['id'] }}" type="button">
                                            <i class="bi bi-person-check"></i> {{ 'accept'|text }}
                                        </button>
                                    {% endif %}
                                    {% if user.can('system_user_delete') %}
                                        <!-- –ò–¥—ç–≤—Ö–≥“Ø–π –±–æ–ª–≥–æ—Ö -->
                                        <button class="deactivate-user-request btn btn-sm btn-danger mb-1 shadow-sm"
                                                value="{{ row['id'] }}" type="button">
                                            <i class="bi bi-trash"></i> {{ 'delete'|text }}
                                        </button>
                                    {% endif %}
                                {% endif %}
                            </td>

                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- üü• Modal Footer -->
        <div class="modal-footer">
            <button class="btn btn-primary shadow-sm" data-bs-dismiss="modal" type="button">
                {{ 'close'|text }}
            </button>
        </div>

    </div>
</div>

<script type="text/javascript">
    /* –•—ç–ª–Ω—ç—ç—Å —Ö–∞–º–∞–∞—Ä—Å–∞–Ω –±–∞—Ç–∞–ª–≥–∞–∞–∂—É—É–ª–∞—Ö –∞—Å—É—É–ª—Ç—ã–≥ —Ñ—É–Ω–∫—Ü –±–æ–ª–≥–æ–≤ */
    let acceptQuestion, questionDeletion;
    if (document.documentElement.lang === 'mn') {
        acceptQuestion = name =>
            `<p class="text-primary">–¢–∞ (${name}) —Ö—ç—Ä—ç–≥–ª—ç–≥—á–∏–π–Ω –±“Ø—Ä—Ç–≥“Ø“Ø–ª—ç—Ö —Ö“Ø—Å—ç–ª—Ç–∏–π–≥ –∑”©–≤—à”©”©—Ä”©—Ö–¥”©”© –∏—Ç–≥—ç–ª—Ç—ç–π –±–∞–π–Ω–∞ —É—É?</p>`;
        questionDeletion = name =>
            `<p class="text-danger">–¢–∞ (${name}) —Ö—ç—Ä—ç–≥–ª—ç–≥—á–∏–π–Ω –±“Ø—Ä—Ç–≥“Ø“Ø–ª—ç—Ö —Ö“Ø—Å—ç–ª—Ç–∏–π–≥ –∏–¥—ç–≤—Ö–≥“Ø–π –±–æ–ª–≥–æ—Ö–¥–æ–æ –∏—Ç–≥—ç–ª—Ç—ç–π –±–∞–π–Ω–∞ —É—É?</p>`;
    } else {
        acceptQuestion = name =>
            `<p class="text-primary">Are you sure to accept this user request (${name})?</p>`;
        questionDeletion = name =>
            `<p class="text-danger">Are you sure to deactivate this user request (${name})?</p>`;
    }

    /* motable - —Ö“Ø—Å–Ω—ç–≥—Ç–∏–π–Ω UI helper */
    const newbies = new motable('table#signup');

    /* ‚úÖ "Accept" button ‚Üí —à–∏–Ω—ç —Ö—ç—Ä—ç–≥–ª—ç–≥—á–∏–π–≥ –±–∞—Ç–ª–∞—Ö */
    const requestWaits = newbies.table.querySelectorAll('.approve-user-request');
    requestWaits.forEach(btn =>
        btn.addEventListener('click', function (e) {

            e.preventDefault();

            /* –ú”©—Ä–∏–π–≥ –æ–ª–∂ –∞–≤–∞—Ö */
            const thisRow = btn.closest('tr');
            if (!thisRow) {
                return NotifyTop('warning', `{{ 'error'|text|e }}`, "Can't find parent row!");
            }

            /* Username => email */
            const name = `${thisRow.children[0].innerText} => ${thisRow.children[1].innerText}`;

            /* ü™™ –ë–∞—Ç–∞–ª–≥–∞–∞–∂—É—É–ª–∞—Ö SweetAlert */
            Swal.fire({
                html:
                   `<i class="bi bi-person-plus text-info mb-2" style="font-size:3rem"></i>
                    ${acceptQuestion(name)}
                `,
                showCancelButton: true,
                cancelButtonText: `{{ 'no'|text|e }}`,
                confirmButtonText: `<i class="bi bi-check"></i> {{ 'yes'|text|e }}`,
                confirmButtonColor: '#0d6efd',
                showLoaderOnConfirm: true,
                allowOutsideClick: () => !Swal.isLoading(),
                backdrop: true,

                /* üîÑ –ó”©–≤—à”©”©—Ä”©—Ö “Ø–µ–¥ API —Ä—É—É POST —Ö–∏–π–Ω—ç */
                preConfirm: () => {
                    return fetch(
                        `{{ 'user-signup-approve'|link }}`,
                        {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({id: btn.value})
                        }
                    )
                    .then(res => res.json())
                    .then(response => {
                        /* –ê–º–∂–∏–ª—Ç—Ç–∞–π —Ö–∞—Ä–∏—É –±–∏—à –±–æ–ª error throw */
                        if (response.status !== 'success') {
                            throw new Error(response.message ?? 'Invalid response!');
                        }

                        Swal.close();
                        NotifyTop('success', `{{ 'success'|text|e }}`, response.message ?? 'User accepted');
                        
                        /* UI Update:
                         * 1) Status ‚Üí approved
                         * 2) Action column ‚Üí clear */
                        thisRow.children[4].innerHTML =
                            '<span class="badge bg-info">approved</span>';
                        thisRow.children[5].innerHTML = '';

                        newbies.setReady();
                        
                        /* —Å–µ–∫ –¥–∞—Ä–∞–∞ modal-—ã–≥ —Ö–∞–∞–≥–∞–∞–¥ document reload */
                        setTimeout(() => {
                            const modalEl = document.querySelector('.modal.show');
                            if (modalEl) {
                                const modal = bootstrap.Modal.getInstance(modalEl);
                                modal.hide();
                            }
                            /* üîÑ Full reload ‚Üí Users table –¥—ç—ç—Ä —à–∏–Ω—ç user-–≥ —Ö–∞—Ä–∞—Ö */
                            setTimeout(() => location.reload(), 400);
                        }, 1000);
                    })
                    .catch(error => Swal.showValidationMessage(error.message));
                }
            });
        })
    );

    /* ‚ùå "Delete" button ‚Üí —Ö“Ø—Å—ç–ª—Ç–∏–π–≥ –∏–¥—ç–≤—Ö–≥“Ø–π –±–æ–ª–≥–æ—Ö */
    const requestDeactivates = newbies.table.querySelectorAll('.deactivate-user-request');
    requestDeactivates.forEach(btn =>
        btn.addEventListener('click', function (e) {

            e.preventDefault();

            const thisRow = btn.closest('tr');
            if (!thisRow) {
                return NotifyTop('warning', `{{ 'error'|text|e }}`, 'Cannot select row!');
            }

            const name = `${thisRow.children[0].innerText} => ${thisRow.children[1].innerText}`;

            /* üóë Deactivate —Ö–∏–π—Ö SweetAlert */
            Swal.fire({
                html:
                   `<i class="bi bi-person-x-fill text-danger mb-2" style="font-size:3rem"></i>
                    ${questionDeletion(name)}
                `,
                showCancelButton: true,
                cancelButtonText: `{{ 'no'|text|e }}`,
                confirmButtonText: `<i class="bi bi-check"></i> {{ 'yes'|text|e }}`,
                confirmButtonColor: '#f32750',
                showLoaderOnConfirm: true,
                allowOutsideClick: () => !Swal.isLoading(),
                backdrop: true,

                /* DELETE API –¥—É—É–¥–Ω–∞ */
                preConfirm: () => {
                    return fetch(
                        `{{ 'user-signup-deactivate'|link }}`,
                        {
                            method: 'DELETE',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({id: btn.value, name})
                        }
                    )
                    .then(res => res.json())
                    .then(response => {
                        if (response.status !== 'success') {
                            throw new Error(response.message ?? 'Invalid response!');
                        }

                        Swal.close();

                        NotifyTop(
                            'success',
                            `{{ 'success'|text|e }}`,
                            response.message ?? `User (${name}) request deactivated`
                        );

                        /* UI –¥—ç—ç—Ä badge ”©”©—Ä—á–ª”©—Ö */
                        thisRow.children[4].innerHTML =
                            '<span class="badge bg-danger">deactivated</span>';
                        thisRow.children[5].innerHTML = '';

                        newbies.setReady();
                    })
                    .catch(error => Swal.showValidationMessage(error.message));
                }
            });
        })
    );
</script>

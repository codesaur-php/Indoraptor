<div class="d-flex flex-wrap justify-content-between align-items-center text-uppercase rounded p-1 mb-2 shadow">
    <h3 class="px-2 my-auto fs-6 text-secondary text-uppercase">
        <i class="bi bi-list"></i> {{ 'logs'|text }}
    </h3>
    <div class="ms-auto">
        <a class="btn btn-sm btn-secondary text-uppercase shadow-sm" href="{{ 'home'|link }}">
            <i class="bi bi-house-door-fill"></i> {{ 'home'|text }}
        </a>
    </div>
</div>

<ul class="nav nav-tabs" role="tablist">
{% for table in log_tables %}
    <li class="nav-item">
        <a class="nav-link{% if table == 'dashboard' %} active{% endif %} text-uppercase" role="tab" data-bs-toggle="tab" href="#log_{{ table }}" data-table="{{ table }}">{{ table }}</a>
    </li>
{% endfor %}
</ul>

<div class="tab-content mt-3">
{% for table in log_tables %}
    <div class="tab-pane{% if table == 'dashboard' %} active{% endif %}" id="log_{{ table }}" style="width:100%;height:80.5vh;min-height:400px;overflow-y:auto;overflow-x:hidden;position:relative;">
        <div class="spinner-grow log-spinner position-absolute" role="status" style="display:none;top:10px;right:10px">
            <span class="visually-hidden">Loading logs...</span>
        </div>

        <ul class="list-group logger-protocol" id="logger-{{ table }}" style="padding-bottom:1rem;"></ul>

        {# Infinite scroll хийхэд IntersectionObserver ажиглах зориулалттай sentinel элемент #}
        <div class="log-sentinel" data-table="{{ table }}" style="height:1px;"></div>

        <div class="text-center mt-2 mb-2 no-more-rows text-muted" style="display:none;">{{ localization.code == 'mn' ? 'Цааш лог байхгүй' : 'No more logs' }}</div>
    </div>
{% endfor %}
</div>

<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function () {
    const logsRetrieveLink = `{{ 'logs-retrieve'|link }}`;
    const logsViewLink = `{{ 'logs-view'|link }}`;
    const limit = 50; // Нэг удаад ачаалах мөрийн тоо

    // Тухайн лог хүснэгт бүрийн төлөв хадгалах объект
    const logState = {}; // { tableName: { offset: 0, loading: false, done: false, initialized: false } }

    // Бүх хүснэгтүүдийн төлөвийг анхны утгаар тохируулах
    document.querySelectorAll('.log-sentinel').forEach(s => {
        const table = s.dataset.table;
        logState[table] = { offset: 0, loading: false, done: false, initialized: false };
    });

    // ----------- Лог мөр нэмэх функц (анимацтай) -----------
    function appendLogs(logger, logs, logModalLink) {
        logs.forEach(log => {
            const log_li = document.createElement('li');
            log_li.classList.add('list-group-item', 'list-group-item-action', 'log-row');

            // Түвшингээр өнгө оноох
            switch (log.level) {
                case 'notice': log_li.classList.add('list-group-item-light'); break;
                case 'info': log_li.classList.add('list-group-item-primary'); break;
                case 'error': log_li.classList.add('list-group-item-danger'); break;
                case 'warning': log_li.classList.add('list-group-item-warning'); break;
                case 'alert': log_li.classList.add('list-group-item-info'); break;
                case 'debug': log_li.classList.add('list-group-item-secondary'); break;
                default: log_li.classList.add('list-group-item-dark'); break;
            }

            // ID болон огноо холбоос
            const a_link = document.createElement('a');
            a_link.textContent = `${log.created_at} [${log.id}]`;
            a_link.href = logModalLink + log.id;
            a_link.setAttribute('data-bs-target', '#static-modal');
            a_link.setAttribute('data-bs-toggle', 'modal');
            a_link.addEventListener('click', function (e) {
                e.preventDefault();
                ajaxModal(a_link);
            });
            log_li.appendChild(a_link);
            log_li.appendChild(document.createTextNode(' '));

            // Мессеж
            const span_msg = document.createElement('span');
            span_msg.innerHTML = log.message;
            log_li.appendChild(span_msg);
            log_li.appendChild(document.createTextNode(' '));

            // Үйлдэл болон хэрэглэгчийн мэдээлэл
            const span_user_action = document.createElement('span');
            span_user_action.innerHTML = `<span class="text-muted small"><u>${log.context?.action ?? ''} by ${log.context?.auth_user?.username ?? ''}</u></span>`;
            span_user_action.classList.add('text-muted', 'small');
            log_li.appendChild(span_user_action);

            // Анимэйшний эхний төлөв (харагдахгүй, доош бага зэрэг хөдлөсөн)
            log_li.style.opacity = '0';
            log_li.style.transform = 'translateY(10px)';
            log_li.style.transition = 'opacity 0.36s ease, transform 0.36s ease';

            logger.appendChild(log_li);

            // Дараагийн frame-д fade + slide effect идэвхжүүлнэ
            requestAnimationFrame(() => {
                setTimeout(() => {
                    log_li.style.opacity = '1';
                    log_li.style.transform = 'translateY(0)';
                }, 10);
            });
        });
    }

    // ----------- Тухайн хүснэгтийн логийг татах функц -----------
    async function fetchLogsForTable(table) {
        const state = logState[table];
        if (!state || state.loading || state.done) return;

        const logger = document.getElementById('logger-' + table);
        const container = document.getElementById('log_' + table);
        const spinner = container.querySelector('.log-spinner');
        const sentinel = container.querySelector('.log-sentinel');
        const noMore = container.querySelector('.no-more-rows');

        state.loading = true;
        spinner.style.display = 'block';

        try {
            const res = await fetch(`${logsRetrieveLink}?table=${encodeURIComponent(table)}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    'ORDER BY': 'id Desc',
                    'LIMIT': limit,
                    'OFFSET': state.offset
                })
            });

            const data = await res.json();
            if (data.error) throw new Error(data.error || `{{ 'something-went-wrong'|text|e }}`);

            // JSON хариуг массив болгон хөрвүүлэх
            const items = Array.isArray(data) ? data : Object.values(data);

            // Хэрэв илүү лог байхгүй бол төгсгөсөн төлөвт оруулна
            if (items.length === 0) {
                state.done = true;
                noMore.style.display = 'block';
                sentinel.style.display = 'none'; // дахин ажиглуулахгүй
            } else {
                const logModalLink = `${logsViewLink}?table=${encodeURIComponent(table)}&id=`;
                appendLogs(logger, items, logModalLink);

                // OFFSET утгыг ахиулах
                state.offset += items.length;

                // Хэрэв буцаасан мөрийн тоо LIMIT-ээс бага байвал — цааш лог байхгүй гэж үзнэ
                if (items.length < limit) {
                    state.done = true;
                    noMore.style.display = 'block';
                    sentinel.style.display = 'none';
                } else {
                    noMore.style.display = 'none';
                    sentinel.style.display = '';
                }
            }
        } catch (err) {
            console.error('fetchLogsForTable алдаа:', err);
        } finally {
            state.loading = false;
            spinner.style.display = 'none';
            state.initialized = true;
        }
    }

    // ----------- IntersectionObserver — infinite scroll хянах ----------
    const observerOptions = {
        root: null,
        rootMargin: '400px', // Доош 400px ойртоход урьдчилж ачаална
        threshold: 0
    };
    const sentinelObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (!entry.isIntersecting) return;
            const table = entry.target.dataset.table;
            if (!table) return;

            // Зөвхөн идэвхтэй (харж буй) таб дээр ажиллуулах
            const container = document.getElementById('log_' + table);
            if (!container.classList.contains('active')) return;

            fetchLogsForTable(table);
        });
    }, observerOptions);

    // Бүх sentinel элементүүдийг ажиглах
    document.querySelectorAll('.log-sentinel').forEach(s => sentinelObserver.observe(s));

    // Таб солих үед тухайн хүснэгтийн эхний batch ачаалах
    document.querySelectorAll('a[data-bs-toggle="tab"]').forEach(tabLink => {
        tabLink.addEventListener('shown.bs.tab', function (e) {
            const table = e.target.getAttribute('data-table') || (e.target.getAttribute('href') || '').replace('#log_', '');
            if (!table) return;
            if (!logState[table].initialized && !logState[table].done) {
                fetchLogsForTable(table);
            }
        });
    });

    // Хуудсыг ачаалсны дараа анхны идэвхтэй табын логийг ачаалах
    document.querySelectorAll('.tab-pane.active').forEach(pane => {
        const table = pane.id.replace('log_', '');
        if (logState[table] && !logState[table].initialized && !logState[table].done) {
            fetchLogsForTable(table);
        }
    });

    // Сонгогдсон таб дээр “L” товч дарахад доош гүйлгэх богино зам
    document.addEventListener('keydown', (e) => {
        if (e.key.toLowerCase() === 'l') {
            const activePane = document.querySelector('.tab-pane.active');
            if (activePane) activePane.scrollTop = activePane.scrollHeight;
        }
    });
});
</script>
